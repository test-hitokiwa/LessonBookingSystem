<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>hitokiwaレッスン予約システム</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-image: url('https://page.gensparksite.com/v1/base64_upload/2672eed5518e5cc5a2f73db40fb0df07');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: -1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            margin-top: 20px;
            margin-bottom: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .refresh-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.9);
            color: #2c3e50;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 13px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .refresh-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.9) 0%, rgba(118, 75, 162, 0.9) 100%);
            color: white;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }


        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.95;
        }

        .user-selector {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 15px;
        }

        .user-type-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(135deg, rgba(240, 147, 251, 0.9) 0%, rgba(245, 87, 108, 0.9) 100%);
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .user-type-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .user-type-btn.active {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.9) 0%, rgba(118, 75, 162, 0.9) 100%);
        }

        /* 画面更新ボタン */
        .refresh-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        /* タブナビゲーション（講師・担当者用） */
        .tab-navigation {
            display: none;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.8) 0%, rgba(118, 75, 162, 0.8) 100%);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .tab-navigation.show {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .tab-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 25px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            min-width: 120px;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .tab-btn.active {
            background: rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .tab-btn i {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .tab-btn span {
            font-size: 14px;
            font-weight: 500;
        }

        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .section h2 {
            color: white;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid rgba(255, 255, 255, 0.5);
            padding-bottom: 10px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .section h3 {
            color: white;
            margin-bottom: 15px;
            font-size: 1.4em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: white;
            font-size: 14px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: rgba(102, 126, 234, 0.8);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .uppercase-input {
            text-transform: uppercase !important;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .time-slot {
            position: relative;
            display: flex;
            align-items: center;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            color: white;
        }

        .time-slot:hover {
            border-color: rgba(102, 126, 234, 0.8);
            background: rgba(248, 249, 255, 0.3);
        }

        .time-slot.selected {
            border-color: rgba(102, 126, 234, 0.8);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.8) 0%, rgba(118, 75, 162, 0.8) 100%);
            color: white;
        }

        .time-slot input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.9) 0%, rgba(118, 75, 162, 0.9) 100%);
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, rgba(240, 147, 251, 0.9) 0%, rgba(245, 87, 108, 0.9) 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.9) 0%, rgba(238, 90, 36, 0.9) 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, rgba(0, 210, 211, 0.9) 0%, rgba(84, 160, 255, 0.9) 100%);
            color: white;
            font-weight: bold;
            min-width: 120px;
            text-align: center;
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, rgba(0, 190, 191, 0.9) 0%, rgba(64, 140, 235, 0.9) 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 210, 211, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, rgba(108, 117, 125, 0.9) 0%, rgba(139, 148, 153, 0.9) 100%);
            color: white;
            font-weight: bold;
            min-width: 120px;
            text-align: center;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, rgba(88, 97, 105, 0.9) 0%, rgba(119, 128, 133, 0.9) 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, rgba(255, 165, 0, 0.9) 0%, rgba(255, 140, 0, 0.9) 100%);
            color: white;
            font-weight: bold;
            min-width: 120px;
            text-align: center;
            margin-top: 8px;
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, rgba(255, 145, 0, 0.9) 0%, rgba(255, 120, 0, 0.9) 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 165, 0, 0.4);
        }
        
        .evaluation-status {
            color: #059669;
            font-weight: bold;
            background: rgba(212, 237, 218, 0.8);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9em;
        }
        
        .rating-details {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .rating-details span {
            display: block;
            margin-bottom: 5px;
        }
        
        .poor-attitude-card {
            border-left: 4px solid #dc2626;
            background: rgba(248, 113, 113, 0.1);
        }
        
        .poor-attitude {
            color: #dc2626;
            font-weight: bold;
            background: rgba(248, 113, 113, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .poor-rating {
            color: #ff4444;
            font-weight: bold;
            background: rgba(255, 68, 68, 0.15);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .problem-types {
            color: #dc2626;
            font-weight: bold;
            margin-bottom: 8px;
            padding: 4px 8px;
            background: rgba(248, 113, 113, 0.15);
            border-radius: 4px;
            border: 1px solid rgba(248, 113, 113, 0.3);
        }
        
        .attitude-score {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .attitude-excellent { background-color: #22c55e; }
        .attitude-good { background-color: #3b82f6; }
        .attitude-average { background-color: #f59e0b; }
        .attitude-poor { background-color: #f97316; }
        .attitude-bad { background-color: #ef4444; }
        .attitude-absent { 
            background-color: #6b7280; 
            color: white;
            text-decoration: line-through;
        }

        /* カレンダー関連スタイル */
        .calendar-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 20px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 5px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }

        .calendar-day:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .calendar-day.selected {
            background: rgba(0, 210, 211, 0.7);
            color: white;
            transform: scale(1.1);
        }

        .calendar-day.has-lessons {
            background: rgba(255, 165, 0, 0.6);
            color: white;
        }

        .calendar-day.has-lessons:hover {
            background: rgba(255, 140, 0, 0.8);
        }

        .calendar-day-number {
            font-weight: bold;
            margin-bottom: 2px;
        }

        .calendar-lesson-count {
            font-size: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 1px 4px;
        }

        .lesson-item {
            width: 100%;
            margin: 2px 0;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 11px;
        }

        .lesson-item:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .calendar-date {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .selected-date-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .lesson-attendance-btn {
            margin-left: 10px;
            padding: 5px 10px;
            font-size: 12px;
        }
        
        /* 低評価受講生セクション専用スタイル */
        .poor-attitude-section {
            margin-top: 40px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(248, 215, 218, 0.2) 100%);
            border-left: 4px solid rgba(220, 38, 38, 0.6);
        }
        
        .poor-attitude-section h3 {
            padding-left: 0px;
        }
        


        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.3);
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #667eea;
        }

        .lesson-card {
            background: rgba(255, 255, 255, 0.25);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            border-left: 5px solid rgba(102, 126, 234, 0.8);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .lesson-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .lesson-card h4 {
            color: white;
            margin-bottom: 10px;
            font-size: 1.2em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .lesson-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .lesson-info span {
            padding: 5px 10px;
            background: rgba(248, 249, 255, 0.3);
            border-radius: 5px;
            font-size: 14px;
            color: white;
            backdrop-filter: blur(5px);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        /* 欠席回数ハイライト */
        .lesson-info span.high-absence {
            background: rgba(255, 0, 0, 0.7);
            color: white;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        .lesson-info span.medium-risk {
            background: rgba(255, 165, 0, 0.7);
            color: white;
            font-weight: bold;
        }

        /* 低評価ハイライト（2.0以下） */
        .lesson-info span.low-rating {
            background: rgba(255, 99, 132, 0.8);
            color: white;
            font-weight: bold;
            border: 2px solid rgba(255, 0, 0, 0.6);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .student-list {
            background: rgba(248, 249, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            backdrop-filter: blur(5px);
        }

        .student-list h5 {
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            backdrop-filter: blur(5px);
        }

        .student-item span {
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .rating-stars {
            color: #ffd700;
            font-size: 18px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            display: inline-block;
            margin: 5px 0;
        }
        
        .rating-stars.low-rating {
            color: #ff4444;
            background: rgba(255, 68, 68, 0.1);
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid rgba(255, 68, 68, 0.3);
        }
        
        .rating-stars.no-rating {
            color: #999;
            font-style: italic;
            font-size: 16px;
        }
        
        /* レッスン詳細モーダル用CSS */
        .lesson-detail-info {
            color: white;
        }
        
        .lesson-detail-info h4 {
            color: #4CAF50;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(5px);
        }
        
        .info-grid div {
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            backdrop-filter: blur(3px);
        }
        
        .booking-details {
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(5px);
        }
        
        .booking-details h5 {
            color: #4CAF50;
            margin-bottom: 15px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .student-list-detail {
            display: grid;
            gap: 10px;
        }
        
        .student-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            backdrop-filter: blur(3px);
        }
        
        .student-detail-item .rating {
            color: #ffd700;
            font-weight: bold;
        }
        
        .student-detail-item .no-rating {
            color: #999;
            font-style: italic;
        }
        
        .ratings-summary {
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(5px);
        }
        
        .ratings-summary h5 {
            color: #4CAF50;
            margin-bottom: 15px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .ratings-detail {
            display: grid;
            gap: 12px;
        }
        
        .rating-item {
            padding: 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            backdrop-filter: blur(3px);
        }
        
        .rating-item .comment {
            margin-top: 8px;
            font-style: italic;
            color: #ddd;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 4px;
            border-left: 3px solid #4CAF50;
        }

        .calendar-view {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .calendar-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }
        
        .calendar-header h3 {
            position: absolute;
            left: 0;
            margin: 0;
        }
        
        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .calendar-header h3 {
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .calendar-header span {
            color: white;
            font-size: 1.2em;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-top: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .calendar-day {
            min-height: 120px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 5px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .calendar-day:hover {
            background: rgba(248, 249, 255, 0.3);
        }

        .calendar-day.has-lesson {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.6) 0%, rgba(118, 75, 162, 0.6) 100%);
            color: white;
            font-weight: bold;
        }
        
        .calendar-date {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 3px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .lesson-item {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            margin: 1px 0;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 10px;
            line-height: 1.1;
            flex-shrink: 0;
        }
        
        .lesson-time {
            font-weight: bold;
            color: #2563eb;
        }
        
        .lesson-attendance {
            color: #059669;
            font-size: 9px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0 30px 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: white;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        


        .stat-card div:last-child {
            color: white;
            font-weight: 500;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .batch-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(248, 249, 255, 0.2);
            border-radius: 10px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .batch-controls label {
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .hide {
            display: none !important;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 500;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            animation: slideInFromBottom 0.5s ease-out;
        }
        
        @keyframes slideInFromBottom {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-success {
            background: rgba(212, 237, 218, 0.9);
            color: #155724;
        }

        .alert-error {
            background: rgba(248, 215, 218, 0.9);
            color: #721c24;
        }

        /* Googleカレンダーカード - 修正版 */
        .google-calendar-card {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            max-width: 400px; /* 最大幅を制限 */
        }

        .google-calendar-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .google-calendar-card input[type="checkbox"] {
            margin-right: 10px;
            width: 18px; /* 固定サイズ */
            height: 18px; /* 固定サイズ */
            transform: none; /* スケール変更を削除 */
            flex-shrink: 0; /* 縮小を防ぐ */
        }

        .google-calendar-card label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 500;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            font-size: 14px;
            line-height: 1.4;
        }

        /* 評価表示用のスタイル */
        .rating-card {
            background: rgba(255, 255, 255, 0.25);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            border-left: 5px solid rgba(255, 215, 0, 0.8);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .rating-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .rating-card h4 {
            color: white;
            margin-bottom: 10px;
            font-size: 1.2em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .rating-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .rating-details span {
            padding: 5px 10px;
            background: rgba(248, 249, 255, 0.3);
            border-radius: 5px;
            font-size: 14px;
            color: white;
            backdrop-filter: blur(5px);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .rating-comment {
            background: rgba(248, 249, 255, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            backdrop-filter: blur(5px);
        }

        .rating-comment p {
            color: white;
            font-style: italic;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        /* 星評価システム */
        .star-rating {
            display: flex;
            gap: 5px;
            margin: 10px 0;
        }

        .star {
            font-size: 24px;
            color: #ddd;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .star.active,
        .star:hover {
            color: #ffd700;
        }

        .star.active {
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        /* 不参加ボタンがアクティブな時の特別スタイル */
        .star[data-rating="0"].active {
            background-color: #ff4444 !important;
            color: white !important;
            text-shadow: none !important;
            transform: scale(1.1);
        }

        /* 評価フォーム */
        .rating-form {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .rating-form h5 {
            color: white;
            margin-bottom: 15px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .rating-form textarea {
            width: 100%;
            min-height: 80px;
            resize: vertical;
        }

        /* タブページコンテンツ */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* レスポンシブデザイン */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .user-selector {
                flex-direction: column;
                align-items: center;
            }
            
            .tab-navigation {
                flex-direction: column;
                gap: 10px;
            }
            
            .tab-btn {
                width: 100%;
                flex-direction: row;
                justify-content: center;
                gap: 10px;
                /* スマホ用タップ領域拡大 */
                min-height: 50px;
                font-size: 16px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .time-slots {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }

            .google-calendar-card {
                max-width: 100%;
            }
            
            /* 受講生ページ専用のスマホ最適化 */
            .lesson-card {
                margin-bottom: 15px;
                padding: 15px;
            }
            
            .lesson-card h4 {
                font-size: 1.2em;
                margin-bottom: 12px;
            }
            
            .lesson-info {
                flex-direction: column;
                gap: 8px;
                font-size: 14px;
            }
            
            .lesson-info span {
                padding: 8px 12px;
            }
            
            /* ボタンをスマホ操作しやすく */
            .btn {
                min-height: 44px;
                font-size: 16px;
                padding: 12px 20px;
                width: 100%;
                margin: 8px 0;
            }
            
            .btn-sm {
                min-height: 38px;
                font-size: 14px;
                padding: 8px 16px;
            }
            
            /* モーダルをスマホ画面全体に */
            .modal-content {
                width: 95%;
                max-width: 95%;
                margin: 10px auto;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .modal-body {
                padding: 15px;
            }
            
            /* フォームをスマホで使いやすく */
            input, select, textarea {
                font-size: 16px; /* iOSのズーム防止 */
                padding: 12px;
            }
            
            /* 統計カードをスマホで見やすく */
            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            
            .stat-card {
                padding: 15px 10px;
            }
            
            .stat-number {
                font-size: 1.8em;
            }
            
            /* カレンダーをスマホ最適化 */
            .calendar-grid {
                font-size: 12px;
            }
            
            .calendar-day {
                min-height: 60px;
                padding: 4px;
            }
            
            /* 受講生リストをスマホで見やすく */
            .student-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .student-item .btn {
                width: 100%;
            }
            
            /* 評価星をスマホで大きく */
            .rating-stars {
                font-size: 20px;
            }
            
            /* タブコンテンツのパディング調整 */
            .tab-content {
                padding: 15px 10px;
            }
        }
        
        /* さらに小さい画面（375px以下）用 */
        @media (max-width: 375px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .lesson-info {
                font-size: 13px;
            }
            
            .btn {
                font-size: 15px;
                padding: 10px 16px;
            }
        }
        
        /* スマホでの視認性向上 */
        @media (max-width: 768px) {
            /* 背景オーバーレイを強化 */
            body::before {
                background: rgba(0, 0, 0, 0.5);
            }
            
            /* コンテナの背景を強化 */
            .container {
                background: rgba(255, 255, 255, 0.25);
                backdrop-filter: blur(20px);
            }
            
            /* セクションの背景を強化 */
            .section {
                background: rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(10px);
            }
            
            /* レッスンカードの背景を強化 */
            .lesson-card {
                background: rgba(255, 255, 255, 0.3);
                backdrop-filter: blur(10px);
            }
            
            /* テキストのコントラストを強化 */
            .lesson-card h4,
            .section h2,
            .section h3,
            label {
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
                color: white;
            }
            
            /* ボタンのコントラストを強化 */
            .btn {
                text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            }
            
            /* 統計カードの背景を強化 */
            .stat-card {
                background: rgba(255, 255, 255, 0.25);
                backdrop-filter: blur(8px);
            }
            
            /* タブナビゲーションの視認性向上 */
            .tab-navigation {
                background: linear-gradient(135deg, rgba(102, 126, 234, 0.9) 0%, rgba(118, 75, 162, 0.9) 100%);
                backdrop-filter: blur(15px);
            }
            
            .tab-btn {
                background: rgba(255, 255, 255, 0.3);
                text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
            }
            
            .tab-btn.active {
                background: rgba(255, 255, 255, 0.5);
                text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
            }
        }

        .refresh-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            color: #2c3e50;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 13px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .refresh-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>hitokiwaレッスン予約システム</h1>
            <p>Professional Lesson Booking System</p>
            <div id="sync-status" style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;"></div>
        </div>

        <div class="user-selector">
            <button class="user-type-btn active" onclick="switchUserType('instructor')">講師 (Instructor)</button>
            <button class="user-type-btn" onclick="switchUserType('student')">受講生 (Student)</button>
            <button class="user-type-btn" onclick="switchUserType('coordinator')">受講生担当 (Coordinator)</button>
            <button class="user-type-btn" onclick="switchUserType('admin')">管理者 (Administrator)</button>
        </div>

        <!-- 講師・担当者用タブナビゲーション -->
        <div class="tab-navigation" id="instructor-tabs">
            <button class="tab-btn active" onclick="switchTab('lesson-creation')">
                <i></i>
                <span>レッスン作成</span>
            </button>
            <button class="tab-btn" onclick="switchTab('calendar-view')">
                <i></i>
                <span>カレンダー</span>
            </button>
            <button class="tab-btn" onclick="switchTab('lesson-management')">
                <i></i>
                <span>レッスン管理</span>
            </button>
            <button class="tab-btn" onclick="switchTab('instructor-management')">
                <i></i>
                <span>講師情報管理</span>
            </button>
            <button class="tab-btn" onclick="switchTab('rating-evaluation')">
                <i></i>
                <span>評価確認</span>
            </button>
        </div>

        <div class="tab-navigation" id="coordinator-tabs">
            <button class="tab-btn active" onclick="switchTab('statistics')">
                <i></i>
                <span>統計情報</span>
            </button>
            <button class="tab-btn" onclick="switchTab('all-students')">
                <i></i>
                <span>全受講生一覧</span>
            </button>
            <button class="tab-btn" onclick="switchTab('all-lessons')">
                <i></i>
                <span>全レッスン一覧</span>
            </button>
            <button class="tab-btn" onclick="switchTab('student-registration')">
                <i></i>
                <span>受講生情報登録</span>
            </button>
            <button class="tab-btn" onclick="switchTab('lesson-calendar')">
                <i></i>
                <span>カレンダー</span>
            </button>
        </div>

        <div class="tab-navigation" id="admin-tabs">
            <button class="tab-btn active" onclick="switchTab('all-evaluations')">
                <i></i>
                <span>全評価一覧</span>
            </button>
            <button class="tab-btn" onclick="switchTab('system-overview')">
                <i></i>
                <span>システム概要</span>
            </button>
        </div>

        <!-- 講師用インターフェース -->
        <div id="instructor-interface">
            <button class="refresh-btn" onclick="refreshPage()" title="画面を更新">
                更新
            </button>
            <!-- 講師ログイン -->
            <div class="section" id="instructor-login">
                <h2>講師ログイン (Instructor Login)</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>パスワード (Password)</label>
                        <input type="password" id="instructor-password" placeholder="パスワードを入力">
                    </div>
                </div>
                <button class="btn" onclick="loginInstructor()">ログイン (Login)</button>
            </div>

            <!-- 講師管理パネル -->
            <div class="hide" id="instructor-panel" style="position: relative;">
                <button class="refresh-btn" onclick="refreshPage()" title="ページを更新">更新</button>
                <!-- レッスン作成タブ -->
                <div class="tab-content active" id="lesson-creation">
                    <div class="section">
                        <h2>レッスン作成 (Create Lessons)</h2>
                        
                        <!-- バッチ作成コントロール -->
                        <div class="batch-controls">
                            <label>
                                <input type="checkbox" id="batch-mode-toggle" onchange="toggleBatchMode()">
                                複数レッスン一括作成 (Batch Create)
                            </label>
                            <div id="batch-date-range" class="hide">
                                <label>開始日 (Start Date)</label>
                                <input type="date" id="batch-start-date">
                                <label>終了日 (End Date)</label>
                                <input type="date" id="batch-end-date">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>担当講師 (Instructor)</label>
                                <select id="lesson-instructor">
                                    <option value="">講師を選択してください</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>レッスン内容 (Content)</label>
                                <input type="text" id="lesson-content" value="面接対策レッスン" placeholder="レッスン内容を入力">
                            </div>
                            <div class="form-group">
                                <label>日付 (Date)</label>
                                <input type="date" id="lesson-date">
                            </div>
                            <div class="form-group">
                                <label>所要時間 (Duration)</label>
                                <select id="lesson-duration">
                                    <option value="15">15分</option>
                                    <option value="30">30分</option>
                                    <option value="45" selected>45分</option>
                                    <option value="60">60分</option>
                                    <option value="90">90分</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>定員 (Capacity)</label>
                                <input type="number" id="lesson-capacity" value="999" min="1" max="999">
                            </div>
                            <div class="form-group">
                                <label>対象レベル (Target Level)</label>
                                <select id="lesson-level">
                                    <option value="ALL" selected>全レベル</option>
                                    <option value="N1">N1 (上級)</option>
                                    <option value="N2">N2 (中上級)</option>
                                    <option value="N3">N3 (中級)</option>
                                    <option value="N4">N4 (初中級)</option>
                                    <option value="N5">N5 (初級)</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>時間帯選択 (Time Slots)</label>
                            <div class="time-slots" id="time-slots">
                                <!-- 時間帯選択肢がここに生成されます -->
                            </div>
                        </div>

                        <!-- Google Calendar連携 -->
                        <div class="form-group">
                            <div class="google-calendar-card">
                                <label>
                                    <input type="checkbox" id="add-to-calendar" checked>
                                    Googleカレンダーに自動追加 (Add to Google Calendar)
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>オンラインリンク (Online Link) - 後から追加可能</label>
                            <input type="url" id="lesson-online-link" placeholder="https://zoom.us/j/... (オプション)">
                        </div>

                        <button class="btn" onclick="createLesson()">レッスン作成 (Create Lesson)</button>
                    </div>
                </div>

                <!-- カレンダー表示タブ -->
                <div class="tab-content" id="calendar-view">
                    <div class="calendar-view">
                        <div class="calendar-header">
                            <h3>カレンダー (Calendar)</h3>
                            <div class="calendar-nav">
                                <button class="btn btn-secondary" onclick="changeMonth(-1)">← 前月</button>
                                <span id="current-month"></span>
                                <button class="btn btn-secondary" onclick="changeMonth(1)">次月 →</button>
                            </div>
                        </div>
                        <div class="calendar-grid" id="calendar-grid"></div>
                    </div>
                </div>

                <!-- レッスン管理タブ -->
                <div class="tab-content" id="lesson-management">
                    <div class="section">
                        <h2>作成済みレッスン一覧 (Created Lessons)</h2>
                        <div id="created-lessons"></div>
                    </div>
                </div>

                <!-- 講師情報管理タブ -->
                <div class="tab-content" id="instructor-management">
                    <div class="section">
                        <h2>講師情報管理 (Instructor Management)</h2>
                        
                        <!-- 講師情報登録 -->
                        <div class="form-group">
                            <h3>講師情報登録 (Instructor Registration)</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>講師名 (Name)</label>
                                    <input type="text" id="instructor-name" placeholder="例：田中太郎">
                                </div>
                            </div>
                            <button class="btn" onclick="addInstructor()">講師追加 (Add Instructor)</button>
                        </div>

                        <!-- 講師一覧 -->
                        <div class="form-group">
                            <h3>登録済み講師一覧 (Registered Instructors)</h3>
                            <div id="instructor-list"></div>
                        </div>
                    </div>
                </div>

                <!-- 評価確認タブ（修正版） -->
                <div class="tab-content" id="rating-evaluation">
                    <div class="section">
                        <h2>評価確認・管理 (Rating & Evaluation Management)</h2>
                        
                        <!-- 受講済み受講生一覧 -->
                        <div class="form-group">
                            <h3>受講済み受講生一覧 (Completed Students List)</h3>
                            <div id="completed-students-list"></div>
                        </div>

                        <!-- 受講生評価一覧（トグル） -->
                        <div class="form-group">
                            <button id="toggle-student-ratings-list" class="btn btn-secondary" onclick="toggleStudentRatingsList()" style="font-size: 14px; margin-bottom: 10px;">
                                受講生から講師への評価一覧を表示
                            </button>
                            <div id="student-ratings-list-section" style="display: none;">
                                <h3>受講生から講師への評価一覧 (Student to Instructor Ratings List)</h3>
                                <div id="ratings-list"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 受講生用インターフェース（修正版） -->
        <div id="student-interface" class="hide">
            <button class="refresh-btn" onclick="refreshPage()" title="画面を更新">
                更新
            </button>
            <!-- 受講生ログイン -->
            <div class="section" id="student-login">
                <h2>受講生ログイン (Student Login)</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>登録番号 (Registration ID)</label>
                        <input type="text" id="student-id" placeholder="例：STU001">
                    </div>
                    <div class="form-group">
                        <label>パスワード (Password)</label>
                        <input type="password" id="student-password" placeholder="パスワードを入力">
                    </div>
                </div>
                <button class="btn" onclick="loginStudent()">ログイン (Login)</button>
            </div>

            <!-- 受講者管理パネル（修正版 - 受講生情報登録を削除） -->
            <div class="section hide" id="student-panel" style="position: relative;">
            <button class="refresh-btn" onclick="refreshPage()" title="ページを更新">更新</button>
                <!-- 現在ログイン中の受講者情報 -->
                <div id="current-student-info" style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #4CAF50;">
                    <span style="color: #4CAF50; font-weight: bold;">ログイン中:</span>
                    <span id="student-display-info" style="color: white; font-size: 16px; margin-left: 10px;">-</span>
                </div>
                <h2>受講者管理パネル (Student Management Panel)</h2>
                <p style="color: #ff4444; font-size: 14px; margin-bottom: 20px;">※レッスン予約は開始時間まで可能です。キャンセルは30分前まで可能です。</p>
                
                <!-- ①受講済みレッスン -->
                <div class="form-group">
                    <h3>受講済みレッスン (Completed Lessons)</h3>
                    <div id="completed-lessons"></div>
                </div>

                <!-- ②予約済みレッスン -->
                <div class="form-group">
                    <h3>予約済みレッスン (Booked Lessons)</h3>
                    <div id="booked-lessons"></div>
                </div>

                <!-- ③予約可能レッスン -->
                <div class="form-group">
                    <h3>予約可能レッスン (Available Lessons for Booking)</h3>
                    <div id="available-lessons"></div>
                </div>
            </div>
        </div>

        <!-- 受講生担当用インターフェース（修正版） -->
        <div id="coordinator-interface" class="hide">
            <button class="refresh-btn" onclick="refreshPage()" title="画面を更新">
                更新
            </button>
            <div class="section" id="coordinator-login">
                <h2>受講生担当ログイン (Coordinator Login)</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>担当者ID (Coordinator ID)</label>
                        <input type="text" id="coordinator-id" placeholder="例：coord">
                    </div>
                    <div class="form-group">
                        <label>パスワード (Password)</label>
                        <input type="password" id="coordinator-password" placeholder="パスワードを入力">
                    </div>
                </div>
                <button class="btn" onclick="loginCoordinator()">ログイン (Login)</button>
            </div>

            <div class="hide" id="coordinator-panel" style="position: relative;">
            <button class="refresh-btn" onclick="refreshPage()" title="ページを更新">更新</button>
                <button class="refresh-btn" onclick="refreshPage()" title="ページを更新">更新</button>
                <!-- 担当者情報ヘッダー -->
                <div class="section" style="background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; margin-bottom: 20px;">
                    <h3 id="coordinator-welcome" style="margin: 0; color: #3b82f6;">担当者: ログイン中</h3>
                </div>
                <!-- 統計情報タブ -->
                <div class="tab-content active" id="statistics">
                    <div class="section">
                        <h2>統計情報 (Statistics)</h2>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number" id="total-students">0</div>
                                <div>総受講生数</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="attended-students">0</div>
                                <div>受講済み人数</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="lesson-attendance-rate">0%</div>
                                <div>受講率</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="avg-rating"><span class="rating-stars no-rating">未評価</span></div>
                                <div>平均受講態度</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 低評価受講生一覧 -->
                    <div class="section poor-attitude-section">
                        <h3>低評価受講生一覧 (Poor Attitude Students)</h3>
                        <div id="poor-attitude-students"></div>
                    </div>
                </div>

                <!-- 全受講生一覧タブ -->
                <div class="tab-content" id="all-students">
                    <div class="section">
                        <h2>全受講生一覧 (All Students)</h2>
                        <div id="all-students-list"></div>
                    </div>
                </div>

                <!-- 全レッスン一覧タブ -->
                <div class="tab-content" id="all-lessons">
                    <div class="section">
                        <h2>全レッスン一覧 (All Lessons)</h2>

                        <div id="all-lessons-list"></div>
                        <div style="margin-top: 30px; text-align: center;">
                            <button id="toggle-past-lessons" class="btn btn-secondary" onclick="togglePastLessons()" style="font-size: 14px;">
                                終了レッスンを表示
                            </button>
                        </div>
                        <div id="past-lessons-list" style="display: none;">
                            <h3 style="margin-top: 30px; padding-top: 20px; border-top: 2px solid rgba(255,255,255,0.3);">終了済みレッスン</h3>
                            <div id="past-lessons-content"></div>
                        </div>
                    </div>
                </div>

                <!-- 受講生情報登録タブ（移動） -->
                <div class="tab-content" id="student-registration">
                    <div class="section">
                        <h2>受講生情報登録 (Student Registration)</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label>登録番号 (Registration ID)</label>
                                <input type="text" id="new-student-id" placeholder="例：STU001">
                            </div>
                            <div class="form-group">
                                <label>氏名 (Name - アルファベット大文字)</label>
                                <input type="text" id="student-name" class="uppercase-input" placeholder="例：TANAKA TARO">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>日本語レベル (Japanese Level) - 任意</label>
                                <select id="student-level">
                                    <option value="">未設定</option>
                                    <option value="N1">N1 (上級)</option>
                                    <option value="N2">N2 (中上級)</option>
                                    <option value="N3">N3 (中級)</option>
                                    <option value="N4">N4 (初中級)</option>
                                    <option value="N5">N5 (初級)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>担当者 (Coordinator)</label>
                                <select id="student-coordinator">
                                    <option value="">未割り当て</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn" onclick="addStudent()">受講生追加 (Add Student)</button>
                    </div>
                </div>

                <!-- レッスンカレンダータブ -->
                <div class="tab-content" id="lesson-calendar">
                    <div class="section">
                        <h2>カレンダー (Calendar)</h2>
                        
                        <!-- カレンダーナビゲーション -->
                        <div class="calendar-navigation">
                            <button class="btn btn-secondary" onclick="previousMonth()">◀ 前月</button>
                            <h3 id="calendar-title">2024年1月</h3>
                            <button class="btn btn-secondary" onclick="nextMonth()">次月 ▶</button>
                        </div>
                        
                        <!-- カレンダー表示 -->
                        <div id="lesson-calendar-grid" class="calendar-grid">
                            <!-- カレンダーがここに表示される -->
                        </div>
                        
                        <!-- 選択日のレッスン詳細 -->
                        <div id="selected-date-lessons" class="selected-date-section" style="display: none;">
                            <h3 id="selected-date-title">レッスン詳細</h3>
                            <div id="selected-date-content"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 管理者用インターフェース（新規追加） -->
        <div id="admin-interface" class="hide">
            <button class="refresh-btn" onclick="refreshPage()" title="画面を更新">
                更新
            </button>
            <div class="section" id="admin-login">
                <h2>管理者ログイン (Administrator Login)</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>管理者ID (Administrator ID)</label>
                        <input type="text" id="admin-id" placeholder="例：admin">
                    </div>
                    <div class="form-group">
                        <label>パスワード (Password)</label>
                        <input type="password" id="admin-password" placeholder="パスワードを入力">
                    </div>
                </div>
                <button class="btn" onclick="loginAdmin()">ログイン (Login)</button>
            </div>

            <div class="hide" id="admin-panel" style="position: relative;">
                <button class="refresh-btn" onclick="refreshPage()" title="ページを更新">更新</button>
                
                <!-- 管理者用タブナビゲーション -->
                <div class="tab-navigation show">
                    <button class="tab-btn active" onclick="switchAdminTab('admin-evaluations')">
                        <span>📊</span>
                        <span>全評価一覧</span>
                    </button>
                    <button class="tab-btn" onclick="switchAdminTab('admin-overview')">
                        <span>📈</span>
                        <span>システム概要</span>
                    </button>
                    <button class="tab-btn" onclick="switchAdminTab('admin-students')">
                        <span>👥</span>
                        <span>受講生管理</span>
                    </button>
                    <button class="tab-btn" onclick="switchAdminTab('admin-coordinators')">
                        <span>👨‍💼</span>
                        <span>担当者管理</span>
                    </button>
                </div>
                
                <!-- 全評価一覧タブ -->
                <div class="tab-content active" id="admin-evaluations">
                    <div class="section">
                        <h2>全評価一覧 (All Evaluations Overview)</h2>
                        
                        <!-- ①全評価一覧 -->
                        <div class="form-group">
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-number" id="admin-total-student-ratings">0</div>
                                    <div>受講生から講師への評価数</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number" id="admin-avg-student-rating"><span class="rating-stars no-rating">未評価</span></div>
                                    <div>受講生から講師への平均評価</div>
                                </div>
                            </div>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-number" id="admin-total-instructor-ratings">0</div>
                                    <div>講師から受講生への評価数</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number" id="admin-avg-instructor-rating"><span class="rating-stars no-rating">未評価</span></div>
                                    <div>講師から受講生への平均評価</div>
                                </div>
                            </div>
                        </div>

                        <!-- ②低評価一覧 -->
                        <div class="form-group">
                            <h3>低評価一覧 (Poor Ratings Overview)</h3>
                            
                            <!-- 低評価講師一覧 -->
                            <div class="form-group">
                                <h4>低評価講師一覧 (☆2以下)</h4>
                                <div id="admin-poor-instructors"></div>
                            </div>
                            
                            <!-- 低評価受講生一覧 -->
                            <div class="form-group">
                                <h4>問題のある受講生一覧 (改善が必要)</h4>
                                <div id="admin-poor-students"></div>
                            </div>

                            <!-- 欠席追跡セクション -->
                            <div class="form-group">
                                <h4>欠席追跡 (Absence Tracking)</h4>
                                <div id="admin-absence-tracking"></div>
                            </div>
                        </div>

                        <!-- 受講生から講師への評価（トグル） -->
                        <div class="form-group">
                            <button id="toggle-student-ratings" class="btn btn-secondary" onclick="toggleStudentRatings()" style="font-size: 14px; margin-bottom: 10px;">
                                受講生から講師への評価を表示
                            </button>
                            <div id="student-ratings-section" style="display: none;">
                                <h3>受講生から講師への評価 (Student to Instructor Ratings)</h3>
                                <div id="admin-student-ratings"></div>
                            </div>
                        </div>

                        <!-- 講師から受講生への評価（トグル） -->
                        <div class="form-group">
                            <button id="toggle-instructor-ratings" class="btn btn-secondary" onclick="toggleInstructorRatings()" style="font-size: 14px; margin-bottom: 10px;">
                                講師から受講生への評価を表示
                            </button>
                            <div id="instructor-ratings-section" style="display: none;">
                                <h3>講師から受講生への評価 (Instructor to Student Ratings)</h3>
                                <div id="admin-instructor-ratings"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- システム概要タブ -->
                <div class="tab-content" id="admin-overview">
                    <div class="section">
                        <h2>システム概要 (System Overview)</h2>
                        
                        <!-- システム統計 -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number" id="system-total-students">0</div>
                                <div>総受講生数</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="system-student-attendance-rate">0%</div>
                                <div>受講率</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="system-total-instructors">0</div>
                                <div>講師数</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="system-total-lessons">0</div>
                                <div>総レッスン数</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="system-avg-attitude">-</div>
                                <div>平均受講態度</div>
                            </div>
                        </div>
                        
                        <!-- システム管理機能 -->
                        <div class="section" style="margin-top: 30px;">
                            <h3>システム管理 (System Management)</h3>
                            <div class="form-group">
                                <button class="btn btn-warning" onclick="manualDataCleanup()">
                                    データ整合性チェック・クリーンアップ
                                </button>
                                <p class="help-text">
                                    削除されたレッスンに関連する古いデータ（予約・評価）をクリーンアップし、データ整合性を保ちます。
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 受講生管理タブ -->
                <div class="tab-content" id="admin-students">
                    <div class="section">
                        <h2>受講生管理 (Student Management)</h2>
                        <p class="help-text">
                            受講生情報の編集・削除を行います。削除すると関連する予約・評価データもすべて削除されます。
                        </p>
                        
                        <!-- スプレッドシート連携 -->
                        <div style="margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%); border-radius: 12px; border: 2px solid rgba(59, 130, 246, 0.3);">
                            <h3 style="margin-bottom: 15px; color: #3b82f6;">📊 Google Sheets連携</h3>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Apps Script URL:</label>
                                <input type="text" id="apps-script-url" placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec" 
                                       style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(0,0,0,0.2);">
                                <p style="font-size: 12px; color: #666; margin-top: 5px;">
                                    ※ Google Apps ScriptのデプロイURLを入力してください（初回のみ）
                                </p>
                            </div>
                            
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-primary" onclick="syncStudentsFromGoogleSheets()" style="flex: 1; min-width: 200px;">
                                    🔄 受講生を同期（ステータス: 求職中）
                                </button>
                                <button class="btn btn-secondary" onclick="sendAttendanceToGoogleSheets()" style="flex: 1; min-width: 200px;">
                                    📤 出席・評価データを送信
                                </button>
                                <button class="btn btn-danger" onclick="removeInactiveStudents()" style="flex: 1; min-width: 200px;">
                                    🗑️ ステータス変更者を削除
                                </button>
                            </div>
                            
                            <div id="sync-status" style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 6px; display: none;">
                                <span id="sync-status-text"></span>
                            </div>
                            
                            <details style="margin-top: 15px;">
                                <summary style="cursor: pointer; color: #3b82f6; font-weight: 600;">📖 使い方ガイド</summary>
                                <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 6px; font-size: 13px;">
                                    <h4>1. Google Apps Scriptの設定</h4>
                                    <ol>
                                        <li>スプレッドシートで「拡張機能」→「Apps Script」を開く</li>
                                        <li>提供されたコードを貼り付け</li>
                                        <li>「デプロイ」→「新しいデプロイ」</li>
                                        <li>種類: ウェブアプリ、アクセス権限: 全員</li>
                                        <li>デプロイURLを上記に入力</li>
                                    </ol>
                                    
                                    <h4 style="margin-top: 15px;">2. 受講生同期</h4>
                                    <p>「生徒情報」シートのT列が「求職中」の受講生のみを取得します。</p>
                                    
                                    <h4 style="margin-top: 15px;">3. 出席・評価送信</h4>
                                    <p>レッスンの出席状況と評価を「レッスン出席表」シートに書き込みます。</p>
                                </div>
                            </details>
                        </div>
                        
                        <div id="admin-student-list"></div>
                    </div>
                </div>
                
                <!-- 受講担当者管理タブ -->
                <div class="tab-content" id="admin-coordinators">
                    <div class="section">
                        <h2>受講担当者管理 (Coordinator Management)</h2>
                        <p class="help-text">
                            受講担当者の追加・編集・削除を行います。各担当者は自分の担当する受講生のみを管理できます。
                        </p>
                        
                        <!-- 担当者追加フォーム -->
                        <div class="form-group" style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3>新規担当者追加</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>担当者ID</label>
                                    <input type="text" id="new-coordinator-id" placeholder="例：coord003">
                                </div>
                                <div class="form-group">
                                    <label>担当者名</label>
                                    <input type="text" id="new-coordinator-name" placeholder="例：田中花子">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>パスワード</label>
                                <input type="password" id="new-coordinator-password" placeholder="パスワードを入力">
                            </div>
                            <button class="btn btn-primary" onclick="addCoordinator()">
                                担当者を追加
                            </button>
                        </div>
                        
                        <!-- 担当者一覧 -->
                        <div id="admin-coordinator-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- モーダル -->
    <div id="lesson-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">レッスン詳細</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <!-- 評価モーダル -->
    <div id="rating-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>講師を評価する (Rate Instructor)</h3>
                <span class="close" onclick="closeRatingModal()">&times;</span>
            </div>
            <div id="rating-modal-body">
                <div class="form-group">
                    <label>わかりやすさ (Clarity)</label>
                    <div class="star-rating" id="clarity-rating">
                        <span class="star" data-rating="0" style="background-color: #666; color: white; padding: 5px; border-radius: 3px; margin-right: 5px;">不参加</span>
                        <span class="star" data-rating="1">★</span>
                        <span class="star" data-rating="2">★</span>
                        <span class="star" data-rating="3">★</span>
                        <span class="star" data-rating="4">★</span>
                        <span class="star" data-rating="5">★</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>感想 (Comments) <span style="color: #ff4444;">※☆2以下の評価時は理由の記載が必須です</span></label>
                    <textarea id="rating-comment" placeholder="レッスンの感想をお聞かせください...（☆2以下の場合は理由を必ず記載してください）" rows="4"></textarea>
                </div>
                <button class="btn" onclick="submitRating()">評価を送信 (Submit Rating)</button>
            </div>
        </div>
    </div>

    <!-- 講師評価モーダル（新規追加） -->
    <div id="instructor-rating-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>受講生を評価する (Rate Student)</h3>
                <span class="close" onclick="closeInstructorRatingModal()">&times;</span>
            </div>
            <div id="instructor-rating-modal-body">
                <div class="form-group">
                    <label>日本語レベル (Japanese Level)</label>
                    <select id="instructor-rating-level">
                        <option value="N1">N1 (上級)</option>
                        <option value="N2">N2 (中上級)</option>
                        <option value="N3" selected>N3 (中級)</option>
                        <option value="N4">N4 (初中級)</option>
                        <option value="N5">N5 (初級)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>受講態度 (Attitude)</label>
                    <select id="instructor-rating-attitude">
                        <option value="非常に良い">非常に良い</option>
                        <option value="良い" selected>良い</option>
                        <option value="普通">普通</option>
                        <option value="改善が必要">改善が必要</option>
                        <option value="悪い">悪い</option>
                        <option value="不参加">不参加</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>備考欄 (Notes)</label>
                    <textarea id="instructor-rating-notes" placeholder="受講生へのコメントや改善点など..." rows="4"></textarea>
                </div>
                <button class="btn" onclick="submitInstructorRating()">評価を送信 (Submit Rating)</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // データベース設定（Apps Script URL）
        // ==========================================
        // ⚠️ 重要：database-apps-script.jsをデプロイ後、このURLを更新してください
        const DATABASE_API_URL = 'https://script.google.com/macros/s/AKfycbxuAYKBI2X5QP7fQOjiztFsEENLZUZiTA1nrWU0kjGDBLKffASqy5ftqMc_MIu0YWw7xA/exec';  // デプロイ後のApps Script URLをここに設定
        
        // データベース連携を有効にする（falseにするとLocalStorageモードになります）
        const USE_DATABASE = true;
        
        // データベース同期状態
        let isDatabaseSyncing = false;
        let lastSyncTime = null;

        // グローバル変数
        let currentUser = 'instructor';
        let currentUserId = null;
        let currentCoordinatorId = null;
        let instructors = [];
        let students = [];
        let coordinators = [];
        let lessons = [];
        let bookings = [];
        let ratings = [];
        let instructorRatings = [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let isBatchMode = false;
        let currentRatingLessonId = null;
        let selectedRating = null;
        let currentInstructorRatingStudentId = null;
        let currentInstructorRatingLessonId = null;
        
        // ==========================================
        // データベースAPI関数
        // ==========================================
        
        /**
         * データベースから全データを取得
         */
        async function loadAllDataFromDatabase() {
            if (!USE_DATABASE || !DATABASE_API_URL) {
                console.log('データベースモードが無効、またはURLが未設定です。LocalStorageから読み込みます。');
                updateSyncStatus('⚠️ データベース未設定 - LocalStorageモード', true);
                loadFromLocalStorage();
                return;
            }
            
            try {
                isDatabaseSyncing = true;
                updateSyncStatus('🔄 データ同期中...');
                console.log('データベースから全データを取得中...');
                
                // URLにタイムスタンプを追加してキャッシュを回避
                const timestamp = new Date().getTime();
                const response = await fetch(`${DATABASE_API_URL}?_t=${timestamp}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    mode: 'cors',
                    cache: 'no-cache'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('受信したデータ:', result);
                
                if (result.success) {
                    // データ構造を確認（result.data配下にデータがある場合に対応）
                    const data = result.data || result;
                    instructors = data.instructors || [];
                    students = data.students || [];
                    coordinators = data.coordinators || [];
                    lessons = data.lessons || [];
                    bookings = data.bookings || [];
                    ratings = data.ratings || [];
                    instructorRatings = data.instructorRatings || [];
                    
                    lastSyncTime = new Date();
                    console.log('データベース同期完了:', lastSyncTime.toLocaleTimeString());
                    console.log(`取得データ: 受講生${students.length}名, 講師${instructors.length}名, レッスン${lessons.length}件`);
                    updateSyncStatus(`✅ 最終同期: ${lastSyncTime.toLocaleTimeString()}`);
                    
                    // UIを更新
                    updateAllUI();
                } else {
                    console.error('データ取得エラー:', result.error);
                    updateSyncStatus('❌ データ取得エラー - LocalStorageモード', true);
                    alert('データベースからのデータ取得に失敗しました: ' + result.error);
                    loadFromLocalStorage();
                }
            } catch (error) {
                console.error('データベース接続エラー:', error);
                console.error('エラー詳細:', error.message);
                updateSyncStatus('❌ 接続エラー - LocalStorageモード', true);
                loadFromLocalStorage();
            } finally {
                isDatabaseSyncing = false;
            }
        }
        
        /**
         * LocalStorageからデータを読み込む（フォールバック用）
         */
        function loadFromLocalStorage() {
            instructors = JSON.parse(localStorage.getItem('instructors')) || [];
            students = JSON.parse(localStorage.getItem('students')) || [];
            coordinators = JSON.parse(localStorage.getItem('coordinators')) || [];
            lessons = JSON.parse(localStorage.getItem('lessons')) || [];
            bookings = JSON.parse(localStorage.getItem('bookings')) || [];
            ratings = JSON.parse(localStorage.getItem('ratings')) || [];
            instructorRatings = JSON.parse(localStorage.getItem('instructorRatings')) || [];
            console.log('LocalStorageからデータを読み込みました');
        }
        
        /**
         * 全UIを更新
         */
        function updateAllUI() {
            generateTimeSlots();
            updateInstructorSelect();
            updateCalendar();
            populateCoordinatorDropdowns();
        }
        
        /**
         * データベースに全データを同期保存
         */
        async function syncAllDataToDatabase() {
            if (!USE_DATABASE || !DATABASE_API_URL || isDatabaseSyncing) {
                return;
            }
            
            try {
                isDatabaseSyncing = true;
                console.log('データベースに同期中...');
                
                const data = {
                    instructors,
                    students,
                    coordinators,
                    lessons,
                    bookings,
                    ratings,
                    instructorRatings
                };
                
                // Google Apps Scriptにデータを送信（フォーム形式）
                const formData = new URLSearchParams();
                formData.append('action', 'syncAllData');
                formData.append('data', JSON.stringify(data));
                
                const response = await fetch(DATABASE_API_URL, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    lastSyncTime = new Date();
                    console.log('データベース同期完了:', lastSyncTime.toLocaleTimeString());
                    updateSyncStatus(`✅ 保存完了: ${lastSyncTime.toLocaleTimeString()}`);
                } else {
                    console.error('同期エラー:', result.error);
                    updateSyncStatus('⚠️ 保存エラー', true);
                }
            } catch (error) {
                console.error('同期中にエラー:', error);
                updateSyncStatus('⚠️ 保存失敗', true);
            } finally {
                isDatabaseSyncing = false;
            }
        }
        
        /**
         * データを保存（データベース or LocalStorage）
         */
        function saveData(dataType, data) {
            // メモリ内のデータを更新
            switch(dataType) {
                case 'instructors':
                    instructors = data;
                    break;
                case 'students':
                    students = data;
                    break;
                case 'coordinators':
                    coordinators = data;
                    break;
                case 'lessons':
                    lessons = data;
                    break;
                case 'bookings':
                    bookings = data;
                    break;
                case 'ratings':
                    ratings = data;
                    break;
                case 'instructorRatings':
                    instructorRatings = data;
                    break;
            }
            
            // LocalStorageにも保存（バックアップ）
            localStorage.setItem(dataType, JSON.stringify(data));
            
            // データベースに同期（非同期）
            if (USE_DATABASE && DATABASE_API_URL) {
                syncAllDataToDatabase();
            }
        }
        
        /**
         * 同期ステータス表示を更新
         */
        function updateSyncStatus(message, isError = false) {
            const statusElement = document.getElementById('sync-status');
            if (statusElement) {
                statusElement.innerHTML = message;
                statusElement.style.color = isError ? '#ffcccc' : 'white';
            }
        }
        
        /**
         * 手動リフレッシュボタン
         */
        async function manualRefresh() {
            if (!USE_DATABASE || !DATABASE_API_URL) {
                alert('データベースモードが無効です');
                return;
            }
            
            if (confirm('データベースから最新データを取得しますか？\n（未保存の変更は失われます）')) {
                await loadAllDataFromDatabase();
                alert('データを更新しました！');
            }
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', async function() {
            // データベースモードの場合、最初にデータを取得
            if (USE_DATABASE && DATABASE_API_URL) {
                await loadAllDataFromDatabase();
            } else {
                // LocalStorageモードの場合
                loadFromLocalStorage();
            }
            
            // デフォルトデータの初期化
            initializeDefaultData();
            
            // データ整合性チェックとクリーンアップ
            const dataWasCleaned = cleanupOrphanedData();
            
            generateTimeSlots();
            updateInstructorSelect();
            updateCalendar();
            populateCoordinatorDropdowns();
            
            // Apps Script URLの復元
            const savedUrl = localStorage.getItem('appsScriptUrl');
            if (savedUrl) {
                const urlInput = document.getElementById('apps-script-url');
                if (urlInput) urlInput.value = savedUrl;
            }
            
            if (dataWasCleaned) {
                console.log('データクリーンアップが完了しました。統計情報を更新します。');
            }
            
            // 大文字変換の設定
            document.querySelectorAll('.uppercase-input').forEach(input => {
                input.addEventListener('input', function(e) {
                    e.target.value = e.target.value.toUpperCase();
                });
            });

            // 星評価システムの初期化
            initializeStarRating();
            
            // 5分ごとの自動同期を開始
            if (USE_DATABASE && DATABASE_API_URL) {
                setInterval(async () => {
                    console.log('自動同期を実行中...');
                    await loadAllDataFromDatabase();
                }, 300000); // 5分 = 300,000ミリ秒
            }
        });

        // デフォルトデータの初期化
        function initializeDefaultData() {
            // デフォルト講師を追加（存在しない場合のみ）
            if (instructors.length === 0) {
                const defaultInstructors = [
                    {
                        id: 'INST001',
                        name: '田中太郎',
                        email: 'tanaka@example.com',
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 'INST002',
                        name: '佐藤花子',
                        email: 'sato@example.com',
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 'INST003',
                        name: '高橋一郎',
                        email: 'takahashi@example.com',
                        createdAt: new Date().toISOString()
                    }
                ];
                instructors.push(...defaultInstructors);
                saveData('instructors', instructors);
            }

            // デフォルト受講担当者を追加（存在しない場合のみ）
            if (coordinators.length === 0) {
                const defaultCoordinators = [
                    {
                        id: 'coord',
                        name: 'テストアカウント（全受講生表示）',
                        password: 'coord123',
                        isTestAccount: true,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 'coord001',
                        name: '山田太郎',
                        password: 'coord001',
                        isTestAccount: false,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 'coord002',
                        name: '佐藤次郎',
                        password: 'coord002',
                        isTestAccount: false,
                        createdAt: new Date().toISOString()
                    }
                ];
                coordinators.push(...defaultCoordinators);
                saveData('coordinators', coordinators);
            }

            // デフォルト受講生を追加（存在しない場合のみ）
            if (students.length === 0) {
                const defaultStudents = [
                    {
                        id: 'STU001',
                        name: 'YAMADA HANAKO',
                        level: 'N3',
                        coordinatorId: 'coord001',
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 'STU002',
                        name: 'CHEN WEI',
                        level: 'N2',
                        coordinatorId: 'coord001',
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 'STU003',
                        name: 'PARK JIHOON',
                        level: 'N4',
                        coordinatorId: 'coord002',
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 'STU004',
                        name: 'NGUYEN ANH',
                        level: 'N1',
                        coordinatorId: 'coord002',
                        createdAt: new Date().toISOString()
                    }
                ];
                students.push(...defaultStudents);
                saveData('students', students);
            }

            // サンプルレッスンを追加（カレンダーテスト用）
            if (lessons.length === 0) {
                const today = new Date();
                const sampleLessons = [
                    {
                        id: 'LESSON0001',
                        instructorId: 'INST001',
                        instructorName: '田中太郎',
                        content: '面接対策レッスン',
                        date: '2025-10-09',
                        time: '10:00',
                        duration: 45,
                        capacity: 1,
                        level: 'ALL',
                        onlineLink: '',
                        bookedCount: 0,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 'LESSON0002',
                        instructorId: 'INST001',
                        instructorName: '田中太郎',
                        content: '面接対策レッスン',
                        date: '2025-10-10',
                        time: '10:00',
                        duration: 45,
                        capacity: 1,
                        level: 'ALL',
                        onlineLink: '',
                        bookedCount: 0,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 'LESSON0003',
                        instructorId: 'INST001',
                        instructorName: '田中太郎',
                        content: '面接対策レッスン',
                        date: '2025-10-11',
                        time: '12:00',
                        duration: 45,
                        capacity: 1,
                        level: 'ALL',
                        onlineLink: '',
                        bookedCount: 0,
                        createdAt: new Date().toISOString()
                    }
                ];
                lessons.push(...sampleLessons);
                saveData('lessons', lessons);
            }
        }

        // 星評価システムの初期化
        function initializeStarRating() {
            const stars = document.querySelectorAll('#clarity-rating .star');
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    selectedRating = parseInt(this.dataset.rating);
                    updateStarDisplay();
                });

                // 不参加ボタン（rating=0）はマウスオーバー時に光らせない
                const rating = parseInt(star.dataset.rating);
                if (rating > 0) {
                    star.addEventListener('mouseenter', function() {
                        highlightStars(rating);
                    });
                }
            });

            document.getElementById('clarity-rating').addEventListener('mouseleave', function() {
                updateStarDisplay();
            });
        }

        // 星のハイライト表示（マウスオーバー用）
        function highlightStars(rating) {
            const stars = document.querySelectorAll('#clarity-rating .star');
            stars.forEach((star, index) => {
                const starRating = parseInt(star.dataset.rating);
                // マウスオーバー時は不参加ボタンを一切光らせない（rating=0は除外）
                if (rating !== null && rating !== undefined && starRating <= rating && rating > 0 && starRating > 0) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }
        
        // 星の表示更新（実際の選択状態用）
        function updateStarSelection(rating) {
            const stars = document.querySelectorAll('#clarity-rating .star');
            stars.forEach((star, index) => {
                const starRating = parseInt(star.dataset.rating);
                
                if (rating > 0) {
                    // 星評価が選択されている場合：該当する星のみ光らせ、不参加は光らせない
                    if (starRating <= rating && starRating > 0) {
                        star.classList.add('active');
                    } else {
                        star.classList.remove('active');
                    }
                } else if (rating === 0) {
                    // 不参加が選択されている場合：不参加のみ光らせ、星は光らせない
                    if (starRating === 0) {
                        star.classList.add('active');
                    } else {
                        star.classList.remove('active');
                    }
                } else {
                    // 何も選択されていない場合：すべて消灯
                    star.classList.remove('active');
                }
            });
        }

        // 星の表示更新
        function updateStarDisplay() {
            updateStarSelection(selectedRating);
        }

        // ユーザータイプ切り替え
        function switchUserType(type) {
            currentUser = type;
            
            // ボタンのアクティブ状態を更新
            document.querySelectorAll('.user-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // インターフェースを切り替え
            document.getElementById('instructor-interface').classList.toggle('hide', type !== 'instructor');
            document.getElementById('student-interface').classList.toggle('hide', type !== 'student');
            document.getElementById('coordinator-interface').classList.toggle('hide', type !== 'coordinator');
            document.getElementById('admin-interface').classList.toggle('hide', type !== 'admin');
            
            // タブナビゲーションの表示切り替え
            document.getElementById('instructor-tabs').classList.toggle('show', type === 'instructor' && currentUserId);
            document.getElementById('coordinator-tabs').classList.toggle('show', type === 'coordinator' && currentUserId);
            document.getElementById('admin-tabs').classList.toggle('show', type === 'admin' && currentUserId);
            
            // ログアウト
            currentUserId = null;
            resetPanels();
        }

        // タブ切り替え
        function switchTab(tabName) {
            // 全てのタブボタンからactiveクラスを削除
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // クリックされたタブボタンにactiveクラスを追加
            event.target.classList.add('active');
            
            // 全てのタブコンテンツを非表示
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 選択されたタブコンテンツを表示
            document.getElementById(tabName).classList.add('active');
            
            // タブに応じたデータ更新
            if (tabName === 'lesson-management') {
                updateCreatedLessons();
            } else if (tabName === 'calendar-view') {
                updateCalendar();
            } else if (tabName === 'rating-evaluation') {
                updateRatingEvaluation();
            } else if (tabName === 'all-evaluations') {
                updateAllEvaluations();
            } else if (tabName === 'system-overview') {
                updateSystemOverview();
            } else if (tabName === 'available-lessons-tab') {
                updateAvailableLessons();
                updateBookedLessons();
                updateCompletedLessons();
            } else if (tabName === 'lesson-calendar') {
                generateCalendar(currentCalendarDate);
            }
        }

        // パネルをリセット
        function resetPanels() {
            document.getElementById('instructor-panel').classList.add('hide');
            document.getElementById('student-panel').classList.add('hide');
            document.getElementById('coordinator-panel').classList.add('hide');
            document.getElementById('admin-panel').classList.add('hide');
            document.getElementById('instructor-login').classList.remove('hide');
            document.getElementById('student-login').classList.remove('hide');
            document.getElementById('coordinator-login').classList.remove('hide');
            document.getElementById('admin-login').classList.remove('hide');
            
            // タブナビゲーションを非表示
            document.getElementById('instructor-tabs').classList.remove('show');
            document.getElementById('coordinator-tabs').classList.remove('show');
            document.getElementById('admin-tabs').classList.remove('show');
        }

        // 評価確認・管理の更新（修正版）
        function updateRatingEvaluation() {
            // 受講済み受講生一覧の更新
            updateCompletedStudentsList();
            
            // 評価一覧の更新
            updateRatingsList();
        }

        // 評価一覧の更新
        function updateRatingsList() {
            const container = document.getElementById('ratings-list');
            container.innerHTML = '';
            
            // 評価を新しい順でソート
            const sortedRatings = ratings.sort((a, b) => new Date(b.ratedAt) - new Date(a.ratedAt));
            
            sortedRatings.forEach(rating => {
                const lesson = lessons.find(l => l.id === rating.lessonId);
                const student = students.find(s => s.id === rating.studentId);
                
                if (!lesson || !student) return;
                
                const card = document.createElement('div');
                card.className = 'rating-card';
                card.innerHTML = `
                    <h4>${lesson.content}</h4>
                    <div class="rating-details">
                        <span>受講生: ${student.name}</span>
                        <span>レベル: ${student.level}</span>
                        <span>日時: ${lesson.date} ${lesson.time}</span>
                        <span>講師: ${lesson.instructorName}</span>
                        <span class="rating-stars">評価: ${'★'.repeat(rating.rating)}${'☆'.repeat(5-rating.rating)} (${rating.rating}/5)</span>
                        <span>評価日: ${new Date(rating.ratedAt).toLocaleDateString()}</span>
                    </div>
                    ${rating.comment ? `
                        <div class="rating-comment">
                            <strong>コメント:</strong>
                            <p>"${rating.comment}"</p>
                        </div>
                    ` : ''}
                `;
                container.appendChild(card);
            });
            
            if (sortedRatings.length === 0) {
                container.innerHTML = '<div class="lesson-card"><h4>評価がありません</h4><p>まだ評価が投稿されていません。</p></div>';
            }
        }

        // 時間帯生成
        function generateTimeSlots() {
            const timeSlotsContainer = document.getElementById('time-slots');
            timeSlotsContainer.innerHTML = '';
            
            for (let hour = 10; hour <= 17; hour++) {
                for (let minute = 0; minute < 60; minute += 30) {
                    const time = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    const div = document.createElement('div');
                    div.className = 'time-slot';
                    div.innerHTML = `
                        <input type="checkbox" id="time-${time}" value="${time}" onchange="selectTimeSlot(this)">
                        <label for="time-${time}">${time}</label>
                    `;
                    timeSlotsContainer.appendChild(div);
                }
            }
        }

        // 時間帯選択
        function selectTimeSlot(checkbox) {
            const timeSlot = checkbox.closest('.time-slot');
            if (checkbox.checked) {
                timeSlot.classList.add('selected');
            } else {
                timeSlot.classList.remove('selected');
            }
            
            // 単一選択モードの場合、他のチェックボックスを無効にする
            if (!isBatchMode && checkbox.checked) {
                const allCheckboxes = document.querySelectorAll('#time-slots input[type="checkbox"]');
                allCheckboxes.forEach(cb => {
                    if (cb !== checkbox) {
                        cb.checked = false;
                        cb.closest('.time-slot').classList.remove('selected');
                    }
                });
            }
        }

        // バッチモード切り替え
        function toggleBatchMode() {
            isBatchMode = document.getElementById('batch-mode-toggle').checked;
            document.getElementById('batch-date-range').classList.toggle('hide', !isBatchMode);
            
            // 個別日付入力の表示/非表示を切り替え
            const singleDateField = document.getElementById('lesson-date').closest('.form-group');
            if (isBatchMode) {
                singleDateField.style.display = 'none';
            } else {
                singleDateField.style.display = 'block';
            }
            
            // 既存の選択をクリア
            const allCheckboxes = document.querySelectorAll('#time-slots input[type="checkbox"]');
            allCheckboxes.forEach(cb => {
                cb.checked = false;
                cb.closest('.time-slot').classList.remove('selected');
            });
        }

        // 講師ログイン
        function loginInstructor() {
            const password = document.getElementById('instructor-password').value;
            
            if (!password) {
                showAlert('パスワードを入力してください', 'error');
                return;
            }
            
            // パスワードが正しければログイン成功（管理者として）
            if (password === 'admin123') {
                currentUserId = 'admin';
                document.getElementById('instructor-login').classList.add('hide');
                document.getElementById('instructor-panel').classList.remove('hide');
                document.getElementById('instructor-tabs').classList.add('show');
                
                console.log('Instructor logged in, lessons count:', lessons.length); // デバッグ用
                
                updateInstructorSelect();
                updateCreatedLessons();
                updateInstructorList();
                updateCalendar();
                showAlert('ログインしました', 'success');
            } else {
                showAlert('パスワードが正しくありません', 'error');
            }
        }

        // 受講者ログイン
        function loginStudent() {
            const id = document.getElementById('student-id').value.trim();
            const password = document.getElementById('student-password').value;
            
            if (!id || !password) {
                showAlert('IDとパスワードを入力してください', 'error');
                return;
            }
            
            // 登録済み受講生IDの確認
            const studentExists = students.find(s => s.id === id);
            
            if (studentExists && password === 'student123') {
                currentUserId = id;
                document.getElementById('student-login').classList.add('hide');
                document.getElementById('student-panel').classList.remove('hide');
                
                // 受講者情報を表示
                updateStudentInfo(studentExists);
                
                updateAvailableLessons();
                updateBookedLessons();
                updateCompletedLessons();
                showAlert('ログインしました', 'success');
            } else if (!studentExists) {
                showAlert('存在しない受講生IDです。受講生担当者に登録を依頼してください。', 'error');
            } else {
                showAlert('IDまたはパスワードが正しくありません', 'error');
            }
        }

        // 受講生担当ログイン
        function loginCoordinator() {
            const id = document.getElementById('coordinator-id').value.trim();
            const password = document.getElementById('coordinator-password').value;
            
            if (!id || !password) {
                showAlert('IDとパスワードを入力してください', 'error');
                return;
            }
            
            // coordinators配列から認証
            const coordinator = coordinators.find(c => c.id === id);
            
            if (!coordinator) {
                showAlert('存在しない担当者IDです', 'error');
                return;
            }
            
            if (coordinator.password !== password) {
                showAlert('IDまたはパスワードが正しくありません', 'error');
                return;
            }
            
            // ログイン成功
            currentUserId = id;
            currentCoordinatorId = id;
            document.getElementById('coordinator-login').classList.add('hide');
            document.getElementById('coordinator-panel').classList.remove('hide');
            document.getElementById('coordinator-tabs').classList.add('show');
            
            // 担当者名をヘッダーに表示
            const welcomeHeader = document.getElementById('coordinator-welcome');
            if (welcomeHeader) {
                const modeText = coordinator.isTestAccount ? '（全受講生表示モード）' : '';
                welcomeHeader.textContent = `担当者: ${coordinator.name} ${modeText}`;
            }
            
            // 担当者名を表示
            const welcomeMessage = coordinator.isTestAccount ? 
                `${coordinator.name}でログインしました（全受講生表示モード）` : 
                `${coordinator.name}でログインしました`;
            showAlert(welcomeMessage, 'success');
            
            // ダッシュボード更新（担当者フィルタリング適用）
            updateCoordinatorDashboard();
            populateCoordinatorDropdowns();
        }

        // 講師追加
        function addInstructor() {
            const name = document.getElementById('instructor-name').value.trim();
            
            if (!name) {
                showAlert('講師名を入力してください', 'error');
                return;
            }
            
            // 同名講師のチェック
            if (instructors.find(i => i.name === name)) {
                showAlert('同じ名前の講師が既に登録されています', 'error');
                return;
            }
            
            const instructor = {
                id: 'INST' + (instructors.length + 1).toString().padStart(3, '0'),
                name: name,
                createdAt: new Date().toISOString()
            };
            
            instructors.push(instructor);
            saveData('instructors', instructors);
            
            document.getElementById('instructor-name').value = '';
            
            updateInstructorList();
            updateInstructorSelect();
            showAlert('講師を追加しました', 'success');
        }

        // 受講者追加（受講生担当ページ用）
        function addStudent() {
            const id = document.getElementById('new-student-id').value.trim();
            const name = document.getElementById('student-name').value.trim();
            const level = document.getElementById('student-level').value || '未設定';
            const coordinatorId = document.getElementById('student-coordinator').value || null;
            
            if (!id || !name) {
                showAlert('受講生IDと名前を入力してください', 'error');
                return;
            }
            
            // 重複チェック
            if (students.find(s => s.id === id)) {
                showAlert('この登録番号は既に使用されています', 'error');
                return;
            }
            
            const student = {
                id: id,
                name: name.toUpperCase(),
                level: level,
                coordinatorId: coordinatorId,
                createdAt: new Date().toISOString()
            };
            
            students.push(student);
            saveData('students', students);
            
            document.getElementById('new-student-id').value = '';
            document.getElementById('student-name').value = '';
            document.getElementById('student-level').value = '';
            document.getElementById('student-coordinator').value = '';
            
            showAlert('受講者を追加しました', 'success');
            updateCoordinatorDashboard();
        }

        // 管理者ログイン（新規追加）
        function loginAdmin() {
            const id = document.getElementById('admin-id').value.trim();
            const password = document.getElementById('admin-password').value;
            
            if (!id || !password) {
                showAlert('IDとパスワードを入力してください', 'error');
                return;
            }
            
            if (id === 'admin' && password === 'admin123') {
                currentUserId = id;
                document.getElementById('admin-login').classList.add('hide');
                document.getElementById('admin-panel').classList.remove('hide');
                updateAllEvaluations();
                updateSystemOverview();
                updateAdminStudentList();
                showAlert('管理者ログイン成功', 'success');
            } else if (id !== 'admin') {
                showAlert('存在しない管理者IDです。正しいIDは「admin」です。', 'error');
            } else {
                showAlert('IDまたはパスワードが正しくありません', 'error');
            }
        }
        
        // 管理者タブ切り替え
        function switchAdminTab(tabId) {
            // すべてのタブコンテンツを非表示
            const tabContents = document.querySelectorAll('#admin-panel .tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // すべてのタブボタンを非アクティブ化
            const tabBtns = document.querySelectorAll('#admin-panel .tab-btn');
            tabBtns.forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 選択されたタブを表示
            const selectedTab = document.getElementById(tabId);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // 対応するボタンをアクティブ化
            event.target.closest('.tab-btn').classList.add('active');
            
            // タブごとの更新処理
            if (tabId === 'admin-evaluations') {
                updateAllEvaluations();
            } else if (tabId === 'admin-overview') {
                updateSystemOverview();
            } else if (tabId === 'admin-students') {
                updateAdminStudentList();
            } else if (tabId === 'admin-coordinators') {
                updateAdminCoordinatorList();
            }
        }

        // レッスン作成
        function createLesson() {
            const instructorId = document.getElementById('lesson-instructor').value;
            const content = document.getElementById('lesson-content').value.trim();
            const date = document.getElementById('lesson-date').value;
            const duration = parseInt(document.getElementById('lesson-duration').value);
            const capacity = parseInt(document.getElementById('lesson-capacity').value);
            const level = document.getElementById('lesson-level').value;
            const onlineLink = document.getElementById('lesson-online-link').value.trim();
            const addToCalendar = document.getElementById('add-to-calendar').checked;
            
            const selectedTimes = [];
            document.querySelectorAll('#time-slots input[type="checkbox"]:checked').forEach(cb => {
                selectedTimes.push(cb.value);
            });
            
            // バッチモード時は日付チェックを除外
            if (!instructorId || !content || selectedTimes.length === 0) {
                showAlert('必要な項目を入力してください', 'error');
                return;
            }
            
            // 単一レッスンモードでは日付必須
            if (!isBatchMode && !date) {
                showAlert('日付を選択してください', 'error');
                return;
            }
            
            const instructor = instructors.find(i => i.id === instructorId);
            if (!instructor) {
                showAlert('講師が見つかりません', 'error');
                return;
            }
            
            if (isBatchMode) {
                createBatchLessons(instructor, content, duration, capacity, level, selectedTimes, onlineLink, addToCalendar);
            } else {
                createSingleLesson(instructor, content, date, selectedTimes[0], duration, capacity, level, onlineLink, addToCalendar);
            }
        }

        // 単一レッスン作成
        function createSingleLesson(instructor, content, date, time, duration, capacity, level, onlineLink, addToCalendar) {
            console.log('Creating lesson with instructor:', instructor); // デバッグ用
            
            const lesson = {
                id: 'LESSON' + (lessons.length + 1).toString().padStart(4, '0'),
                instructorId: instructor.id,
                instructorName: instructor.name,
                content: content,
                date: date,
                time: time,
                duration: duration,
                capacity: capacity,
                level: level,
                onlineLink: onlineLink,
                bookedCount: 0,
                createdAt: new Date().toISOString()
            };
            
            console.log('Lesson object created:', lesson); // デバッグ用
            
            lessons.push(lesson);
            console.log('Lessons array after push:', lessons); // デバッグ用
            
            saveData('lessons', lessons);
            console.log('Lessons saved to localStorage'); // デバッグ用
            
            if (addToCalendar) {
                addToGoogleCalendar(lesson, instructor);
            }
            
            resetLessonForm();
            updateCreatedLessons();
            updateCalendar();
            showAlert('レッスンを作成しました', 'success');
        }

        // バッチレッスン作成
        function createBatchLessons(instructor, content, duration, capacity, level, selectedTimes, onlineLink, addToCalendar) {
            const startDateValue = document.getElementById('batch-start-date').value;
            const endDateValue = document.getElementById('batch-end-date').value;
            
            if (!startDateValue || !endDateValue) {
                showAlert('開始日と終了日を選択してください', 'error');
                return;
            }
            
            const startDate = new Date(startDateValue);
            const endDate = new Date(endDateValue);
            
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime()) || startDate > endDate) {
                showAlert('正しい日付範囲を指定してください', 'error');
                return;
            }
            
            let createdCount = 0;
            const currentDate = new Date(startDate);
            const createdLessons = []; // 作成されたレッスンを記録
            
            while (currentDate <= endDate) {
                const dateStr = currentDate.toISOString().split('T')[0];
                
                selectedTimes.forEach(time => {
                    const lesson = {
                        id: 'LESSON' + (lessons.length + 1).toString().padStart(4, '0'),
                        instructorId: instructor.id,
                        instructorName: instructor.name,
                        content: content,
                        date: dateStr,
                        time: time,
                        duration: duration,
                        capacity: capacity,
                        level: level,
                        onlineLink: onlineLink,
                        bookedCount: 0,
                        createdAt: new Date().toISOString()
                    };
                    
                    lessons.push(lesson);
                    createdLessons.push(lesson);
                    createdCount++;
                });
                
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            saveData('lessons', lessons);
            
            // バッチ作成後に全レッスン分のGoogleカレンダーリンクを表示
            if (addToCalendar && createdLessons.length > 0) {
                showBatchCalendarModal(createdLessons, instructor);
                showAlert(`${createdCount}件のレッスンを作成しました`, 'success');
            }
            
            resetLessonForm();
            updateCreatedLessons();
            updateCalendar();
            showAlert(`${createdCount}件のレッスンを作成しました`, 'success');
        }

        // Google Calendar に追加
        function addToGoogleCalendar(lesson, instructor) {
            const startDateTime = new Date(`${lesson.date}T${lesson.time}:00`);
            const endDateTime = new Date(startDateTime.getTime() + lesson.duration * 60000);
            
            const formatDate = (date) => {
                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            };
            
            const calendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE` +
                `&text=${encodeURIComponent(lesson.content)}` +
                `&dates=${formatDate(startDateTime)}/${formatDate(endDateTime)}` +
                `&details=${encodeURIComponent(`講師: ${instructor.name}\nレベル: ${lesson.level}\n定員: ${lesson.capacity}名`)}` +
                `&location=${lesson.onlineLink ? encodeURIComponent(lesson.onlineLink) : ''}`;
            
            // 新しいウィンドウでカレンダーを開く
            window.open(calendarUrl, '_blank');
        }
        
        // バッチ作成後のGoogleカレンダーリンク一覧をモーダルで表示
        function showBatchCalendarModal(lessons, instructor) {
            let modalContent = `
                <div style="padding: 20px; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                    <h3 style="color: #333; margin-bottom: 20px; text-align: center;">
                        Googleカレンダーに追加 (${lessons.length}件のレッスン)
                    </h3>
                    <p style="color: #666; margin-bottom: 20px; text-align: center;">
                        各レッスンのリンクをクリックしてGoogleカレンダーに追加してください
                    </p>
                    <div style="display: grid; gap: 15px;">
            `;
            
            lessons.forEach((lesson, index) => {
                const startDateTime = new Date(`${lesson.date}T${lesson.time}:00`);
                const endDateTime = new Date(startDateTime.getTime() + lesson.duration * 60000);
                
                const formatDate = (date) => {
                    return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                };
                
                const calendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE` +
                    `&text=${encodeURIComponent(lesson.content)}` +
                    `&dates=${formatDate(startDateTime)}/${formatDate(endDateTime)}` +
                    `&details=${encodeURIComponent(`講師: ${instructor.name}\\nレベル: ${lesson.level}\\n定員: ${lesson.capacity}名`)}` +
                    `&location=${lesson.onlineLink ? encodeURIComponent(lesson.onlineLink) : ''}`;
                
                const lessonDate = new Date(lesson.date);
                const dateStr = lessonDate.toLocaleDateString('ja-JP', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric', 
                    weekday: 'short' 
                });
                
                modalContent += `
                    <div style="border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 10px; padding: 15px; background: rgba(102, 126, 234, 0.1);">
                        <div style="margin-bottom: 10px;">
                            <strong style="color: #333;">レッスン ${index + 1}: ${lesson.content}</strong>
                        </div>
                        <div style="color: #555; margin-bottom: 15px;">
                            ${dateStr} ${lesson.time} (${lesson.duration}分)
                            <br>講師: ${instructor.name}
                            <br>レベル: ${lesson.level} | 定員: ${lesson.capacity}名
                        </div>
                        <a href="${calendarUrl}" target="_blank" 
                           style="display: inline-block; background: linear-gradient(135deg, rgba(102, 126, 234, 0.9) 0%, rgba(118, 75, 162, 0.9) 100%); 
                                  color: white; text-decoration: none; padding: 10px 20px; border-radius: 5px; 
                                  font-weight: bold; text-align: center; transition: all 0.3s ease;"
                           onmouseover="this.style.transform='translateY(-1px)'"
                           onmouseout="this.style.transform='translateY(0)'">
                            Googleカレンダーに追加
                        </a>
                    </div>
                `;
            });
            
            modalContent += `
                    </div>
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="closeBatchCalendarModal()" 
                                style="padding: 12px 30px; background: #666; color: white; border: none; 
                                       border-radius: 5px; cursor: pointer; font-size: 16px;">
                            閉じる
                        </button>
                    </div>
                </div>
            `;
            
            showCustomModal(modalContent, 'batch-calendar-modal');
        }
        
        // バッチカレンダーモーダルを閉じる
        function closeBatchCalendarModal() {
            const modal = document.getElementById('batch-calendar-modal');
            if (modal) {
                modal.remove();
            }
        }

        // レッスンフォームリセット
        function resetLessonForm() {
            document.getElementById('lesson-content').value = '面接対策レッスン';
            document.getElementById('lesson-date').value = '';
            document.getElementById('lesson-duration').value = '45';
            document.getElementById('lesson-capacity').value = '999';
            document.getElementById('lesson-level').value = 'ALL';
            document.getElementById('lesson-online-link').value = '';
            document.getElementById('add-to-calendar').checked = true;
            
            // 時間帯選択をクリア
            document.querySelectorAll('#time-slots input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
                cb.closest('.time-slot').classList.remove('selected');
            });
            
            // バッチモードをリセット
            document.getElementById('batch-mode-toggle').checked = false;
            document.getElementById('batch-date-range').classList.add('hide');
            isBatchMode = false;
        }

        // 講師選択肢を更新
        function updateInstructorSelect() {
            // レッスン作成用の講師選択
            const select = document.getElementById('lesson-instructor');
            select.innerHTML = '<option value="">講師を選択してください</option>';
            
            instructors.forEach(instructor => {
                const option = document.createElement('option');
                option.value = instructor.id;
                option.textContent = instructor.name;
                select.appendChild(option);
            });
        }

        // 講師統計を計算
        function calculateInstructorStats(instructorId) {
            // その講師のレッスンを取得
            const instructorLessons = lessons.filter(l => l.instructorId === instructorId);
            
            // 参加者が1名以上のレッスンのみカウント
            const validLessons = instructorLessons.filter(lesson => {
                const lessonBookings = bookings.filter(b => b.lessonId === lesson.id);
                return lessonBookings.length > 0;
            });
            
            // 受講生からの講師への評価データを取得（ratings配列から）
            const studentToInstructorRatings = ratings.filter(r => {
                const lesson = lessons.find(l => l.id === r.lessonId);
                return lesson && lesson.instructorId === instructorId && r.rating > 0; // 不参加（0）除外
            });
            
            // 講師から受講生への評価データを取得（instructorRatings配列から）
            const instructorToStudentRatings = instructorRatings.filter(r => {
                const lesson = lessons.find(l => l.id === r.lessonId);
                return lesson && lesson.instructorId === instructorId && r.attitude !== '不参加'; // 不参加除外
            });
            
            // 受講生から講師への平均評価（講師平均評価）
            const avgInstructorRating = studentToInstructorRatings.length > 0 
                ? (studentToInstructorRatings.reduce((sum, r) => sum + r.rating, 0) / studentToInstructorRatings.length).toFixed(2)
                : 'なし';
            
            // 講師から受講生への平均評価（受講生平均評価） - 数値化が必要
            let avgStudentRating = 'なし';
            if (instructorToStudentRatings.length > 0) {
                // 態度を数値に変換
                const attitudeValues = instructorToStudentRatings.map(r => {
                    switch(r.attitude) {
                        case '良い': return 5;
                        case '普通': return 3;
                        case '改善が必要': return 2;
                        case '悪い': return 1;
                        default: return 3;
                    }
                });
                const avgValue = attitudeValues.reduce((sum, v) => sum + v, 0) / attitudeValues.length;
                avgStudentRating = avgValue.toFixed(2);
            }
            
            // 累計不参加人数（両方の評価系統から）
            const studentAbsent = ratings.filter(r => {
                const lesson = lessons.find(l => l.id === r.lessonId);
                return lesson && lesson.instructorId === instructorId && r.rating === 0;
            }).length;
            
            const instructorAbsent = instructorRatings.filter(r => {
                const lesson = lessons.find(l => l.id === r.lessonId);
                return lesson && lesson.instructorId === instructorId && r.attitude === '不参加';
            }).length;
            
            const totalAbsent = Math.max(studentAbsent, instructorAbsent); // 重複を避けるため最大値を取る
            
            return {
                lessonCount: validLessons.length,
                avgInstructorRating,
                avgStudentRating,
                totalAbsent
            };
        }
        
        // 講師一覧を更新
        function updateInstructorList() {
            const container = document.getElementById('instructor-list');
            container.innerHTML = '';
            
            instructors.forEach(instructor => {
                const stats = calculateInstructorStats(instructor.id);
                
                const card = document.createElement('div');
                card.className = 'lesson-card';
                card.innerHTML = `
                    <h4>${instructor.name}</h4>
                    <div class="lesson-info">
                        <span>レッスン回数: ${stats.lessonCount}回</span>
                        <span>講師平均評価: ${stats.avgInstructorRating}</span>
                        <span>受講生平均評価: ${stats.avgStudentRating}</span>
                        <span>累計不参加人数: ${stats.totalAbsent}名</span>
                    </div>
                    <button class="btn btn-danger" onclick="deleteInstructor('${instructor.id}')">削除</button>
                `;
                container.appendChild(card);
            });
        }

        // 作成済みレッスン一覧を更新
        function updateCreatedLessons() {
            const container = document.getElementById('created-lessons');
            if (!container) return;
            
            container.innerHTML = '';
            
            console.log('Lessons data:', lessons); // デバッグ用
            console.log('Lessons length:', lessons.length); // デバッグ用
            console.log('Current user:', currentUser); // デバッグ用
            console.log('Current user ID:', currentUserId); // デバッグ用
            
            // 講師の場合は自分のレッスンのみフィルタリング
            // 管理者(admin)の場合は全てのレッスンを表示
            let displayLessons = lessons;
            if (currentUser === 'instructor' && currentUserId && currentUserId !== 'admin') {
                displayLessons = lessons.filter(lesson => lesson.instructorId === currentUserId);
                console.log('Filtered lessons for instructor:', displayLessons); // デバッグ用
            }
            
            // 終了したレッスンを除外（現在時刻より過去のレッスン）
            const now = new Date();
            displayLessons = displayLessons.filter(lesson => {
                const lessonDateTime = new Date(`${lesson.date}T${lesson.time}`);
                const lessonEndTime = new Date(lessonDateTime.getTime() + lesson.duration * 60000); // duration分後
                return lessonEndTime > now; // レッスン終了時刻が現在時刻より未来
            });
            console.log('Display lessons:', displayLessons); // デバッグ用
            
            if (displayLessons.length === 0) {
                container.innerHTML = '<div class="lesson-card"><h4>作成済みレッスンがありません</h4><p>レッスンを作成してください。</p></div>';
                return;
            }
            
            const sortedLessons = displayLessons.sort((a, b) => {
                const dateA = new Date(`${a.date}T${a.time}`);
                const dateB = new Date(`${b.date}T${b.time}`);
                return dateA - dateB;
            });
            
            sortedLessons.forEach(lesson => {
                const bookedStudents = bookings.filter(b => b.lessonId === lesson.id);
                const card = document.createElement('div');
                card.className = 'lesson-card';
                card.innerHTML = `
                    <h4>${lesson.content}</h4>
                    <div class="lesson-info">
                        <span>日時: ${lesson.date} ${lesson.time}</span>
                        <span>講師: ${lesson.instructorName}</span>
                        <span>所要時間: ${lesson.duration}分</span>
                        <span>定員: ${lesson.capacity}名</span>
                        <span>レベル: ${lesson.level}</span>
                        <span>予約数: ${bookedStudents.length}/${lesson.capacity}</span>
                    </div>
                    ${lesson.onlineLink ? '<div><strong>オンラインリンク:</strong> <a href="' + lesson.onlineLink + '" target="_blank" style="color: white;">' + lesson.onlineLink + '</a></div>' : ''}
                    ${bookedStudents.length > 0 ? '<div class="student-list"><h5>予約済み受講生:</h5>' + bookedStudents.map(booking => {
                        const student = students.find(s => s.id === booking.studentId);
                        const rating = ratings.find(r => r.lessonId === lesson.id && r.studentId === booking.studentId);
                        return '<div class="student-item"><span>' + (student ? student.name : 'Unknown') + ' (' + (student ? student.level : 'N/A') + ')</span>' + 
                               (rating ? '<span class="rating-stars">' + '★'.repeat(rating.rating) + '☆'.repeat(5-rating.rating) + '</span>' : '') + '</div>';
                    }).join('') + '</div>' : ''}
                    <div class="lesson-actions" style="margin-top: 10px;">
                        <button class="btn btn-primary" onclick="editLesson('${lesson.id}')">編集</button>
                        <button class="btn btn-secondary" onclick="editLessonOnlineLink('${lesson.id}')">リンク編集</button>
                        <button class="btn btn-danger" onclick="deleteLesson('${lesson.id}')">削除</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // 予約可能レッスン一覧を更新（名称変更）
        function updateAvailableLessons() {
            const container = document.getElementById('available-lessons');
            container.innerHTML = '';
            
            const currentStudent = students.find(s => s.id === currentUserId);
            if (!currentStudent) {
                container.innerHTML = '<div class="lesson-card"><h4>ログインエラー</h4><p>受講生情報が見つかりません。再ログインしてください。</p></div>';
                return;
            }
            
            console.log('🔍 レッスン表示デバッグ:', {
                totalLessons: lessons.length,
                currentUserId: currentUserId,
                totalBookings: bookings.length
            });
            
            const availableLessons = lessons.filter(lesson => {
                // レベル制限を撤廃 - すべてのレベルのレッスンに参加可能（対象レベルは目安として表示）
                const lessonBookings = bookings.filter(b => b.lessonId === lesson.id);
                const currentBookedCount = lessonBookings.length;
                const hasCapacity = currentBookedCount < lesson.capacity;
                const notBooked = !bookings.find(b => b.lessonId === lesson.id && b.studentId === currentUserId);
                
                // 予約はレッスン開始時間まで可能、時間が過ぎたら不可
                const lessonDateTime = new Date(`${lesson.date}T${lesson.time}`);
                const now = new Date();
                const canBook = lessonDateTime.getTime() > now.getTime(); // 開始時間まで
                
                return hasCapacity && notBooked && canBook;
            });
            
            // 直近の日時から昇順でソート
            availableLessons.sort((a, b) => {
                const dateTimeA = new Date(`${a.date}T${a.time}`);
                const dateTimeB = new Date(`${b.date}T${b.time}`);
                return dateTimeA - dateTimeB;
            });
            
            availableLessons.forEach(lesson => {
                // 実際の予約数を計算
                const lessonBookings = bookings.filter(b => b.lessonId === lesson.id);
                const currentBookedCount = lessonBookings.length;
                
                const card = document.createElement('div');
                card.className = 'lesson-card';
                card.innerHTML = `
                    <h4>${lesson.content}</h4>
                    <div class="lesson-info">
                        <span>日時: ${lesson.date} ${lesson.time}</span>
                        <span>講師: ${lesson.instructorName}</span>
                        <span>所要時間: ${lesson.duration}分</span>
                        <span>定員: ${lesson.capacity}名</span>
                        <span>対象レベル（目安）: ${lesson.level}</span>
                        <span>空き: ${lesson.capacity - currentBookedCount}名</span>
                    </div>
                    <button class="btn" onclick="bookLesson('${lesson.id}')">予約する</button>
                `;
                container.appendChild(card);
            });
            
            if (availableLessons.length === 0) {
                container.innerHTML = `
                    <div class="lesson-card">
                        <h4>予約可能なレッスンがありません</h4>
                        <p>現在予約可能なレッスンはありません。</p>
                    </div>
                `;
            }
        }

        // 予約済みレッスン一覧を更新
        function updateBookedLessons() {
            const container = document.getElementById('booked-lessons');
            container.innerHTML = '';
            
            const userBookings = bookings.filter(b => b.studentId === currentUserId);
            
            // 未来のレッスンのみ表示
            const futureBookings = userBookings.filter(booking => {
                const lesson = lessons.find(l => l.id === booking.lessonId);
                if (!lesson) return false;
                const lessonDateTime = new Date(`${lesson.date}T${lesson.time}`);
                return lessonDateTime > new Date();
            });
            
            futureBookings.forEach(booking => {
                const lesson = lessons.find(l => l.id === booking.lessonId);
                if (!lesson) return;
                
                const lessonDateTime = new Date(`${lesson.date}T${lesson.time}`);
                const now = new Date();
                const canCancel = lessonDateTime.getTime() - now.getTime() > 30 * 60 * 1000; // 30分前
                
                const card = document.createElement('div');
                card.className = 'lesson-card';
                card.innerHTML = `
                    <h4>${lesson.content}</h4>
                    <div class="lesson-info">
                        <span>日時: ${lesson.date} ${lesson.time}</span>
                        <span>講師: ${lesson.instructorName}</span>
                        <span>対象レベル（目安）: ${lesson.level}</span>
                        <span>所要時間: ${lesson.duration}分</span>
                        <span>予約日時: ${new Date(booking.bookedAt).toLocaleString()}</span>
                    </div>
                    ${lesson.onlineLink ? `<div><strong>オンラインリンク:</strong> <a href="${lesson.onlineLink}" target="_blank" style="color: white;">参加する</a></div>` : ''}
                    <div style="margin-top: 10px;">
                        ${canCancel ? `<button class="btn btn-danger" onclick="cancelBooking('${booking.id}')">キャンセル</button>` : ''}

                    </div>
                `;
                container.appendChild(card);
            });

            if (futureBookings.length === 0) {
                container.innerHTML = '<div class="lesson-card"><h4>予約済みレッスンがありません</h4><p>まだレッスンを予約していません。</p></div>';
            }
        }

        // 受講済みレッスン一覧を更新（新規追加）
        function updateCompletedLessons() {
            const container = document.getElementById('completed-lessons');
            container.innerHTML = '';
            
            const userBookings = bookings.filter(b => b.studentId === currentUserId);
            
            // 過去のレッスンのみ表示
            const pastBookings = userBookings.filter(booking => {
                const lesson = lessons.find(l => l.id === booking.lessonId);
                if (!lesson) return false;
                const lessonDateTime = new Date(`${lesson.date}T${lesson.time}`);
                return lessonDateTime < new Date();
            });
            
            // 評価状況に基づいてソート（未評価を最上、評価済みを最下）
            pastBookings.sort((a, b) => {
                const ratingA = ratings.find(r => r.lessonId === a.lessonId && r.studentId === currentUserId);
                const ratingB = ratings.find(r => r.lessonId === b.lessonId && r.studentId === currentUserId);
                
                // 講師の不参加設定もチェック
                const instructorRatingA = instructorRatings.find(r => 
                    r.lessonId === a.lessonId && r.studentId === currentUserId
                );
                const instructorRatingB = instructorRatings.find(r => 
                    r.lessonId === b.lessonId && r.studentId === currentUserId
                );
                
                // 不参加レッスンは除外されるのでここでは考慮しない
                const hasRatingA = ratingA && (!instructorRatingA || instructorRatingA.attitude !== '不参加');
                const hasRatingB = ratingB && (!instructorRatingB || instructorRatingB.attitude !== '不参加');
                
                // 未評価（評価可能）を最上位に
                if (!hasRatingA && hasRatingB) return -1;
                if (hasRatingA && !hasRatingB) return 1;
                
                // 同じ評価状態の場合は古い順
                const lessonA = lessons.find(l => l.id === a.lessonId);
                const lessonB = lessons.find(l => l.id === b.lessonId);
                return new Date(`${lessonA.date}T${lessonA.time}`) - new Date(`${lessonB.date}T${lessonB.time}`);
            });
            
            pastBookings.forEach(booking => {
                const lesson = lessons.find(l => l.id === booking.lessonId);
                if (!lesson) return;
                
                const rating = ratings.find(r => r.lessonId === lesson.id && r.studentId === currentUserId);
                
                // 講師が不参加を設定したレッスンかチェック
                const instructorRating = instructorRatings.find(r => 
                    r.lessonId === lesson.id && r.studentId === currentUserId
                );
                
                // 講師が不参加を設定している場合は表示しない（完全無効化）
                if (instructorRating && instructorRating.attitude === '不参加') {
                    return;
                }
                

                
                const card = document.createElement('div');
                card.className = 'lesson-card';
                card.innerHTML = `
                    <h4>${lesson.content}</h4>
                    <div class="lesson-info">
                        <span>日時: ${lesson.date} ${lesson.time}</span>
                        <span>講師: ${lesson.instructorName}</span>
                        <span>所要時間: ${lesson.duration}分</span>
                        <span>受講日時: ${new Date(booking.bookedAt).toLocaleString()}</span>
                    </div>
                    ${rating ? `
                        <div class="rating-details">
                            <span class="rating-stars ${rating.rating > 0 && rating.rating <= 2.0 ? 'low-rating' : ''}">評価済み: ${'★'.repeat(rating.rating)}${'☆'.repeat(5-rating.rating)} (${rating.rating}/5)</span>
                            ${rating.comment ? `<div class="rating-comment"><p>"${rating.comment}"</p></div>` : ''}
                        </div>
                        <button class="btn btn-secondary" onclick="editRating('${lesson.id}', '${rating.id}')">評価を編集</button>
                    ` : `
                        <button class="btn btn-success" onclick="openRatingModal('${lesson.id}')">講師を評価する</button>
                    `}

                `;
                container.appendChild(card);
            });

            if (pastBookings.length === 0) {
                container.innerHTML = '<div class="lesson-card"><h4>受講済みレッスンがありません</h4><p>まだレッスンを受講していません。</p></div>';
            }
        }

        // 評価モーダルを開く
        function openRatingModal(lessonId) {
            // 編集モードをリセット
            editingRatingId = null;
            currentRatingLessonId = lessonId;
            selectedRating = null;
            document.getElementById('rating-comment').value = '';
            
            // モーダルのタイトルとボタンをリセット
            const modalTitle = document.querySelector('#rating-modal h3');
            if (modalTitle) {
                modalTitle.textContent = '講師を評価 (Rate Instructor)';
            }
            
            const submitBtn = document.querySelector('#rating-modal .btn');
            if (submitBtn) {
                submitBtn.textContent = '評価を送信 (Submit Rating)';
            }
            
            updateStarDisplay();
            document.getElementById('rating-modal').style.display = 'block';
        }

        // 評価モーダルを閉じる
        function closeRatingModal() {
            document.getElementById('rating-modal').style.display = 'none';
            currentRatingLessonId = null;
            selectedRating = null;
            editingRatingId = null; // 編集モードもリセット
        }

        // 評価を送信または更新
        let editingRatingId = null;

        function submitRating() {
            if (!currentRatingLessonId || selectedRating === null || selectedRating === undefined) {
                showAlert('評価を選択してください', 'error');
                return;
            }

            const comment = document.getElementById('rating-comment').value.trim();
            
            // ☆2以下（1-2）の評価時は理由記載を必須にする
            if (selectedRating >= 1 && selectedRating <= 2 && !comment) {
                showAlert('☆2以下の評価を付ける場合は、理由の記載が必須です', 'error');
                return;
            }
            
            if (editingRatingId) {
                // 既存評価を更新
                const existingRatingIndex = ratings.findIndex(r => r.id === editingRatingId);
                if (existingRatingIndex !== -1) {
                    ratings[existingRatingIndex].rating = selectedRating;
                    ratings[existingRatingIndex].comment = comment;
                    ratings[existingRatingIndex].ratedAt = new Date().toISOString(); // 更新日時を記録
                    showAlert('評価を更新しました', 'success');
                }
            } else {
                // 新規評価を追加
                const ratingObj = {
                    id: 'RATE' + (ratings.length + 1).toString().padStart(4, '0'),
                    lessonId: currentRatingLessonId,
                    studentId: currentUserId,
                    rating: selectedRating,
                    comment: comment,
                    ratedAt: new Date().toISOString()
                };
                ratings.push(ratingObj);
                showAlert('評価を送信しました', 'success');
            }
            
            saveData('ratings', ratings);
            
            closeRatingModal();
            updateCompletedLessons();
        }

        // 評価を編集
        function editRating(lessonId, ratingId) {
            const rating = ratings.find(r => r.id === ratingId);
            if (!rating) {
                showAlert('評価が見つかりません', 'error');
                return;
            }

            // 編集モードでモーダルを開く
            editingRatingId = ratingId;
            currentRatingLessonId = lessonId;
            selectedRating = rating.rating;
            
            // フォームに既存の値を設定
            document.getElementById('rating-comment').value = rating.comment || '';
            
            // 星評価を更新
            updateStarDisplay();
            
            // モーダルのタイトルを変更
            const modalTitle = document.querySelector('#rating-modal h3');
            if (modalTitle) {
                modalTitle.textContent = '評価を編集 (Edit Rating)';
            }
            
            // 送信ボタンのテキストを変更
            const submitBtn = document.querySelector('#rating-modal .btn');
            if (submitBtn) {
                submitBtn.textContent = '評価を更新 (Update Rating)';
            }
            
            document.getElementById('rating-modal').style.display = 'block';
        }

        // 受講者情報を更新
        function updateStudentInfo(student) {
            const studentInfoElement = document.getElementById('student-display-info');
            if (studentInfoElement && student) {
                studentInfoElement.textContent = `${student.id} - ${student.name}`;
            }
        }

        // レッスン予約
        function bookLesson(lessonId) {
            const lesson = lessons.find(l => l.id === lessonId);
            if (!lesson) return;
            
            // 時間チェック：開始時間まで予約可能、時間が過ぎたら予約不可
            const lessonDateTime = new Date(`${lesson.date}T${lesson.time}`);
            const now = new Date();
            
            if (lessonDateTime.getTime() <= now.getTime()) {
                showAlert('レッスン開始時間を過ぎているため予約できません', 'error');
                return;
            }
            
            if (lesson.bookedCount >= lesson.capacity) {
                showAlert('このレッスンは満席です', 'error');
                return;
            }
            
            const currentStudent = students.find(s => s.id === currentUserId);
            const booking = {
                id: 'BOOK' + (bookings.length + 1).toString().padStart(4, '0'),
                lessonId: lessonId,
                studentId: currentUserId,
                studentName: currentStudent ? currentStudent.name : 'Unknown Student',
                bookedAt: new Date().toISOString()
            };
            
            bookings.push(booking);
            lesson.bookedCount++;
            
            saveData('bookings', bookings);
            saveData('lessons', lessons);
            
            updateAvailableLessons();
            updateBookedLessons();
            showAlert('レッスンを予約しました', 'success');
        }

        // 予約キャンセル
        function cancelBooking(bookingId) {
            const bookingIndex = bookings.findIndex(b => b.id === bookingId);
            if (bookingIndex === -1) return;
            
            const booking = bookings[bookingIndex];
            const lesson = lessons.find(l => l.id === booking.lessonId);
            
            if (lesson) {
                lesson.bookedCount--;
            }
            
            bookings.splice(bookingIndex, 1);
            
            saveData('bookings', bookings);
            saveData('lessons', lessons);
            
            updateAvailableLessons();
            updateBookedLessons();
            showAlert('予約をキャンセルしました', 'success');
        }

        // オンラインリンク編集
        function editLessonOnlineLink(lessonId) {
            const lesson = lessons.find(l => l.id === lessonId);
            if (!lesson) return;
            
            const newLink = prompt('オンラインリンクを入力してください:', lesson.onlineLink || '');
            if (newLink !== null) {
                lesson.onlineLink = newLink;
                saveData('lessons', lessons);
                updateCreatedLessons();
                showAlert('オンラインリンクを更新しました', 'success');
            }
        }

        // 星評価表示用ヘルパー関数
        function formatStarRating(rating) {
            if (rating === null || rating === undefined) {
                return '<span class="rating-stars no-rating">未評価</span>';
            }
            
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            
            let starsHtml = '★'.repeat(fullStars);
            if (hasHalfStar) starsHtml += '☆';
            starsHtml += '☆'.repeat(emptyStars);
            
            const isLowRating = rating <= 2.0;
            const ratingClass = isLowRating ? 'rating-stars low-rating' : 'rating-stars';
            
            return `<span class="${ratingClass}">${starsHtml} (${rating.toFixed(2)}/5)</span>`;
        }
        
        // 管理画面専用：数値のみ表示する関数
        function formatSimpleRating(rating) {
            if (rating === null || rating === undefined) {
                return '<span class="rating-stars no-rating">未評価</span>';
            }
            
            const isLowRating = rating <= 2.0;
            const ratingClass = isLowRating ? 'rating-stars low-rating' : 'rating-stars';
            
            return `<span class="${ratingClass}">${rating.toFixed(2)}/5</span>`;
        }
        
        // 低評価受講生一覧専用：星マーク付き整数表示する関数（赤色背景付き）
        function formatPoorStudentRating(rating) {
            if (rating === null || rating === undefined) {
                return '<span class="rating-stars no-rating">未評価</span>';
            }
            
            const roundedRating = Math.round(rating);
            const fullStars = roundedRating;
            const emptyStars = 5 - fullStars;
            
            let starsHtml = '★'.repeat(fullStars);
            starsHtml += '☆'.repeat(emptyStars);
            
            // 低評価なので赤色背景を適用
            return `<span class="poor-rating">講師評価: ${starsHtml} (${roundedRating}/5)</span>`;
        }
        
        // 受講態度を点数に変換する関数
        function getAttitudeScore(attitude) {
            switch(attitude) {
                case '非常に良い': return 5;
                case '良い': return 4;
                case '普通': return 3;
                case '改善が必要': return 2;
                case '悪い': return 1;
                case '不参加': return 0;
                default: return 3;
            }
        }

        // 講師評価の平均を計算する関数
        function calculateInstructorAverageRating() {
            // 0点（不参加）を除外して平均計算
            const validRatings = ratings.filter(r => r.rating > 0);
            if (validRatings.length === 0) return null;
            
            const totalRating = validRatings.reduce((sum, r) => sum + r.rating, 0);
            return totalRating / validRatings.length;
        }

        // 講師から受講生への平均評価計算（不参加除外）
        function calculateStudentAverageAttitude() {
            const validRatings = instructorRatings.filter(rating => rating.attitude !== '不参加');
            if (validRatings.length === 0) return null;
            
            const totalScore = validRatings.reduce((sum, rating) => {
                return sum + attitudeToScore(rating.attitude);
            }, 0);
            
            return totalScore / validRatings.length;
        }

        // 全画面を強制更新する関数
        function refreshAllScreens() {
            console.log('🔄 全画面更新を開始...');
            
            try {
                // データ再読み込み（LocalStorageから最新状態を取得）
                loadDataFromStorage();
                
                // 受講生画面（評価ボタン表示の更新）
                if (typeof updateCompletedLessons === 'function') {
                    updateCompletedLessons();
                }
                if (typeof updateAvailableLessons === 'function') {
                    updateAvailableLessons();
                }
                
                // 講師画面
                if (typeof updateCompletedStudentsList === 'function') {
                    updateCompletedStudentsList();
                }
                
                // コーディネーター画面
                if (typeof updateCoordinatorDashboard === 'function') {
                    updateCoordinatorDashboard();
                }
                if (typeof updateAllStudentsList === 'function') {
                    updateAllStudentsList();
                    
                    // 強制的にDOM更新を確実にする
                    setTimeout(() => {
                        // 受講生一覧の強制更新
                        updateAllStudentsList();
                        
                        const container = document.getElementById('all-students-list');
                        if (container) {
                            // 強制リフロー
                            container.style.display = 'none';
                            container.offsetHeight;
                            container.style.display = '';
                            
                            // さらに確実にするため、もう一度更新
                            setTimeout(() => {
                                updateAllStudentsList();
                            }, 50);
                        }
                    }, 100);
                }
                if (typeof updatePoorAttitudeStudents === 'function') {
                    updatePoorAttitudeStudents();
                }
                
                // 管理者画面
                if (typeof updateAllEvaluations === 'function') {
                    updateAllEvaluations();
                }
                if (typeof updateSystemOverview === 'function') {
                    updateSystemOverview();
                }
                if (typeof updateAdminPoorRatings === 'function') {
                    updateAdminPoorRatings();
                }
                
                console.log('✅ 全画面更新完了');
            } catch (error) {
                console.error('❌ 画面更新エラー:', error);
            }
        }

        // データ再読み込み関数
        function loadDataFromStorage() {
            try {
                // LocalStorageから最新データを読み込み
                const storedRatings = localStorage.getItem('ratings');
                const storedInstructorRatings = localStorage.getItem('instructorRatings');
                const storedStudents = localStorage.getItem('students');
                const storedLessons = localStorage.getItem('lessons');
                const storedBookings = localStorage.getItem('bookings');
                const storedInstructors = localStorage.getItem('instructors');
                
                if (storedRatings) ratings = JSON.parse(storedRatings);
                if (storedInstructorRatings) instructorRatings = JSON.parse(storedInstructorRatings);
                if (storedStudents) students = JSON.parse(storedStudents);
                if (storedLessons) lessons = JSON.parse(storedLessons);
                if (storedBookings) bookings = JSON.parse(storedBookings);
                if (storedInstructors) instructors = JSON.parse(storedInstructors);
                
                console.log('データ再読み込み完了:', {
                    ratings: ratings.length,
                    instructorRatings: instructorRatings.length,
                    students: students.length,
                    lessons: lessons.length
                });
            } catch (error) {
                console.error('❌ データ再読み込みエラー:', error);
            }
        }

        // 受講態度を数値に変換する関数
        function attitudeToScore(attitude) {
            const scoreMap = {
                '非常に良い': 5,
                '良い': 4,
                '普通': 3,
                '改善が必要': 2,
                '悪い': 1,
                '不参加': 0 // 不参加は0点
            };
            
            const result = scoreMap[attitude];
            

            
            return result !== undefined ? result : 3; // デフォルトは3点(普通)
        }

        // 数値を受講態度に変換する関数
        function scoreToAttitude(score) {
            const attitudeMap = {
                5: '非常に良い',
                4: '良い',
                3: '普通',
                2: '改善が必要',
                1: '悪い',
                0: '不参加' // 0点は不参加
            };
            return attitudeMap[score] || '普通';
        }

        // 受講態度の色を取得する関数
        function getAttitudeColor(attitude) {
            const score = attitudeToScore(attitude);
            if (score >= 5) return '#22c55e'; // 緑
            if (score >= 4) return '#3b82f6'; // 青
            if (score >= 3) return '#f59e0b'; // 黄
            if (score >= 2) return '#f97316'; // オレンジ
            return '#ef4444'; // 赤
        }

        // 受講態度を視覚的に表示する関数
        function formatAttitudeDisplay(attitude) {
            // 不参加の場合は評価無しとして表示
            if (attitude === '不参加') {
                return `<span class="attitude-score attitude-absent">${attitude} (評価無し)</span>`;
            }
            
            const score = attitudeToScore(attitude);
            let className = '';
            
            switch(score) {
                case 5: className = 'attitude-excellent'; break;
                case 4: className = 'attitude-good'; break;
                case 3: className = 'attitude-average'; break;
                case 2: className = 'attitude-poor'; break;
                case 1: className = 'attitude-bad'; break;
                default: 
                    className = 'attitude-average';
            }
            
            return `<span class="attitude-score ${className}">${attitude} (${score}/5)</span>`;
        }

        // データ整合性チェックとクリーンアップ関数
        function cleanupOrphanedData() {
            console.log('データ整合性チェックを実行中...');
            
            const existingLessonIds = lessons.map(l => l.id);
            const existingStudentIds = students.map(s => s.id);
            
            // 存在しないレッスンに紐づいた予約を削除
            const originalBookingsCount = bookings.length;
            bookings = bookings.filter(b => 
                existingLessonIds.includes(b.lessonId) && existingStudentIds.includes(b.studentId)
            );
            
            // 存在しないレッスンに紐づいた評価を削除（受講生から講師へ）
            const originalRatingsCount = ratings.length;
            ratings = ratings.filter(r => 
                existingLessonIds.includes(r.lessonId) && existingStudentIds.includes(r.studentId)
            );
            
            // 存在しないレッスンに紐づいた評価を削除（講師から受講生へ）
            const originalInstructorRatingsCount = instructorRatings.length;
            instructorRatings = instructorRatings.filter(r => 
                existingLessonIds.includes(r.lessonId) && existingStudentIds.includes(r.studentId)
            );
            
            // データを保存
            saveData('bookings', bookings);
            saveData('ratings', ratings);
            saveData('instructorRatings', instructorRatings);
            
            const removedBookings = originalBookingsCount - bookings.length;
            const removedRatings = originalRatingsCount - ratings.length;
            const removedInstructorRatings = originalInstructorRatingsCount - instructorRatings.length;
            
            if (removedBookings > 0 || removedRatings > 0 || removedInstructorRatings > 0) {
                console.log(`データクリーンアップ完了: 予約${removedBookings}件, 評価${removedRatings}件, 講師評価${removedInstructorRatings}件を削除しました。`);
                return true; // データが削除された
            } else {
                console.log('データ整合性に問題はありません。');
                return false; // データは整合性が取れている
            }
        }

        // 手動データクリーンアップ関数
        function manualDataCleanup() {
            const dataWasCleaned = cleanupOrphanedData();
            
            if (dataWasCleaned) {
                // 統計情報を更新
                updateCoordinatorDashboard();
                updateAllEvaluations();
                updateSystemOverview();
                
                showAlert('データクリーンアップが完了しました。古いデータが削除され、統計情報が更新されました。', 'success');
            } else {
                showAlert('データ整合性に問題はありません。クリーンアップの必要はありません。', 'info');
            }
        }

        // 受講生担当ダッシュボード更新
        function updateCoordinatorDashboard() {
            // 担当者のフィルタリング処理
            const coordinator = coordinators.find(c => c.id === currentCoordinatorId);
            const isTestAccount = coordinator && coordinator.isTestAccount;
            
            // 担当受講生のフィルタリング（coordは全員表示）
            const filteredStudents = isTestAccount ? 
                students : 
                students.filter(s => s.coordinatorId === currentCoordinatorId);
            
            // 統計情報更新
            document.getElementById('total-students').textContent = filteredStudents.length;
            
            // 受講済み人数計算（実際に受講したレッスンがある受講生の数）
            const studentsWithValidRatings = filteredStudents.filter(student => {
                return ratings.some(rating => rating.studentId === student.id && rating.rating > 0);
            });
            document.getElementById('attended-students').textContent = studentsWithValidRatings.length;
            
            // 受講率計算（実際に受講した受講生の割合）
            const attendanceRate = filteredStudents.length > 0 ? 
                ((studentsWithValidRatings.length / filteredStudents.length) * 100).toFixed(2) : '0.00';
            document.getElementById('lesson-attendance-rate').textContent = `${attendanceRate}%`;
            
            // 平均受講態度計算（不参加を除外、担当受講生のみ）
            const filteredStudentIds = filteredStudents.map(s => s.id);
            const validInstructorRatings = instructorRatings.filter(rating => 
                rating.attitude !== '不参加' && filteredStudentIds.includes(rating.studentId)
            );
            let avgAttitudeDisplay = '未評価';
            
            if (validInstructorRatings.length > 0) {
                const totalAttitudeScore = validInstructorRatings.reduce((sum, rating) => {
                    return sum + attitudeToScore(rating.attitude);
                }, 0);
                const avgAttitudeScore = totalAttitudeScore / validInstructorRatings.length;
                const avgAttitude = scoreToAttitude(Math.round(avgAttitudeScore));
                // 数値表示形式に変更（色付きなし）
                avgAttitudeDisplay = `${avgAttitude} (${avgAttitudeScore.toFixed(1)}/5)`;
            }
            
            // 受講生の平均態度を表示
            const avgRatingElement = document.getElementById('avg-rating');
            avgRatingElement.innerHTML = avgAttitudeDisplay;
            
            // 低評価受講生一覧更新
            updatePoorAttitudeStudents();
            
            // 全受講生一覧
            updateAllStudentsList();
            
            // 全レッスン一覧
            updateAllLessonsList();
        }

        // 全受講生一覧更新
        function updateAllStudentsList() {
            const container = document.getElementById('all-students-list');
            container.innerHTML = '';
            
            // 担当者のフィルタリング処理
            const coordinator = coordinators.find(c => c.id === currentCoordinatorId);
            const isTestAccount = coordinator && coordinator.isTestAccount;
            
            // 担当受講生のフィルタリング（coordは全員表示）
            const filteredStudents = isTestAccount ? 
                students : 
                students.filter(s => s.coordinatorId === currentCoordinatorId);
            
            // 未受講と受講済みで分類
            const unattendedStudents = [];
            const attendedStudents = [];
            
            filteredStudents.forEach(student => {
                const studentBookings = bookings.filter(b => b.studentId === student.id);
                const studentRatings = ratings.filter(r => r.studentId === student.id);
                
                // 受講済み判定（不参加を除く実際の受講）
                const validRatings = studentRatings.filter(r => r.rating > 0);
                const hasAttended = validRatings.length > 0;
                
                // 平均評価計算（0点=不参加を除外）
                const avgRatingNum = validRatings.length > 0 ? 
                    (validRatings.reduce((sum, r) => sum + r.rating, 0) / validRatings.length) : 0;
                const avgRatingDisplay = avgRatingNum > 0 ? avgRatingNum.toFixed(2) : 'なし';
                
                // 欠席回数を計算（講師評価の不参加から算出）
                const instructorAbsenceRatings = instructorRatings.filter(r => 
                    r.studentId === student.id && r.attitude === '不参加'
                );
                const absenceCount = instructorAbsenceRatings.length;
                const isHighAbsence = absenceCount >= 2;
                
                // 低評価判定（2.0以下）
                const isLowRating = avgRatingNum > 0 && avgRatingNum <= 2.0;
                
                const studentData = {
                    student,
                    studentBookings,
                    avgRatingDisplay,
                    absenceCount,
                    isHighAbsence,
                    isLowRating,
                    validRatings
                };
                
                if (hasAttended) {
                    attendedStudents.push(studentData);
                } else {
                    unattendedStudents.push(studentData);
                }
            });
            
            // 未受講の受講生表示
            const unattendedSection = document.createElement('div');
            unattendedSection.innerHTML = `<h3>未受講の受講生 (${unattendedStudents.length}名)</h3>`;
            container.appendChild(unattendedSection);
            
            unattendedStudents.forEach(({student, studentBookings, avgRatingDisplay, absenceCount, isHighAbsence, isLowRating}) => {
                const card = document.createElement('div');
                card.className = 'lesson-card';
                card.innerHTML = `
                    <h4>${student.id}：${student.name}</h4>
                    <div class="lesson-info">
                        <span>レベル: ${student.level || '<span style="color: #999;">未設定</span>'}</span>
                        <span>予約数: ${studentBookings.length}</span>
                        <span class="${isLowRating ? 'low-rating' : ''}">平均評価: ${avgRatingDisplay}</span>
                        <span class="${isHighAbsence ? 'high-absence' : ''}">欠席回数: ${absenceCount}回</span>
                        <span>登録日: ${new Date(student.createdAt).toLocaleDateString()}</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="editStudentCoordinator('${student.id}')">
                            編集
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
            
            // 受講済みの受講生（トグル）
            if (attendedStudents.length > 0) {
                const attendedToggle = document.createElement('div');
                attendedToggle.style.marginTop = '30px';
                attendedToggle.innerHTML = `
                    <button id="toggle-attended-students" class="btn btn-secondary" onclick="toggleAttendedStudents()" style="font-size: 14px; margin-bottom: 15px;">
                        受講済みの受講生を表示 (${attendedStudents.length}名)
                    </button>
                `;
                container.appendChild(attendedToggle);
                
                const attendedSection = document.createElement('div');
                attendedSection.id = 'attended-students-section';
                attendedSection.style.display = 'none';
                
                attendedStudents.forEach(({student, studentBookings, avgRatingDisplay, absenceCount, isHighAbsence, isLowRating}) => {
                    const card = document.createElement('div');
                    card.className = 'lesson-card';
                    card.innerHTML = `
                        <h4>${student.id}：${student.name}</h4>
                        <div class="lesson-info">
                            <span>レベル: ${student.level || '<span style="color: #999;">未設定</span>'}</span>
                            <span>予約数: ${studentBookings.length}</span>
                            <span class="${isLowRating ? 'low-rating' : ''}">平均評価: ${avgRatingDisplay}</span>
                            <span class="${isHighAbsence ? 'high-absence' : ''}">欠席回数: ${absenceCount}回</span>
                            <span>登録日: ${new Date(student.createdAt).toLocaleDateString()}</span>
                        </div>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-primary" onclick="editStudentCoordinator('${student.id}')">
                                編集
                            </button>
                        </div>
                    `;
                    attendedSection.appendChild(card);
                });
                
                container.appendChild(attendedSection);
            }
        }
        
        // 受講済み受講生の表示/非表示トグル
        function toggleAttendedStudents() {
            const attendedSection = document.getElementById('attended-students-section');
            const toggleBtn = document.getElementById('toggle-attended-students');
            
            if (attendedSection.style.display === 'none') {
                attendedSection.style.display = 'block';
                toggleBtn.textContent = toggleBtn.textContent.replace('表示', '非表示');
            } else {
                attendedSection.style.display = 'none';
                toggleBtn.textContent = toggleBtn.textContent.replace('非表示', '表示');
            }
        }

        // 低評価受講生一覧更新
        function updatePoorAttitudeStudents() {
            const container = document.getElementById('poor-attitude-students');
            container.innerHTML = '';
            
            // 担当者のフィルタリング処理
            const coordinator = coordinators.find(c => c.id === currentCoordinatorId);
            const isTestAccount = coordinator && coordinator.isTestAccount;
            
            // 担当受講生のフィルタリング（coordは全員表示）
            const filteredStudents = isTestAccount ? 
                students : 
                students.filter(s => s.coordinatorId === currentCoordinatorId);
            const filteredStudentIds = filteredStudents.map(s => s.id);
            
            // 1. 講師評価で受講態度が低い（2点以下）受講生を抽出（担当者フィルタリング適用）
            const poorAttitudeStudents = instructorRatings.filter(rating => 
                (rating.attitude === '悪い' || rating.attitude === '改善が必要') &&
                filteredStudentIds.includes(rating.studentId)
            );
            
            // 2. 受講生からの評価で平均が2星以下の受講生を抽出（担当者フィルタリング適用）
            const studentAvgRatings = {};
            ratings.forEach(rating => {
                // 担当受講生のみ
                if (!filteredStudentIds.includes(rating.studentId)) return;
                
                if (!studentAvgRatings[rating.studentId]) {
                    studentAvgRatings[rating.studentId] = [];
                }
                studentAvgRatings[rating.studentId].push(rating.rating);
            });
            
            const lowRatedStudents = [];
            Object.keys(studentAvgRatings).forEach(studentId => {
                const studentRatings = studentAvgRatings[studentId];
                const avgRating = studentRatings.reduce((sum, r) => sum + r, 0) / studentRatings.length;
                if (avgRating <= 2.0) {
                    lowRatedStudents.push({
                        studentId: studentId,
                        avgRating: avgRating,
                        type: 'low_rating'
                    });
                }
            });
            
            // 統合された問題のある受講生リスト
            const allProblemStudents = new Set();
            
            // 受講態度の問題がある受講生を追加
            const attitudeGroups = {};
            poorAttitudeStudents.forEach(rating => {
                if (!attitudeGroups[rating.studentId]) {
                    attitudeGroups[rating.studentId] = [];
                }
                attitudeGroups[rating.studentId].push(rating);
                allProblemStudents.add(rating.studentId);
            });
            
            // 低評価の受講生を追加
            lowRatedStudents.forEach(item => {
                allProblemStudents.add(item.studentId);
            });
            
            if (allProblemStudents.size === 0) {
                container.innerHTML = '<div class="lesson-card"><h4>該当する受講生はいません</h4><p>問題のある受講生はいません。</p></div>';
                return;
            }
            
            // 各問題受講生の情報を表示
            Array.from(allProblemStudents).forEach(studentId => {
                const student = students.find(s => s.id === studentId);
                if (!student) return;
                
                const attitudeRatings = attitudeGroups[studentId] || [];
                const lowRatingInfo = lowRatedStudents.find(item => item.studentId === studentId);
                
                const card = document.createElement('div');
                card.className = 'lesson-card poor-attitude-card';
                
                let problemTypes = [];
                let detailsHtml = '';
                
                // 受講態度の問題
                if (attitudeRatings.length > 0) {
                    const mostRecentAttitude = attitudeRatings.sort((a, b) => 
                        new Date(b.ratedAt) - new Date(a.ratedAt)
                    )[0];
                    problemTypes.push('受講態度');
                    
                    // 受講態度を点数付きで表示し、赤色背景を適用
                    const attitudeScore = getAttitudeScore(mostRecentAttitude.attitude);
                    detailsHtml += `
                        <span class="poor-rating">受講態度: ${mostRecentAttitude.attitude} (${attitudeScore}/5)</span>
                        <span>態度評価日: ${new Date(mostRecentAttitude.ratedAt).toLocaleDateString()}</span>
                        <span>問題発生回数: ${attitudeRatings.length}回</span>
                    `;
                    if (mostRecentAttitude.notes) {
                        detailsHtml += `<div class="rating-comment"><p>備考: "${mostRecentAttitude.notes}"</p></div>`;
                    }
                }
                
                // 低評価の問題
                if (lowRatingInfo) {
                    problemTypes.push('講師低評価');
                    detailsHtml += `
                        ${formatPoorStudentRating(lowRatingInfo.avgRating)}
                        <span>評価回数: ${studentAvgRatings[studentId].length}回</span>
                    `;
                }
                
                card.innerHTML = `
                    <h4>${student.name} (${student.id})</h4>
                    <div class="problem-types">問題: ${problemTypes.join('・')}</div>
                    <div class="lesson-info">
                        <span>レベル: ${student.level || '<span style="color: #999;">未設定</span>'}</span>
                        ${detailsHtml}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // 全レッスン一覧更新（現在・過去分離）
        function updateAllLessonsList() {
            const currentContainer = document.getElementById('all-lessons-list');
            const pastContainer = document.getElementById('past-lessons-content');
            currentContainer.innerHTML = '';
            pastContainer.innerHTML = '';
            
            const now = new Date();
            
            // 担当者のフィルタリング処理
            const coordinator = coordinators.find(c => c.id === currentCoordinatorId);
            const isTestAccount = coordinator && coordinator.isTestAccount;
            
            // 担当受講生のフィルタリング（coordは全員表示）
            const filteredStudents = isTestAccount ? 
                students : 
                students.filter(s => s.coordinatorId === currentCoordinatorId);
            const filteredStudentIds = filteredStudents.map(s => s.id);
            
            // レッスンを現在・過去で分類（担当受講生が予約しているレッスンのみ）
            const currentLessons = [];
            const pastLessons = [];
            
            lessons.forEach(lesson => {
                // テストアカウントでない場合のみフィルタリング
                if (!isTestAccount) {
                    // 担当受講生の予約があるかチェック
                    const hasAssignedStudentBooking = bookings.some(b => 
                        b.lessonId === lesson.id && filteredStudentIds.includes(b.studentId)
                    );
                    
                    // 担当受講生が予約していないレッスンはスキップ
                    if (!hasAssignedStudentBooking) {
                        return;
                    }
                }
                
                const lessonDate = new Date(`${lesson.date}T${lesson.time}`);
                const lessonEndTime = new Date(lessonDate.getTime() + 60 * 60 * 1000); // 開始時間から1時間後
                
                if (lessonEndTime > now) {
                    currentLessons.push(lesson);
                } else {
                    pastLessons.push(lesson);
                }
            });
            
            // 現在レッスン（直近順 - 近い日時から表示）
            currentLessons.sort((a, b) => {
                const dateA = new Date(`${a.date}T${a.time}`);
                const dateB = new Date(`${b.date}T${b.time}`);
                return dateA - dateB; // 昇順：直近のレッスンが上に表示
            });
            
            // 過去レッスン（新しい順）
            pastLessons.sort((a, b) => {
                const dateA = new Date(`${a.date}T${a.time}`);
                const dateB = new Date(`${b.date}T${b.time}`);
                return dateB - dateA;
            });
            
            // 現在レッスンを表示
            currentLessons.forEach(lesson => {
                const card = createLessonCard(lesson);
                currentContainer.appendChild(card);
            });
            
            // 過去レッスンを表示
            pastLessons.forEach(lesson => {
                const card = createLessonCard(lesson);
                pastContainer.appendChild(card);
            });
        }
        
        // レッスンカード作成関数
        function createLessonCard(lesson) {
            const lessonBookings = bookings.filter(b => b.lessonId === lesson.id);
            
            const card = document.createElement('div');
            card.className = 'lesson-card';
            card.innerHTML = `
                <h4>${lesson.content}</h4>
                <div class="lesson-info">
                    <span>日時: ${lesson.date} ${lesson.time}</span>
                    <span>講師: ${lesson.instructorName}</span>
                    <span>予約数: ${lessonBookings.length}/${lesson.capacity}</span>
                    <button class="btn btn-primary btn-sm" onclick="showLessonDetail('${lesson.id}')" style="margin-left: 10px;">
                        レッスン詳細を見る
                    </button>
                </div>
                ${lessonBookings.length > 0 ? `
                    <div class="student-list">
                        <h5>予約済み受講生:</h5>
                        ${lessonBookings.map(booking => {
                            const student = students.find(s => s.id === booking.studentId);
                            const studentName = booking.studentName || (student ? student.name : 'Unknown');
                            return `<div class="student-item"><span>${booking.studentId}：${studentName}</span></div>`;
                        }).join('')}
                    </div>
                ` : ''}
            `;
            return card;
        }
        
        // レッスン詳細表示
        function showLessonDetail(lessonId) {
            const lesson = lessons.find(l => l.id === lessonId);
            if (!lesson) return;
            
            const lessonBookings = bookings.filter(b => b.lessonId === lessonId);
            const lessonRatings = ratings.filter(r => r.lessonId === lessonId);
            const avgRating = lessonRatings.length > 0 ? 
                (lessonRatings.reduce((sum, r) => sum + r.rating, 0) / lessonRatings.length).toFixed(2) : 'なし';
            
            const modalContent = `
                <div class="modal-header">
                    <h3>レッスン詳細</h3>
                    <button onclick="closeModal()" class="close-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="lesson-detail-info">
                        <h4>${lesson.content}</h4>
                        <div class="info-grid">
                            <div><strong>日時:</strong> ${lesson.date} ${lesson.time}</div>
                            <div><strong>講師:</strong> ${lesson.instructorName}</div>
                            <div><strong>レベル:</strong> ${lesson.level}</div>
                            <div><strong>定員:</strong> ${lesson.capacity}名</div>
                            <div><strong>予約数:</strong> ${lessonBookings.length}名</div>
                            <div><strong>平均評価:</strong> ${avgRating}</div>
                            ${lesson.onlineLink ? `<div><strong>オンラインリンク:</strong> <a href="${lesson.onlineLink}" target="_blank">${lesson.onlineLink}</a></div>` : ''}
                        </div>
                        
                        ${lessonBookings.length > 0 ? `
                            <div class="booking-details">
                                <h5>予約済み受講生 (${lessonBookings.length}名)</h5>
                                <div class="student-list-detail">
                                    ${lessonBookings.map(booking => {
                                        const student = students.find(s => s.id === booking.studentId);
                                        const studentName = booking.studentName || (student ? student.name : 'Unknown');
                                        const studentRating = lessonRatings.find(r => r.studentId === booking.studentId);
                                        return `
                                            <div class="student-detail-item">
                                                <span>${booking.studentId}：${studentName}</span>
                                                ${studentRating ? `<span class="rating">評価: ${'★'.repeat(studentRating.rating)}${'☆'.repeat(5 - studentRating.rating)}</span>` : '<span class="no-rating">評価なし</span>'}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : '<p>まだ予約がありません。</p>'}
                        
                        ${lessonRatings.length > 0 ? `
                            <div class="ratings-summary">
                                <h5>評価詳細 (${lessonRatings.length}件)</h5>
                                <div class="ratings-detail">
                                    ${lessonRatings.map(rating => {
                                        const student = students.find(s => s.id === rating.studentId);
                                        const studentName = student ? student.name : 'Unknown';
                                        return `
                                            <div class="rating-item">
                                                <div><strong>${studentName}:</strong> ${'★'.repeat(rating.rating)}${'☆'.repeat(5 - rating.rating)}</div>
                                                ${rating.comment ? `<div class="comment">${rating.comment}</div>` : ''}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            showModal(modalContent);
        }
        
        // 終了レッスンの表示/非表示トグル
        function togglePastLessons() {
            const pastLessonsDiv = document.getElementById('past-lessons-list');
            const toggleBtn = document.getElementById('toggle-past-lessons');
            
            if (pastLessonsDiv.style.display === 'none') {
                pastLessonsDiv.style.display = 'block';
                toggleBtn.textContent = '終了レッスンを非表示';
            } else {
                pastLessonsDiv.style.display = 'none';
                toggleBtn.textContent = '終了レッスンを表示';
            }
        }

        // 受講生評価の表示/非表示トグル
        function toggleStudentRatings() {
            const ratingsSection = document.getElementById('student-ratings-section');
            const toggleBtn = document.getElementById('toggle-student-ratings');
            
            if (ratingsSection.style.display === 'none') {
                ratingsSection.style.display = 'block';
                toggleBtn.textContent = '受講生から講師への評価を非表示';
            } else {
                ratingsSection.style.display = 'none';
                toggleBtn.textContent = '受講生から講師への評価を表示';
            }
        }
        
        // 受講生評価一覧のトグル  
        function toggleStudentRatingsList() {
            const ratingsSection = document.getElementById('student-ratings-list-section');
            const toggleBtn = document.getElementById('toggle-student-ratings-list');
            
            if (ratingsSection.style.display === 'none') {
                ratingsSection.style.display = 'block';
                toggleBtn.textContent = '受講生から講師への評価一覧を非表示';
            } else {
                ratingsSection.style.display = 'none';
                toggleBtn.textContent = '受講生から講師への評価一覧を表示';
            }
        }

        // 講師評価の表示/非表示トグル
        function toggleInstructorRatings() {
            const ratingsSection = document.getElementById('instructor-ratings-section');
            const toggleBtn = document.getElementById('toggle-instructor-ratings');
            
            if (ratingsSection.style.display === 'none') {
                ratingsSection.style.display = 'block';
                toggleBtn.textContent = '講師から受講生への評価を非表示';
            } else {
                ratingsSection.style.display = 'none';
                toggleBtn.textContent = '講師から受講生への評価を表示';
            }
        }

        // カレンダー更新
        function updateCalendar() {
            const monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
            document.getElementById('current-month').textContent = `${currentYear}年${monthNames[currentMonth]}`;
            
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            // 曜日ヘッダー
            const dayHeaders = ['日', '月', '火', '水', '木', '金', '土'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.textContent = day;
                header.style.fontWeight = 'bold';
                header.style.textAlign = 'center';
                header.style.padding = '10px';
                header.style.background = 'rgba(102, 126, 234, 0.8)';
                header.style.color = 'white';
                header.style.borderRadius = '5px';
                grid.appendChild(header);
            });
            
            // カレンダー日付
            const firstDay = new Date(currentYear, currentMonth, 1);
            const startDate = new Date(firstDay);
            startDate.setDate(1 - firstDay.getDay()); // 月の最初の日の曜日分だけ前に戻る
            
            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                // 日付表示
                const dateDiv = document.createElement('div');
                dateDiv.className = 'calendar-date';
                dateDiv.textContent = currentDate.getDate();
                dayElement.appendChild(dateDiv);
                
                if (currentDate.getMonth() !== currentMonth) {
                    dayElement.style.opacity = '0.3';
                }
                
                // レッスンがある日の詳細情報を表示
                const year = currentDate.getFullYear();
                const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                const day = String(currentDate.getDate()).padStart(2, '0');
                const dateStr = `${year}-${month}-${day}`;
                const dayLessons = lessons.filter(l => l.date === dateStr);
                if (dayLessons.length > 0) {
                    dayElement.classList.add('has-lesson');
                    
                    // レッスンを時間順でソート
                    const sortedLessons = dayLessons.sort((a, b) => a.time.localeCompare(b.time));
                    
                    sortedLessons.forEach(lesson => {
                        // 予約数を計算
                        const bookedCount = bookings.filter(b => b.lessonId === lesson.id).length;
                        
                        const lessonDiv = document.createElement('div');
                        lessonDiv.className = 'lesson-item';
                        lessonDiv.style.cursor = 'pointer';
                        lessonDiv.title = `クリックして編集: ${lesson.content}`;
                        lessonDiv.onclick = () => editLesson(lesson.id);
                        lessonDiv.innerHTML = `
                            <div class="lesson-time">${lesson.time}</div>
                            <div class="lesson-attendance">受講者${bookedCount}名</div>
                        `;
                        dayElement.appendChild(lessonDiv);
                    });
                }
                
                grid.appendChild(dayElement);
            }
        }

        // 月変更
        function changeMonth(direction) {
            currentMonth += direction;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            updateCalendar();
        }

        // アラート表示（画面下部に表示）
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            // コンテナの最後に追加（画面下部）
            document.querySelector('.container').appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // モーダル関連
        function showModal(content) {
            const modal = document.getElementById('lesson-modal');
            const modalBody = document.getElementById('modal-body');
            const defaultHeader = modal.querySelector('.modal-header');
            
            // contentにmodal-headerが含まれている場合は、デフォルトヘッダーを非表示
            if (content.includes('modal-header')) {
                if (defaultHeader) defaultHeader.style.display = 'none';
            } else {
                if (defaultHeader) defaultHeader.style.display = 'flex';
            }
            
            modalBody.innerHTML = content;
            modal.style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('lesson-modal').style.display = 'none';
        }

        // 講師編集・削除
        function editInstructor(instructorId) {
            const instructor = instructors.find(i => i.id === instructorId);
            if (!instructor) return;
            
            const newName = prompt('講師名を入力してください:', instructor.name);
            if (newName && newName.trim()) {
                instructor.name = newName.trim();
                saveData('instructors', instructors);
                updateInstructorList();
                updateInstructorSelect();
                showAlert('講師情報を更新しました', 'success');
            }
        }

        function deleteInstructor(instructorId) {
            if (confirm('この講師を削除しますか？関連するレッスンも削除されます。')) {
                // 講師を削除
                const instructorIndex = instructors.findIndex(i => i.id === instructorId);
                if (instructorIndex !== -1) {
                    instructors.splice(instructorIndex, 1);
                }
                
                // 関連レッスンを削除
                lessons = lessons.filter(l => l.instructorId !== instructorId);
                
                saveData('instructors', instructors);
                saveData('lessons', lessons);
                
                updateInstructorList();
                updateInstructorSelect();
                updateCreatedLessons();
                showAlert('講師を削除しました', 'success');
            }
        }

        // レッスン削除
        function deleteLesson(lessonId) {
            if (confirm('このレッスンを削除しますか？予約も削除されます。')) {
                // レッスンを削除
                const lessonIndex = lessons.findIndex(l => l.id === lessonId);
                if (lessonIndex !== -1) {
                    lessons.splice(lessonIndex, 1);
                }
                
                // 関連予約を削除
                bookings = bookings.filter(b => b.lessonId !== lessonId);
                
                // 関連評価を削除（受講生から講師へ）
                ratings = ratings.filter(r => r.lessonId !== lessonId);
                
                // 関連評価を削除（講師から受講生へ）
                instructorRatings = instructorRatings.filter(r => r.lessonId !== lessonId);
                
                saveData('lessons', lessons);
                saveData('bookings', bookings);
                saveData('ratings', ratings);
                saveData('instructorRatings', instructorRatings);
                
                updateCreatedLessons();
                updateCalendar();
                
                // 統計情報も更新
                if (typeof updateCoordinatorDashboard === 'function') {
                    updateCoordinatorDashboard();
                }
                if (typeof updateAllEvaluations === 'function') {
                    updateAllEvaluations();
                }
                
                showAlert('レッスンと関連データを削除しました', 'success');
            }
        }

        // 受講済み受講生一覧の更新（評価済/未評価分離版）
        function updateCompletedStudentsList() {
            const container = document.getElementById('completed-students-list');
            container.innerHTML = '';
            
            // 現在の講師が担当した過去のレッスンを取得
            const pastLessons = lessons.filter(lesson => {
                const lessonDateTime = new Date(`${lesson.date}T${lesson.time}`);
                return lessonDateTime < new Date();
            });
            
            // 受講済み受講生を収集
            const completedStudents = new Map();
            
            pastLessons.forEach(lesson => {
                const lessonBookings = bookings.filter(b => b.lessonId === lesson.id);
                lessonBookings.forEach(booking => {
                    const student = students.find(s => s.id === booking.studentId);
                    if (student) {
                        const key = `${student.id}-${lesson.id}`;
                        if (!completedStudents.has(key)) {
                            completedStudents.set(key, {
                                student: student,
                                lesson: lesson,
                                booking: booking
                            });
                        }
                    }
                });
            });
            
            // 評価済みと未評価に分離
            const unratedStudents = [];
            const ratedStudents = [];
            
            completedStudents.forEach(({student, lesson, booking}) => {
                const instructorRating = instructorRatings.find(r => 
                    r.lessonId === lesson.id && r.studentId === student.id
                );
                
                if (instructorRating) {
                    ratedStudents.push({student, lesson, booking, instructorRating});
                } else {
                    unratedStudents.push({student, lesson, booking});
                }
            });
            
            // 未評価の受講生を優先表示
            if (unratedStudents.length > 0) {
                const unratedSection = document.createElement('div');
                unratedSection.innerHTML = '<h3>未評価の受講生 (' + unratedStudents.length + '名)</h3>';
                container.appendChild(unratedSection);
                
                unratedStudents.forEach(({student, lesson, booking}) => {
                    // 担当講師情報を取得
                    const instructor = instructors.find(i => i.id === lesson.instructorId);
                    const instructorName = instructor ? instructor.name : '不明';
                    
                    const card = document.createElement('div');
                    card.className = 'lesson-card';
                    card.innerHTML = `
                        <h4>${student.id}：${student.name}</h4>
                        <div class="lesson-info">
                            <span>レッスン: ${lesson.content}</span>
                            <span>受講日時: ${lesson.date} ${lesson.time}</span>
                            <span>担当講師: ${instructorName}</span>
                            <span>現在のレベル: ${student.level}</span>
                        </div>
                        <button class="btn btn-success" onclick="openInstructorRatingModal('${student.id}', '${lesson.id}')">
                            受講生を評価する
                        </button>
                    `;
                    container.appendChild(card);
                });
            }
            
            // 評価済みの受講生はトグル表示
            if (ratedStudents.length > 0) {
                const ratedToggle = document.createElement('div');
                ratedToggle.style.marginTop = '30px';
                ratedToggle.innerHTML = `
                    <button id="toggle-rated-students" class="btn btn-secondary" onclick="toggleRatedStudents()" style="font-size: 14px; margin-bottom: 15px;">
                        評価済み受講生を表示 (${ratedStudents.length}名)
                    </button>
                `;
                container.appendChild(ratedToggle);
                
                const ratedSection = document.createElement('div');
                ratedSection.id = 'rated-students-section';
                ratedSection.style.display = 'none';
                
                ratedStudents.forEach(({student, lesson, booking, instructorRating}) => {
                    // 担当講師情報を取得
                    const instructor = instructors.find(i => i.id === lesson.instructorId);
                    const instructorName = instructor ? instructor.name : '不明';
                    
                    const card = document.createElement('div');
                    card.className = 'lesson-card';
                    card.innerHTML = `
                        <h4>${student.id}：${student.name}</h4>
                        <div class="lesson-info">
                            <span>レッスン: ${lesson.content}</span>
                            <span>受講日時: ${lesson.date} ${lesson.time}</span>
                            <span>担当講師: ${instructorName}</span>
                            <span>現在のレベル: ${student.level}</span>
                        </div>
                        <div class="rating-details">
                            <span class="evaluation-status">評価済み</span>
                            <span>日本語レベル: ${instructorRating.level}</span>
                            <span>受講態度: ${formatAttitudeDisplay(instructorRating.attitude)}</span>
                            ${instructorRating.notes ? `<div class="rating-comment"><p>備考: "${instructorRating.notes}"</p></div>` : ''}
                        </div>
                        <button class="btn btn-warning" onclick="editInstructorRating('${student.id}', '${lesson.id}')">
                            評価を修正する
                        </button>
                    `;
                    ratedSection.appendChild(card);
                });
                
                container.appendChild(ratedSection);
            }
            
            if (completedStudents.size === 0) {
                container.innerHTML = '<div class="lesson-card"><h4>受講済み受講生がいません</h4><p>まだレッスンが完了していません。</p></div>';
            }
        }
        
        // 評価済み受講生の表示/非表示トグル
        function toggleRatedStudents() {
            const ratedSection = document.getElementById('rated-students-section');
            const toggleBtn = document.getElementById('toggle-rated-students');
            
            if (ratedSection.style.display === 'none') {
                ratedSection.style.display = 'block';
                toggleBtn.textContent = toggleBtn.textContent.replace('表示', '非表示');
            } else {
                ratedSection.style.display = 'none';
                toggleBtn.textContent = toggleBtn.textContent.replace('非表示', '表示');
            }
        }

        // 講師評価モーダルを開く（新規追加）
        function openInstructorRatingModal(studentId, lessonId) {
            currentInstructorRatingStudentId = studentId;
            currentInstructorRatingLessonId = lessonId;
            
            // フォームをリセット
            document.getElementById('instructor-rating-level').value = 'N3';
            document.getElementById('instructor-rating-attitude').value = '良い';
            document.getElementById('instructor-rating-notes').value = '';
            
            document.getElementById('instructor-rating-modal').style.display = 'block';
        }

        // 講師評価モーダルを閉じる（新規追加）
        function closeInstructorRatingModal() {
            document.getElementById('instructor-rating-modal').style.display = 'none';
            currentInstructorRatingStudentId = null;
            currentInstructorRatingLessonId = null;
        }

        // 講師評価を送信（新規追加）
        function submitInstructorRating() {
            if (!currentInstructorRatingStudentId || !currentInstructorRatingLessonId) {
                showAlert('エラーが発生しました', 'error');
                return;
            }

            const level = document.getElementById('instructor-rating-level').value;
            const attitude = document.getElementById('instructor-rating-attitude').value;
            const notes = document.getElementById('instructor-rating-notes').value.trim();
            

            
            // 既存の評価があるかチェック
            const existingRatingIndex = instructorRatings.findIndex(r => 
                r.lessonId === currentInstructorRatingLessonId && r.studentId === currentInstructorRatingStudentId
            );

            if (existingRatingIndex !== -1) {
                // 既存の評価を更新
                const oldAttitude = instructorRatings[existingRatingIndex].attitude;
                instructorRatings[existingRatingIndex].level = level;
                instructorRatings[existingRatingIndex].attitude = attitude;
                instructorRatings[existingRatingIndex].notes = notes;
                instructorRatings[existingRatingIndex].updatedAt = new Date().toISOString();
                
                // 受講生評価との連動処理
                const existingStudentRating = ratings.find(r => 
                    r.lessonId === currentInstructorRatingLessonId && r.studentId === currentInstructorRatingStudentId
                );
                
                console.log('🔄 講師評価更新:', {
                    oldAttitude: oldAttitude,
                    newAttitude: attitude,
                    existingStudentRating: existingStudentRating ? existingStudentRating.rating : 'なし'
                });
                
                if (attitude === '不参加') {
                    // 不参加の場合：受講生側の評価は作成しない（講師への0点評価を防ぐ）
                    if (existingStudentRating) {
                        // 既存の受講生評価があれば削除
                        const studentRatingIndex = ratings.findIndex(r => r.id === existingStudentRating.id);
                        if (studentRatingIndex !== -1) {
                            console.log('🗑️ 不参加のため受講生評価を削除:', existingStudentRating);
                            ratings.splice(studentRatingIndex, 1);
                        }
                    }
                    // 不参加時は新規の受講生評価は作成しない
                } else if (oldAttitude === '不参加' && attitude !== '不参加') {
                    // 不参加から通常評価に変更された場合：受講生が評価できるようにする
                    if (existingStudentRating) {
                        const studentRatingIndex = ratings.findIndex(r => r.id === existingStudentRating.id);
                        if (studentRatingIndex !== -1) {
                            console.log('🗑️ 不参加評価を削除:', existingStudentRating);
                            ratings.splice(studentRatingIndex, 1);
                        }
                    }
                    
                    // 受講生が評価可能な状態であることを確実にするため、
                    // 対応するbookingが存在するか確認し、なければ作成
                    const existingBooking = bookings.find(b => 
                        b.lessonId === currentInstructorRatingLessonId && 
                        b.studentId === currentInstructorRatingStudentId
                    );
                    
                    if (!existingBooking) {
                        // bookingが存在しない場合は作成
                        const booking = {
                            id: 'BOOK' + (bookings.length + 1).toString().padStart(4, '0'),
                            lessonId: currentInstructorRatingLessonId,
                            studentId: currentInstructorRatingStudentId,
                            bookedAt: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString() // 1日前
                        };
                        bookings.push(booking);
                        saveData('bookings', bookings);
                        console.log('✅ 評価可能にするためbookingを作成:', booking);
                    }
                    
                    // 対象レッスンが過去のレッスンとして認識されるよう確実にする
                    const targetLesson = lessons.find(l => l.id === currentInstructorRatingLessonId);
                    if (targetLesson) {
                        const lessonDateTime = new Date(`${targetLesson.date}T${targetLesson.time}`);
                        const now = new Date();
                        
                        // レッスンが未来の場合は過去日時に変更
                        if (lessonDateTime > now) {
                            const pastDate = new Date(now.getTime() - 60 * 60 * 1000); // 1時間前
                            const pastDateStr = pastDate.toISOString().split('T')[0];
                            const pastTimeStr = pastDate.toTimeString().substring(0, 5);
                            
                            targetLesson.date = pastDateStr;
                            targetLesson.time = pastTimeStr;
                            saveData('lessons', lessons);
                            console.log('✅ レッスンを過去日時に変更:', targetLesson);
                        }
                    }
                }
                
                // ratingsを保存
                saveData('ratings', ratings);
                
                showAlert('受講生評価を更新しました', 'success');
            } else {
                // 新しい評価を追加
                const ratingObj = {
                    id: 'INST_RATE' + (instructorRatings.length + 1).toString().padStart(4, '0'),
                    lessonId: currentInstructorRatingLessonId,
                    studentId: currentInstructorRatingStudentId,
                    instructorId: currentUserId,
                    level: level,
                    attitude: attitude,
                    notes: notes,
                    ratedAt: new Date().toISOString()
                };
                
                instructorRatings.push(ratingObj);
                showAlert('受講生評価を送信しました', 'success');
                
                // 新規作成時も受講生評価との連動処理を実行
                const existingStudentRating = ratings.find(r => 
                    r.lessonId === currentInstructorRatingLessonId && r.studentId === currentInstructorRatingStudentId
                );
                
                if (attitude === '不参加') {
                    // 不参加の場合：受講生側の評価は作成しない
                    if (existingStudentRating) {
                        // 既存の受講生評価があれば削除
                        const studentRatingIndex = ratings.findIndex(r => r.id === existingStudentRating.id);
                        if (studentRatingIndex !== -1) {
                            console.log('🗑️ 不参加のため受講生評価を削除:', existingStudentRating);
                            ratings.splice(studentRatingIndex, 1);
                        }
                    }
                    // 不参加時は新規の受講生評価は作成しない
                }
                // 新規作成で不参加以外の場合は、ratings配列への追加は行わない（受講生が自分で評価する）
                
                saveData('ratings', ratings);
            }
            
            saveData('instructorRatings', instructorRatings);
            
            closeInstructorRatingModal();
            
            // 確実な画面更新のために少し遅延を入れる
            setTimeout(() => {
                refreshAllScreens();
            }, 50);
        }

        // 講師評価を修正する関数
        function editInstructorRating(studentId, lessonId) {
            // 既存の評価を取得
            const existingRating = instructorRatings.find(r => 
                r.lessonId === lessonId && r.studentId === studentId
            );

            if (!existingRating) {
                showAlert('評価が見つかりません', 'error');
                return;
            }

            // モーダルに既存の評価を設定
            currentInstructorRatingStudentId = studentId;
            currentInstructorRatingLessonId = lessonId;
            
            document.getElementById('instructor-rating-level').value = existingRating.level;
            document.getElementById('instructor-rating-attitude').value = existingRating.attitude;
            document.getElementById('instructor-rating-notes').value = existingRating.notes || '';
            
            document.getElementById('instructor-rating-modal').style.display = 'block';
        }

        // 全評価一覧の更新（新規追加）
        function updateAllEvaluations() {
            // 統計情報の更新
            const totalStudentRatings = ratings.length;
            const totalInstructorRatings = instructorRatings.length;
            
            // 受講生から講師への平均評価計算（0点=不参加を除外）
            const validStudentRatings = ratings.filter(r => r.rating > 0);
            const avgStudentRating = validStudentRatings.length > 0 ? 
                (validStudentRatings.reduce((sum, r) => sum + r.rating, 0) / validStudentRatings.length) : 0;
            
            // 受講生から講師への平均評価を計算
            const avgInstructorRating = calculateInstructorAverageRating();
            
            // 講師から受講生への平均態度評価を計算（不参加除外）
            const avgStudentAttitude = calculateStudentAverageAttitude();
            
            document.getElementById('admin-total-student-ratings').textContent = validStudentRatings.length;
            document.getElementById('admin-total-instructor-ratings').textContent = totalInstructorRatings;
            
            // 受講生から講師への平均評価を数値で表示
            const studentRatingElement = document.getElementById('admin-avg-student-rating');
            if (avgStudentRating > 0) {
                studentRatingElement.innerHTML = formatSimpleRating(avgStudentRating);
            } else {
                studentRatingElement.innerHTML = '<span class="rating-stars no-rating">未評価</span>';
            }
            
            // 講師から受講生への平均評価を数値表示
            const instructorRatingElement = document.getElementById('admin-avg-instructor-rating');
            if (avgStudentAttitude !== null) {
                instructorRatingElement.innerHTML = formatSimpleRating(avgStudentAttitude);
            } else {
                instructorRatingElement.innerHTML = '<span class="rating-stars no-rating">未評価</span>';
            }
            
            // 受講生から講師への評価一覧
            updateAdminStudentRatings();
            
            // 講師から受講生への評価一覧
            updateAdminInstructorRatings();
            
            // 低評価一覧
            updateAdminPoorRatings();
        }

        // 管理者ページの受講生評価一覧更新（新規追加）
        function updateAdminStudentRatings() {
            const container = document.getElementById('admin-student-ratings');
            container.innerHTML = '';
            
            const sortedRatings = ratings.sort((a, b) => new Date(b.ratedAt) - new Date(a.ratedAt));
            
            sortedRatings.forEach(rating => {
                const lesson = lessons.find(l => l.id === rating.lessonId);
                const student = students.find(s => s.id === rating.studentId);
                
                if (!lesson || !student) return;
                
                // 低評価判定（2.0以下）
                const isLowRating = rating.rating > 0 && rating.rating <= 2.0;
                
                const card = document.createElement('div');
                card.className = 'rating-card';
                card.innerHTML = `
                    <h4>${lesson.content}</h4>
                    <div class="rating-details">
                        <span>受講生: ${student.name}</span>
                        <span>講師: ${lesson.instructorName}</span>
                        <span>日時: ${lesson.date} ${lesson.time}</span>
                        <span class="rating-stars ${isLowRating ? 'low-rating' : ''}">わかりやすさ: ${'★'.repeat(rating.rating)}${'☆'.repeat(5-rating.rating)} (${rating.rating}/5)</span>
                        <span>評価日: ${new Date(rating.ratedAt).toLocaleDateString()}</span>
                    </div>
                    ${rating.comment ? `
                        <div class="rating-comment">
                            <strong>感想:</strong>
                            <p>"${rating.comment}"</p>
                        </div>
                    ` : ''}
                `;
                container.appendChild(card);
            });
            
            if (sortedRatings.length === 0) {
                container.innerHTML = '<div class="lesson-card"><h4>受講生評価がありません</h4></div>';
            }
        }

        // 管理者ページの講師評価一覧更新（新規追加）
        function updateAdminInstructorRatings() {
            const container = document.getElementById('admin-instructor-ratings');
            container.innerHTML = '';
            
            const sortedRatings = instructorRatings.sort((a, b) => new Date(b.ratedAt) - new Date(a.ratedAt));
            
            sortedRatings.forEach(rating => {
                const lesson = lessons.find(l => l.id === rating.lessonId);
                const student = students.find(s => s.id === rating.studentId);
                
                if (!lesson || !student) return;
                
                const card = document.createElement('div');
                card.className = 'rating-card';
                card.innerHTML = `
                    <h4>${lesson.content}</h4>
                    <div class="rating-details">
                        <span>受講生: ${student.name}</span>
                        <span>講師: ${lesson.instructorName}</span>
                        <span>日時: ${lesson.date} ${lesson.time}</span>
                        <span>日本語レベル: ${rating.level}</span>
                        <span>受講態度: ${formatAttitudeDisplay(rating.attitude)}</span>
                        <span>評価日: ${new Date(rating.ratedAt).toLocaleDateString()}</span>
                    </div>
                    ${rating.notes ? `
                        <div class="rating-comment">
                            <strong>備考:</strong>
                            <p>"${rating.notes}"</p>
                        </div>
                    ` : ''}
                `;
                container.appendChild(card);
            });
            
            if (sortedRatings.length === 0) {
                container.innerHTML = '<div class="lesson-card"><h4>講師評価がありません</h4></div>';
            }
        }

        // システム概要の更新（新規追加）
        function updateSystemOverview() {
            const totalInstructors = instructors.length;
            const totalStudents = students.length;
            const totalLessons = lessons.length;
            
            // 受講生の受講率計算（実際に受講したレッスンがある受講生の割合）
            const studentsWithValidRatings = students.filter(student => {
                return ratings.some(rating => rating.studentId === student.id && rating.rating > 0);
            });
            const studentAttendanceRate = totalStudents > 0 ? 
                ((studentsWithValidRatings.length / totalStudents) * 100).toFixed(2) : '0.00';
            
            // 平均受講態度の計算（不参加を除外）
            let avgAttitudeDisplay = '-';
            const validRatings = instructorRatings.filter(rating => rating.attitude !== '不参加');
            if (validRatings.length > 0) {
                const totalAttitudeScore = validRatings.reduce((sum, rating) => {
                    return sum + attitudeToScore(rating.attitude);
                }, 0);
                const avgAttitudeScore = totalAttitudeScore / validRatings.length;
                const avgAttitude = scoreToAttitude(Math.round(avgAttitudeScore));
                avgAttitudeDisplay = formatAttitudeDisplay(avgAttitude);
            }
            
            document.getElementById('system-total-instructors').textContent = totalInstructors;
            document.getElementById('system-total-students').textContent = totalStudents;
            document.getElementById('system-student-attendance-rate').textContent = studentAttendanceRate + '%';
            document.getElementById('system-total-lessons').textContent = totalLessons;
            document.getElementById('system-avg-attitude').innerHTML = avgAttitudeDisplay;
            
            // 受講生管理一覧も更新
            updateAdminStudentList();
        }
        
        // 管理者用受講生一覧表示
        function updateAdminStudentList() {
            const container = document.getElementById('admin-student-list');
            container.innerHTML = '';
            
            if (students.length === 0) {
                container.innerHTML = '<div class="lesson-card"><p>登録されている受講生はいません。</p></div>';
                return;
            }
            
            students.forEach(student => {
                // 受講生の統計情報を取得
                const studentBookings = bookings.filter(b => b.studentId === student.id);
                const studentRatings = ratings.filter(r => r.studentId === student.id && r.rating > 0);
                const studentInstructorRatings = instructorRatings.filter(r => r.studentId === student.id);
                
                // 担当者情報を取得
                let coordinatorName = '未割り当て';
                if (student.coordinatorId) {
                    const coordinator = coordinators.find(c => c.id === student.coordinatorId);
                    if (coordinator) {
                        coordinatorName = `${coordinator.name} (${coordinator.id})`;
                    } else {
                        // 担当者IDはあるが、担当者が未登録
                        coordinatorName = `<span style="color: #ff9800;">${student.coordinatorId} (未登録)</span>`;
                    }
                }
                
                const card = document.createElement('div');
                card.className = 'lesson-card';
                card.innerHTML = `
                    <h4>${student.name} (${student.id})</h4>
                    <div class="lesson-info">
                        <span>レベル: ${student.level || '<span style="color: #999;">未設定</span>'}</span>
                        <span>担当者: ${coordinatorName}</span>
                        <span>予約数: ${studentBookings.length}件</span>
                        <span>受講済み: ${studentRatings.length}件</span>
                        <span>評価数: ${studentInstructorRatings.length}件</span>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="editStudentAdmin('${student.id}')">
                            編集
                        </button>
                        <button class="btn btn-danger" onclick="deleteStudentAdmin('${student.id}')">
                            削除
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // 管理者用受講生編集
        function editStudentAdmin(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const modalContent = `
                <div class="modal-header">
                    <h3>受講生情報編集</h3>
                    <button onclick="closeModal()" class="close-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>受講生ID（変更不可）</label>
                        <input type="text" value="${student.id}" disabled>
                    </div>
                    <div class="form-group">
                        <label>名前</label>
                        <input type="text" id="edit-student-name" value="${student.name}">
                    </div>
                    <div class="form-group">
                        <label>日本語レベル</label>
                        <select id="edit-student-level">
                            <option value="" ${!student.level ? 'selected' : ''}>未設定</option>
                            <option value="N1" ${student.level === 'N1' ? 'selected' : ''}>N1</option>
                            <option value="N2" ${student.level === 'N2' ? 'selected' : ''}>N2</option>
                            <option value="N3" ${student.level === 'N3' ? 'selected' : ''}>N3</option>
                            <option value="N4" ${student.level === 'N4' ? 'selected' : ''}>N4</option>
                            <option value="N5" ${student.level === 'N5' ? 'selected' : ''}>N5</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>担当者</label>
                        <select id="edit-student-coordinator">
                            <option value="">未割り当て</option>
                            ${coordinators.map(c => `<option value="${c.id}" ${student.coordinatorId === c.id ? 'selected' : ''}>${c.name} (${c.id})</option>`).join('')}
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="saveStudentEdit('${student.id}')">
                        保存
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal()">
                        キャンセル
                    </button>
                </div>
            `;
            
            showModal(modalContent);
        }
        
        // 管理者用受講生編集保存
        function saveStudentEdit(studentId) {
            const name = document.getElementById('edit-student-name').value.trim();
            const level = document.getElementById('edit-student-level').value;
            const coordinatorId = document.getElementById('edit-student-coordinator').value || null;
            
            if (!name) {
                showAlert('名前を入力してください', 'error');
                return;
            }
            
            const studentIndex = students.findIndex(s => s.id === studentId);
            if (studentIndex === -1) {
                showAlert('受講生が見つかりません', 'error');
                return;
            }
            
            students[studentIndex].name = name;
            students[studentIndex].level = level;
            students[studentIndex].coordinatorId = coordinatorId;
            
            saveData('students', students);
            
            showAlert('受講生情報を更新しました', 'success');
            closeModal();
            updateAdminStudentList();
            updateSystemOverview();
        }
        
        // 受講生担当用の受講生編集
        function editStudentCoordinator(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const modalContent = `
                <div class="modal-header">
                    <h3>受講生情報編集</h3>
                    <button onclick="closeModal()" class="close-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>受講生ID（変更不可）</label>
                        <input type="text" value="${student.id}" disabled>
                    </div>
                    <div class="form-group">
                        <label>名前（変更不可）</label>
                        <input type="text" value="${student.name}" disabled>
                    </div>
                    <div class="form-group">
                        <label>日本語レベル</label>
                        <select id="edit-student-level-coord">
                            <option value="" ${!student.level ? 'selected' : ''}>未設定</option>
                            <option value="N1" ${student.level === 'N1' ? 'selected' : ''}>N1</option>
                            <option value="N2" ${student.level === 'N2' ? 'selected' : ''}>N2</option>
                            <option value="N3" ${student.level === 'N3' ? 'selected' : ''}>N3</option>
                            <option value="N4" ${student.level === 'N4' ? 'selected' : ''}>N4</option>
                            <option value="N5" ${student.level === 'N5' ? 'selected' : ''}>N5</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="saveStudentEditCoordinator('${student.id}')">
                        保存
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal()">
                        キャンセル
                    </button>
                </div>
            `;
            
            showModal(modalContent);
        }
        
        // 受講生担当用の受講生編集保存
        function saveStudentEditCoordinator(studentId) {
            const level = document.getElementById('edit-student-level-coord').value;
            
            const studentIndex = students.findIndex(s => s.id === studentId);
            if (studentIndex === -1) {
                showAlert('受講生が見つかりません', 'error');
                return;
            }
            
            students[studentIndex].level = level;
            
            saveData('students', students);
            
            showAlert('日本語レベルを更新しました', 'success');
            closeModal();
            updateAllStudentsList();
        }
        
        // 管理者用受講生削除
        function deleteStudentAdmin(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            if (!confirm(`受講生「${student.name} (${student.id})」を削除しますか？\n\nこの操作により、以下のデータも削除されます：\n・予約データ\n・受講生から講師への評価\n・講師から受講生への評価\n・同席依頼データ\n\nこの操作は取り消せません。`)) {
                return;
            }
            
            // 受講生を削除
            const studentIndex = students.findIndex(s => s.id === studentId);
            if (studentIndex !== -1) {
                students.splice(studentIndex, 1);
            }
            
            // 関連する予約を削除
            const bookingsToRemove = bookings.filter(b => b.studentId === studentId);
            bookings = bookings.filter(b => b.studentId !== studentId);
            
            // 関連する評価を削除（受講生から講師）
            ratings = ratings.filter(r => r.studentId !== studentId);
            
            // 関連する評価を削除（講師から受講生）
            instructorRatings = instructorRatings.filter(r => r.studentId !== studentId);
            
            // 関連する同席依頼を削除
            if (typeof attendanceRequests !== 'undefined') {
                attendanceRequests = attendanceRequests.filter(r => r.studentId !== studentId);
                localStorage.setItem('attendanceRequests', JSON.stringify(attendanceRequests));
            }
            
            // LocalStorageを更新
            saveData('students', students);
            saveData('bookings', bookings);
            saveData('ratings', ratings);
            saveData('instructorRatings', instructorRatings);
            
            showAlert(`受講生「${student.name}」と関連データを削除しました\n・予約: ${bookingsToRemove.length}件削除`, 'success');
            
            // 画面を更新
            updateAdminStudentList();
            updateSystemOverview();
            updateAdminPoorRatings();
            updateAdminEvaluations();
        }
        
        // 受講担当者管理機能
        function updateAdminCoordinatorList() {
            const container = document.getElementById('admin-coordinator-list');
            container.innerHTML = '';
            
            if (coordinators.length === 0) {
                container.innerHTML = '<div class="lesson-card"><p>登録されている担当者はいません。</p></div>';
                return;
            }
            
            coordinators.forEach(coordinator => {
                // この担当者が担当する受講生数を取得
                const assignedStudents = students.filter(s => s.coordinatorId === coordinator.id);
                
                // 担当受講生の受講率を計算
                const attendedStudents = assignedStudents.filter(student => {
                    return ratings.some(rating => rating.studentId === student.id && rating.rating > 0);
                });
                const attendanceRate = assignedStudents.length > 0 ? 
                    ((attendedStudents.length / assignedStudents.length) * 100).toFixed(1) : '0.0';
                
                const card = document.createElement('div');
                card.className = 'lesson-card';
                card.innerHTML = `
                    <h4>${coordinator.name} (${coordinator.id})</h4>
                    <div class="lesson-info">
                        <span>担当受講生数: ${assignedStudents.length}名</span>
                        <span>受講済み: ${attendedStudents.length}名</span>
                        <span>受講率: ${attendanceRate}%</span>
                        ${coordinator.isTestAccount ? '<span style="background: rgba(255, 193, 7, 0.8);">テストアカウント</span>' : ''}
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="editCoordinator('${coordinator.id}')">
                            編集
                        </button>
                        ${!coordinator.isTestAccount ? `
                            <button class="btn btn-danger" onclick="deleteCoordinator('${coordinator.id}')">
                                削除
                            </button>
                        ` : '<span style="color: #ffc107;">※テストアカウントは削除できません</span>'}
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        function addCoordinator() {
            const id = document.getElementById('new-coordinator-id').value.trim();
            const name = document.getElementById('new-coordinator-name').value.trim();
            const password = document.getElementById('new-coordinator-password').value;
            
            if (!id || !name || !password) {
                showAlert('すべての項目を入力してください', 'error');
                return;
            }
            
            // IDの重複チェック
            if (coordinators.find(c => c.id === id)) {
                showAlert('この担当者IDは既に使用されています', 'error');
                return;
            }
            
            const coordinator = {
                id: id,
                name: name,
                password: password,
                isTestAccount: false,
                createdAt: new Date().toISOString()
            };
            
            coordinators.push(coordinator);
            localStorage.setItem('coordinators', JSON.stringify(coordinators));
            
            // この担当者IDを持つ受講生を確認（自動割り当て）
            const matchedStudents = students.filter(s => s.coordinatorId === id);
            
            // フォームをクリア
            document.getElementById('new-coordinator-id').value = '';
            document.getElementById('new-coordinator-name').value = '';
            document.getElementById('new-coordinator-password').value = '';
            
            let message = `担当者「${name} (${id})」を追加しました`;
            if (matchedStudents.length > 0) {
                message += `\n\n既に担当者ID「${id}」を持つ受講生${matchedStudents.length}名に自動的に割り当てられました：\n`;
                message += matchedStudents.map(s => `・${s.name} (${s.id})`).join('\n');
            }
            
            showAlert(message, 'success');
            updateAdminCoordinatorList();
            if (typeof updateAdminStudentList === 'function') {
                updateAdminStudentList();
            }
        }
        
        function editCoordinator(coordinatorId) {
            const coordinator = coordinators.find(c => c.id === coordinatorId);
            if (!coordinator) return;
            
            const modalContent = `
                <div class="modal-header">
                    <h3>担当者情報編集</h3>
                    <button onclick="closeModal()" class="close-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>担当者ID（変更不可）</label>
                        <input type="text" value="${coordinator.id}" disabled>
                    </div>
                    <div class="form-group">
                        <label>担当者名</label>
                        <input type="text" id="edit-coordinator-name" value="${coordinator.name}">
                    </div>
                    <div class="form-group">
                        <label>パスワード</label>
                        <input type="password" id="edit-coordinator-password" value="${coordinator.password}">
                    </div>
                    <button class="btn btn-primary" onclick="saveCoordinatorEdit('${coordinator.id}')">
                        保存
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal()">
                        キャンセル
                    </button>
                </div>
            `;
            
            showModal(modalContent);
        }
        
        function saveCoordinatorEdit(coordinatorId) {
            const name = document.getElementById('edit-coordinator-name').value.trim();
            const password = document.getElementById('edit-coordinator-password').value;
            
            if (!name || !password) {
                showAlert('名前とパスワードを入力してください', 'error');
                return;
            }
            
            const coordinatorIndex = coordinators.findIndex(c => c.id === coordinatorId);
            if (coordinatorIndex === -1) {
                showAlert('担当者が見つかりません', 'error');
                return;
            }
            
            coordinators[coordinatorIndex].name = name;
            coordinators[coordinatorIndex].password = password;
            
            localStorage.setItem('coordinators', JSON.stringify(coordinators));
            
            showAlert('担当者情報を更新しました', 'success');
            closeModal();
            updateAdminCoordinatorList();
        }
        
        function deleteCoordinator(coordinatorId) {
            const coordinator = coordinators.find(c => c.id === coordinatorId);
            if (!coordinator) return;
            
            if (coordinator.isTestAccount) {
                showAlert('テストアカウントは削除できません', 'error');
                return;
            }
            
            // この担当者が担当する受講生数を確認
            const assignedStudents = students.filter(s => s.coordinatorId === coordinatorId);
            
            if (!confirm(`担当者「${coordinator.name} (${coordinator.id})」を削除しますか？\n\n担当受講生: ${assignedStudents.length}名\n※担当受講生は削除されませんが、担当者が未割り当てになります。\n\nこの操作は取り消せません。`)) {
                return;
            }
            
            // 担当者を削除
            const coordinatorIndex = coordinators.findIndex(c => c.id === coordinatorId);
            if (coordinatorIndex !== -1) {
                coordinators.splice(coordinatorIndex, 1);
            }
            
            // この担当者が担当していた受講生の担当者をクリア
            students.forEach(student => {
                if (student.coordinatorId === coordinatorId) {
                    student.coordinatorId = null;
                }
            });
            
            localStorage.setItem('coordinators', JSON.stringify(coordinators));
            saveData('students', students);
            
            showAlert(`担当者「${coordinator.name}」を削除しました`, 'success');
            updateAdminCoordinatorList();
            updateSystemOverview();
        }
        
        // 担当者ドロップダウンを更新
        function populateCoordinatorDropdowns() {
            const dropdown = document.getElementById('student-coordinator');
            if (!dropdown) return;
            
            dropdown.innerHTML = '<option value="">未割り当て</option>';
            
            coordinators.forEach(coordinator => {
                const option = document.createElement('option');
                option.value = coordinator.id;
                option.textContent = `${coordinator.name} (${coordinator.id})`;
                dropdown.appendChild(option);
            });
        }

        // 管理者用低評価一覧更新
        function updateAdminPoorRatings() {
            // 低評価講師一覧（☆2以下）
            const poorInstructorContainer = document.getElementById('admin-poor-instructors');
            poorInstructorContainer.innerHTML = '';
            
            const poorInstructorRatings = ratings.filter(rating => rating.rating <= 2);
            
            if (poorInstructorRatings.length === 0) {
                poorInstructorContainer.innerHTML = '<div class="lesson-card"><h4>該当する講師はいません</h4><p>低評価の講師はいません。</p></div>';
            } else {
                // 講師IDでグループ化
                const instructorGroups = {};
                poorInstructorRatings.forEach(rating => {
                    const lesson = lessons.find(l => l.id === rating.lessonId);
                    if (lesson) {
                        if (!instructorGroups[lesson.instructorId]) {
                            instructorGroups[lesson.instructorId] = [];
                        }
                        instructorGroups[lesson.instructorId].push({...rating, lesson});
                    }
                });
                
                Object.keys(instructorGroups).forEach(instructorId => {
                    const instructor = instructors.find(i => i.id === instructorId);
                    if (!instructor) return;
                    
                    const ratings = instructorGroups[instructorId];
                    const avgRating = (ratings.reduce((sum, r) => sum + r.rating, 0) / ratings.length).toFixed(2);
                    
                    const card = document.createElement('div');
                    card.className = 'lesson-card poor-attitude-card';
                    card.innerHTML = `
                        <h4>${instructor.name} (${instructor.id})</h4>
                        <div class="lesson-info">
                            <span class="poor-attitude">平均評価: ${avgRating}</span>
                            <span>低評価回数: ${ratings.length}回</span>
                            <span>最新評価: ${new Date(ratings[0].ratedAt).toLocaleDateString()}</span>
                        </div>
                    `;
                    poorInstructorContainer.appendChild(card);
                });
            }
            
            // 問題のある受講生一覧（改善が必要）
            const poorStudentContainer = document.getElementById('admin-poor-students');
            poorStudentContainer.innerHTML = '';
            
            const poorStudentRatings = instructorRatings.filter(rating => 
                rating.attitude === '悪い' || rating.attitude === '改善が必要'
            );
            
            if (poorStudentRatings.length === 0) {
                poorStudentContainer.innerHTML = '<div class="lesson-card"><h4>該当する受講生はいません</h4><p>問題のある受講生はいません。</p></div>';
            } else {
                // 受講生IDでグループ化
                const studentGroups = {};
                poorStudentRatings.forEach(rating => {
                    if (!studentGroups[rating.studentId]) {
                        studentGroups[rating.studentId] = [];
                    }
                    studentGroups[rating.studentId].push(rating);
                });
                
                Object.keys(studentGroups).forEach(studentId => {
                    const student = students.find(s => s.id === studentId);
                    if (!student) return;
                    
                    const studentRatings = studentGroups[studentId];
                    const mostRecentRating = studentRatings.sort((a, b) => 
                        new Date(b.ratedAt) - new Date(a.ratedAt)
                    )[0];
                    
                    const card = document.createElement('div');
                    card.className = 'lesson-card poor-attitude-card';
                    card.innerHTML = `
                        <h4>${student.id}：${student.name}</h4>
                        <div class="lesson-info">
                            <span>レベル: ${student.level}</span>
                            <span class="poor-attitude">受講態度: ${mostRecentRating.attitude}</span>
                            <span>問題発生回数: ${studentRatings.length}回</span>
                            <span>最新評価: ${new Date(mostRecentRating.ratedAt).toLocaleDateString()}</span>
                        </div>
                        ${mostRecentRating.notes ? `<div class="rating-comment"><p>備考: "${mostRecentRating.notes}"</p></div>` : ''}
                    `;
                    poorStudentContainer.appendChild(card);
                });
            }

            // 欠席追跡セクション更新
            updateAbsenceTracking();
        }



        // 欠席追跡更新関数
        function updateAbsenceTracking() {
            const container = document.getElementById('admin-absence-tracking');
            container.innerHTML = '';

            // 欠席回数を受講生ごとに集計（講師評価の不参加ベース）
            const absenceData = {};
            students.forEach(student => {
                const studentInstructorRatings = instructorRatings.filter(r => r.studentId === student.id);
                const absenceCount = studentInstructorRatings.filter(r => r.attitude === '不参加').length;
                const totalLessons = studentInstructorRatings.length;
                
                if (absenceCount > 0) {
                    absenceData[student.id] = {
                        student: student,
                        absenceCount: absenceCount,
                        totalLessons: totalLessons
                    };
                }
            });

            const sortedAbsences = Object.values(absenceData).sort((a, b) => b.absenceCount - a.absenceCount);

            if (sortedAbsences.length === 0) {
                container.innerHTML = '<div class="lesson-card"><h4>欠席者はいません</h4><p>現在欠席している受講生はいません。</p></div>';
            } else {
                sortedAbsences.forEach(data => {
                    const attendanceRate = ((data.totalLessons - data.absenceCount) / data.totalLessons * 100).toFixed(2);
                    const isHighRisk = data.absenceCount >= 3;
                    const isMediumRisk = data.absenceCount === 2;

                    const card = document.createElement('div');
                    card.className = 'lesson-card';
                    if (isHighRisk) card.classList.add('poor-attitude-card');
                    
                    card.innerHTML = `
                        <h4>${data.student.id}：${data.student.name}</h4>
                        <div class="lesson-info">
                            <span>レベル: ${data.student.level}</span>
                            <span class="${isHighRisk ? 'poor-attitude' : isMediumRisk ? 'medium-risk' : ''}">欠席回数: ${data.absenceCount}回</span>
                            <span>総レッスン数: ${data.totalLessons}回</span>
                            <span>出席率: ${attendanceRate}%</span>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }
        }

        // ウィンドウクリックでモーダルを閉じる
        window.onclick = function(event) {
            const modal = document.getElementById('lesson-modal');
            const ratingModal = document.getElementById('rating-modal');
            const instructorRatingModal = document.getElementById('instructor-rating-modal');
            
            if (event.target === modal) {
                modal.style.display = 'none';
            }
            if (event.target === ratingModal) {
                closeRatingModal();
            }
            if (event.target === instructorRatingModal) {
                closeInstructorRatingModal();
            }
        }

        // レッスン編集機能
        let currentEditingLessonId = null;
        
        function editLesson(lessonId) {
            const lesson = lessons.find(l => l.id === lessonId);
            if (!lesson) {
                showAlert('レッスンが見つかりません', 'error');
                return;
            }
            
            currentEditingLessonId = lessonId;
            
            // モーダルに現在の値を設定
            document.getElementById('edit-lesson-content').value = lesson.content;
            document.getElementById('edit-lesson-date').value = lesson.date;
            document.getElementById('edit-lesson-duration').value = lesson.duration;
            document.getElementById('edit-lesson-capacity').value = lesson.capacity;
            document.getElementById('edit-lesson-level').value = lesson.level;
            document.getElementById('edit-lesson-online-link').value = lesson.onlineLink || '';
            
            // 時間選択肢を設定
            document.getElementById('edit-lesson-time').value = lesson.time;
            
            // モーダルを表示
            document.getElementById('lesson-edit-modal').style.display = 'block';
        }

        function closeLessonEditModal() {
            document.getElementById('lesson-edit-modal').style.display = 'none';
            currentEditingLessonId = null;
        }

        function saveLessonEdit() {
            if (!currentEditingLessonId) return;
            
            const lesson = lessons.find(l => l.id === currentEditingLessonId);
            if (!lesson) {
                showAlert('レッスンが見つかりません', 'error');
                return;
            }
            
            // フォームから値を取得
            const newContent = document.getElementById('edit-lesson-content').value.trim();
            const newDate = document.getElementById('edit-lesson-date').value;
            const newTime = document.getElementById('edit-lesson-time').value;
            const newDuration = parseInt(document.getElementById('edit-lesson-duration').value);
            const newCapacity = parseInt(document.getElementById('edit-lesson-capacity').value);
            const newLevel = document.getElementById('edit-lesson-level').value;
            const newOnlineLink = document.getElementById('edit-lesson-online-link').value.trim();
            
            // バリデーション
            if (!newContent) {
                showAlert('レッスン内容を入力してください', 'error');
                return;
            }
            if (!newDate) {
                showAlert('日付を選択してください', 'error');
                return;
            }
            if (isNaN(newDuration) || newDuration < 15) {
                showAlert('所要時間は15分以上で入力してください', 'error');
                return;
            }
            if (isNaN(newCapacity) || newCapacity < 1) {
                showAlert('定員は1以上で入力してください', 'error');
                return;
            }
            
            // レッスンを更新
            lesson.content = newContent;
            lesson.date = newDate;
            lesson.time = newTime;
            lesson.duration = newDuration;
            lesson.capacity = newCapacity;
            lesson.level = newLevel;
            lesson.onlineLink = newOnlineLink;
            
            // ローカルストレージに保存
            saveData('lessons', lessons);
            
            // 表示を更新
            updateCreatedLessons();
            updateCalendar();
            
            // モーダルを閉じる
            closeLessonEditModal();
            
            showAlert('レッスンが更新されました', 'success');
        }

        // ページ更新関数
        async function refreshPage() {
            if (USE_DATABASE && DATABASE_API_URL) {
                // データベースモードの場合は手動リフレッシュ
                await manualRefresh();
            } else {
                // LocalStorageモードの場合はページリロード
                location.reload();
            }
        }

        // カレンダー機能
        let currentCalendarDate = new Date();
        let selectedDate = null;

        // カレンダーを生成（講師形式）
        function generateCalendar(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            
            // カレンダータイトルを更新
            const monthNames = [
                '1月', '2月', '3月', '4月', '5月', '6月',
                '7月', '8月', '9月', '10月', '11月', '12月'
            ];
            document.getElementById('calendar-title').textContent = `${year}年${monthNames[month]}`;
            
            // カレンダーグリッドを作成
            const calendarGrid = document.getElementById('lesson-calendar-grid');
            calendarGrid.innerHTML = '';
            
            // 曜日ヘッダーを追加
            const dayHeaders = ['日', '月', '火', '水', '木', '金', '土'];
            dayHeaders.forEach(day => {
                const headerElement = document.createElement('div');
                headerElement.className = 'calendar-day-header';
                headerElement.textContent = day;
                headerElement.style.fontWeight = 'bold';
                headerElement.style.textAlign = 'center';
                headerElement.style.padding = '10px';
                headerElement.style.background = 'rgba(102, 126, 234, 0.8)';
                headerElement.style.color = 'white';
                headerElement.style.borderRadius = '5px';
                calendarGrid.appendChild(headerElement);
            });
            
            // カレンダー日付の配置
            const firstDay = new Date(year, month, 1);
            const startDate = new Date(firstDay);
            startDate.setDate(1 - firstDay.getDay()); // 月の最初の日の曜日分だけ前に戻る
            
            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                // 日付表示
                const dateDiv = document.createElement('div');
                dateDiv.className = 'calendar-date';
                dateDiv.textContent = currentDate.getDate();
                dayElement.appendChild(dateDiv);
                
                // 他月の日付は薄く表示
                if (currentDate.getMonth() !== month) {
                    dayElement.style.opacity = '0.3';
                }
                
                // レッスンがある日の詳細情報を表示（講師形式）
                const yearStr = currentDate.getFullYear();
                const monthStr = String(currentDate.getMonth() + 1).padStart(2, '0');
                const dayStr = String(currentDate.getDate()).padStart(2, '0');
                const dateStr = `${yearStr}-${monthStr}-${dayStr}`;
                const dayLessons = lessons.filter(l => l.date === dateStr);
                
                if (dayLessons.length > 0) {
                    dayElement.classList.add('has-lessons');
                    
                    // レッスンを時間順でソート
                    const sortedLessons = dayLessons.sort((a, b) => a.time.localeCompare(b.time));
                    
                    sortedLessons.forEach(lesson => {
                        // 予約数を計算
                        const bookedCount = bookings.filter(b => b.lessonId === lesson.id).length;
                        
                        const lessonDiv = document.createElement('div');
                        lessonDiv.className = 'lesson-item';
                        lessonDiv.style.cursor = 'pointer';
                        lessonDiv.style.background = 'rgba(255, 255, 255, 0.9)';
                        lessonDiv.style.margin = '2px 0';
                        lessonDiv.style.padding = '4px 8px';
                        lessonDiv.style.borderRadius = '5px';
                        lessonDiv.style.fontSize = '11px';
                        lessonDiv.title = `クリックして詳細表示: ${lesson.content}`;
                        lessonDiv.onclick = () => showLessonDetail(lesson.id);
                        lessonDiv.innerHTML = `
                            <div style="color: #333; font-weight: bold;">${lesson.time}</div>
                            <div style="color: #4CAF50; font-weight: bold;">受講者${bookedCount}名</div>
                        `;
                        dayElement.appendChild(lessonDiv);
                    });
                }
                
                calendarGrid.appendChild(dayElement);
            }
        }

        // 指定日のレッスンを取得
        function getLessonsOnDate(dateStr) {
            const lessons = JSON.parse(localStorage.getItem('lessons') || '[]');
            return lessons.filter(lesson => lesson.date === dateStr);
        }

        // 日付選択
        function selectDate(dateStr) {
            selectedDate = dateStr;
            
            // 選択状態のスタイルを更新
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.classList.remove('selected');
            });
            document.querySelector(`[data-date="${dateStr}"]`).classList.add('selected');
            
            // 選択日のレッスンを表示
            displayLessonsForDate(dateStr);
        }

        // 選択日のレッスンを表示
        function displayLessonsForDate(dateStr) {
            const lessons = getLessonsOnDate(dateStr);
            const selectedDateTitle = document.getElementById('selected-date-title');
            const selectedDateContent = document.getElementById('selected-date-content');
            
            const formattedDate = new Date(dateStr).toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
            
            selectedDateTitle.textContent = `${formattedDate} のレッスン`;
            
            if (lessons.length === 0) {
                selectedDateContent.innerHTML = '<p>この日にレッスンはありません</p>';
                return;
            }
            
            let lessonsHtml = '<div class="lessons-list">';
            lessons.forEach(lesson => {
                const bookings = lesson.bookings || [];
                const availableSlots = lesson.capacity - bookings.length;
                
                lessonsHtml += `
                    <div class="lesson-card" style="margin-bottom: 15px; padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 10px;">
                        <h4>${lesson.content}</h4>
                        <p><strong>時間:</strong> ${lesson.time} (${lesson.duration}分)</p>
                        <p><strong>レベル:</strong> ${lesson.level}</p>
                        <p><strong>定員:</strong> ${lesson.capacity}名 (空き: ${availableSlots}名)</p>
                        <p><strong>講師:</strong> ${lesson.instructor}</p>
                        ${lesson.onlineLink ? `<p><strong>オンライン:</strong> <a href="${lesson.onlineLink}" target="_blank" style="color: #4CAF50;">参加リンク</a></p>` : ''}
                        
                        <div style="margin-top: 10px;">
                            <h5>予約済み受講生:</h5>
                            ${bookings.length === 0 ? '<p>まだ予約はありません</p>' : ''}
                            <div class="bookings-list">
                                ${bookings.map(booking => {
                                    const student = students.find(s => s.id === booking.studentId);
                                    const studentName = booking.studentName || (student ? student.name : '不明な受講生');
                                    return `
                                    <div style="margin: 5px 0; padding: 8px; background: rgba(255, 255, 255, 0.15); border-radius: 5px;">
                                        <span>${booking.studentId}：${studentName}</span>
                                    </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });
            lessonsHtml += '</div>';
            
            selectedDateContent.innerHTML = lessonsHtml;
        }

        // レッスン同席機能
        function attendLesson(lessonId, studentId) {
            const coordinatorName = localStorage.getItem('coordinatorName') || 'コーディネーター';
            
            // 同席記録を追加
            const attendanceRecord = {
                lessonId: lessonId,
                studentId: studentId,
                coordinatorName: coordinatorName,
                attendedAt: new Date().toISOString(),
                type: 'attendance'
            };
            
            // ローカルストレージに記録を保存
            let attendanceRecords = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
            attendanceRecords.push(attendanceRecord);
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            
            showAlert(`${coordinatorName}がレッスンに同席参加しました`, 'success');
            
            // 表示を更新
            if (selectedDate) {
                displayLessonsForDate(selectedDate);
            }
        }

        // 前月へ
        function previousMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            generateCalendar(currentCalendarDate);
        }

        // 次月へ
        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            generateCalendar(currentCalendarDate);
        }

        // カレンダーを初期化
        function initializeCalendar() {
            generateCalendar(currentCalendarDate);
        }

        // ページロード時にカレンダーを初期化
        document.addEventListener('DOMContentLoaded', function() {
            // カレンダータブがアクティブな場合は初期化
            setTimeout(initializeCalendar, 100);
        });

        // 同席依頼機能
        function requestAttendance(lessonId, studentId) {
            const lesson = lessons.find(l => l.id === lessonId);
            if (!lesson) {
                showAlert('レッスンが見つかりません', 'error');
                return;
            }

            // 同席依頼を記録
            const attendanceRequest = {
                id: Date.now().toString(),
                lessonId: lessonId,
                studentId: studentId,
                studentName: students.find(s => s.id === studentId)?.name || '不明',
                lessonTitle: lesson.content,
                lessonDate: lesson.date,
                lessonTime: lesson.time,
                instructor: lesson.instructorName,
                requestedAt: new Date().toISOString(),
                status: 'requested',
                type: 'attendance_request'
            };

            // 同席依頼を保存
            let attendanceRequests = JSON.parse(localStorage.getItem('attendanceRequests') || '[]');
            attendanceRequests.push(attendanceRequest);
            localStorage.setItem('attendanceRequests', JSON.stringify(attendanceRequests));

            showAlert('コーディネーターに同席依頼を送信しました', 'success');
        }

        // 同席履歴表示機能
        function viewAttendanceHistory(lessonId) {
            const attendanceRecords = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
            const lessonRecords = attendanceRecords.filter(record => record.lessonId === lessonId);
            
            const lesson = lessons.find(l => l.id === lessonId);
            
            let historyHtml = `<div style="padding: 20px;">`;
            historyHtml += `<h3>レッスン同席履歴</h3>`;
            historyHtml += `<p><strong>レッスン:</strong> ${lesson ? lesson.content : '不明'}</p>`;
            historyHtml += `<p><strong>日時:</strong> ${lesson ? `${lesson.date} ${lesson.time}` : '不明'}</p>`;
            
            if (lessonRecords.length === 0) {
                historyHtml += `<p>同席履歴はありません</p>`;
            } else {
                historyHtml += `<div style="margin-top: 15px;">`;
                historyHtml += `<h4>同席参加者:</h4>`;
                lessonRecords.forEach(record => {
                    const attendedDate = new Date(record.attendedAt).toLocaleString('ja-JP');
                    historyHtml += `
                        <div style="padding: 10px; margin: 5px 0; background: rgba(255, 255, 255, 0.1); border-radius: 5px;">
                            <p><strong>${record.coordinatorName}</strong> が同席参加</p>
                            <p><small>参加日時: ${attendedDate}</small></p>
                        </div>
                    `;
                });
                historyHtml += `</div>`;
            }
            
            historyHtml += `<button onclick="closeHistoryModal()" style="margin-top: 15px; padding: 8px 16px; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer;">閉じる</button>`;
            historyHtml += `</div>`;

            // モーダル表示
            showCustomModal(historyHtml);
        }

        // カスタムモーダル表示
        function showCustomModal(content, modalId = 'custom-modal') {
            const modal = document.createElement('div');
            modal.id = modalId;
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-radius: 15px;
                max-width: 700px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            `;
            modalContent.innerHTML = content;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }

        // モーダルを閉じる
        function closeHistoryModal() {
            const modal = document.getElementById('custom-modal');
            if (modal) {
                modal.remove();
            }
        }

        // レッスン詳細表示（カレンダーから）
        function showLessonDetail(lessonId) {
            const lesson = lessons.find(l => l.id === lessonId);
            if (!lesson) {
                showAlert('レッスンが見つかりません', 'error');
                return;
            }

            const lessonBookings = bookings.filter(b => b.lessonId === lessonId);
            const bookedCount = lessonBookings.length;
            const availableSlots = lesson.capacity - bookedCount;

            let detailHtml = `
                <div style="padding: 20px; max-width: 500px;">
                    <h3 style="color: #333; margin-bottom: 15px;">レッスン詳細</h3>
                    
                    <div style="background: rgba(102, 126, 234, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <h4 style="color: #333; margin-bottom: 10px;">${lesson.content}</h4>
                        <div style="color: #555; line-height: 1.6;">
                            <p><strong>日時:</strong> ${lesson.date} ${lesson.time}</p>
                            <p><strong>所要時間:</strong> ${lesson.duration}分</p>
                            <p><strong>講師:</strong> ${lesson.instructorName}</p>
                            <p><strong>レベル:</strong> ${lesson.level}</p>
                            <p><strong>定員:</strong> ${lesson.capacity}名 (空き: ${availableSlots}名)</p>
                        </div>
                        
                        ${lesson.onlineLink ? `
                            <div style="margin-top: 15px; padding: 10px; background: rgba(76, 175, 80, 0.1); border-radius: 8px;">
                                <p style="color: #333; margin-bottom: 8px;"><strong>オンラインレッスンリンク:</strong></p>
                                <a href="${lesson.onlineLink}" target="_blank" 
                                   style="color: #4CAF50; text-decoration: none; font-weight: bold; padding: 8px 16px; background: rgba(76, 175, 80, 0.2); border-radius: 5px; display: inline-block;">
                                    レッスンに参加 →
                                </a>
                            </div>
                        ` : '<p style="color: #999; margin-top: 10px;">リンクなし</p>'}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: #333; margin-bottom: 10px;">予約済み受講生 (${bookedCount}名)</h4>
                        ${lessonBookings.length === 0 ? 
                            '<p style="color: #666;">まだ予約はありません</p>' : 
                            lessonBookings.map(booking => {
                                const student = students.find(s => s.id === booking.studentId);
                                const studentName = booking.studentName || (student ? student.name : '不明な受講生');
                                return `
                                <div style="padding: 8px 12px; background: rgba(255, 255, 255, 0.8); border-radius: 5px; margin: 5px 0;">
                                    <span style="color: #333;">${booking.studentId}：${studentName}</span>
                                </div>
                                `;
                            }).join('')
                        }
                    </div>

                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="closeHistoryModal()" 
                                style="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">
                            閉じる
                        </button>
                    </div>
                </div>
            `;

            showCustomModal(detailHtml);
        }

        // ==================== Google Sheets連携機能 ====================
        
        // Apps Script URLの取得と保存
        function getAppsScriptUrl() {
            let url = document.getElementById('apps-script-url')?.value;
            if (!url) {
                url = localStorage.getItem('appsScriptUrl');
            } else {
                localStorage.setItem('appsScriptUrl', url);
            }
            return url;
        }
        
        // ステータス表示
        function showSyncStatus(message, type = 'info') {
            const statusDiv = document.getElementById('sync-status');
            const statusText = document.getElementById('sync-status-text');
            
            if (statusDiv && statusText) {
                statusDiv.style.display = 'block';
                statusText.textContent = message;
                
                if (type === 'success') {
                    statusDiv.style.background = 'rgba(16, 185, 129, 0.2)';
                    statusDiv.style.color = '#059669';
                } else if (type === 'error') {
                    statusDiv.style.background = 'rgba(239, 68, 68, 0.2)';
                    statusDiv.style.color = '#dc2626';
                } else {
                    statusDiv.style.background = 'rgba(59, 130, 246, 0.2)';
                    statusDiv.style.color = '#2563eb';
                }
                
                if (type !== 'info') {
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 5000);
                }
            }
        }
        
        // 1. スプレッドシートから受講生を同期（ステータス: 求人中）
        async function syncStudentsFromGoogleSheets() {
            const appsScriptUrl = getAppsScriptUrl();
            
            if (!appsScriptUrl) {
                showAlert('Apps Script URLを入力してください', 'error');
                return;
            }
            
            try {
                showSyncStatus('スプレッドシートから受講生データを取得中...', 'info');
                showAlert('同期を開始しました...', 'info');
                
                const response = await fetch(`${appsScriptUrl}?action=getStudents`);
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || '不明なエラー');
                }
                
                const newStudents = result.students;
                let addedCount = 0;
                let updatedCount = 0;
                
                // 既存データとマージ（スプレッドシートの情報で完全に上書き）
                newStudents.forEach(newStudent => {
                    const existingIndex = students.findIndex(s => s.id === newStudent.id);
                    if (existingIndex >= 0) {
                        // 既存データを更新（スプレッドシートの情報を優先）
                        const createdAt = students[existingIndex].createdAt || new Date().toISOString();
                        students[existingIndex] = {
                            id: newStudent.id,
                            name: newStudent.name,
                            level: newStudent.level || students[existingIndex].level || '',  // 空欄のまま（自動でN5にしない）
                            coordinatorId: newStudent.coordinatorId || null,  // スプレッドシートの値を常に反映（担当者未登録でも保存）
                            email: newStudent.email || students[existingIndex].email || '',
                            phone: newStudent.phone || students[existingIndex].phone || '',
                            createdAt: createdAt
                        };
                        updatedCount++;
                    } else {
                        // 新規追加（担当者IDが存在しなくてもスプレッドシートの値を保存）
                        students.push({
                            id: newStudent.id,
                            name: newStudent.name,
                            level: newStudent.level || '',  // 空欄のまま（自動でN5にしない）
                            coordinatorId: newStudent.coordinatorId || null,  // 担当者未登録でも担当者IDを保存
                            email: newStudent.email || '',
                            phone: newStudent.phone || '',
                            createdAt: new Date().toISOString()
                        });
                        addedCount++;
                    }
                });
                
                // LocalStorageに保存
                saveData('students', students);
                
                // 担当者未登録の受講生を確認
                const unassignedCoordinators = students.filter(s => {
                    return s.coordinatorId && !coordinators.find(c => c.id === s.coordinatorId);
                });
                
                let message = `同期完了: 新規${addedCount}名、更新${updatedCount}名（合計${result.count}名）`;
                if (unassignedCoordinators.length > 0) {
                    const uniqueCoordIds = [...new Set(unassignedCoordinators.map(s => s.coordinatorId))];
                    message += `\n\n⚠️ 注意: 担当者が未登録のID: ${uniqueCoordIds.join(', ')}`;
                    message += `\n担当者管理タブで該当IDの担当者を登録すると、自動的に割り当てられます。`;
                }
                
                showSyncStatus(message.split('\n')[0], 'success');
                showAlert(message, 'success');
                
                // 画面を更新
                if (typeof updateAdminStudentList === 'function') {
                    updateAdminStudentList();
                }
                if (typeof updateSystemOverview === 'function') {
                    updateSystemOverview();
                }
                
            } catch (error) {
                console.error('同期エラー:', error);
                const errorMsg = '同期に失敗しました: ' + error.message;
                showSyncStatus(errorMsg, 'error');
                showAlert(errorMsg, 'error');
            }
        }
        
        // 2. 出席・評価データをスプレッドシートに送信
        async function sendAttendanceToGoogleSheets() {
            const appsScriptUrl = getAppsScriptUrl();
            
            if (!appsScriptUrl) {
                showAlert('Apps Script URLを入力してください', 'error');
                return;
            }
            
            try {
                showSyncStatus('出席・評価データを準備中...', 'info');
                showAlert('データを送信中...', 'info');
                
                // レッスンごとの出席・評価データを作成
                const attendanceData = [];
                
                lessons.forEach(lesson => {
                    // このレッスンの予約を取得
                    const lessonBookings = bookings.filter(b => b.lessonId === lesson.id);
                    
                    lessonBookings.forEach(booking => {
                        const student = students.find(s => s.id === booking.studentId);
                        if (!student) return;
                        
                        // 受講生の評価を取得
                        const rating = ratings.find(r => 
                            r.lessonId === lesson.id && r.studentId === booking.studentId
                        );
                        
                        // 講師からの評価を取得
                        const instructorRating = instructorRatings.find(r => 
                            r.lessonId === lesson.id && r.studentId === booking.studentId
                        );
                        
                        // 出席・欠席の判定
                        let attended = false;
                        let absent = false;
                        
                        if (instructorRating) {
                            if (instructorRating.attitude === '不参加') {
                                absent = true;
                            } else {
                                attended = true;
                            }
                        } else if (rating && rating.rating > 0) {
                            attended = true;
                        }
                        
                        // 評価テキストの作成
                        let evaluationText = '';
                        if (rating && rating.rating > 0) {
                            evaluationText = `受講生評価: ${'★'.repeat(rating.rating)}${'☆'.repeat(5 - rating.rating)} (${rating.rating}/5)`;
                            if (rating.comment) {
                                evaluationText += `\n受講生コメント: ${rating.comment}`;
                            }
                        }
                        if (instructorRating) {
                            if (evaluationText) evaluationText += '\n\n';
                            evaluationText += `講師評価: ${instructorRating.attitude}`;
                            if (instructorRating.level) {
                                evaluationText += ` (日本語レベル: ${instructorRating.level})`;
                            }
                            if (instructorRating.comment) {
                                evaluationText += `\n講師コメント: ${instructorRating.comment}`;
                            }
                        }
                        
                        // 担当者情報を取得
                        const coordinator = student.coordinatorId ? 
                            coordinators.find(c => c.id === student.coordinatorId) : null;
                        const coordinatorName = coordinator ? coordinator.name : '';
                        
                        attendanceData.push({
                            lessonDate: lesson.date,
                            studentId: student.id,
                            studentName: student.name,
                            coordinator: coordinatorName,
                            attended: attended,
                            absent: absent,
                            evaluation: evaluationText
                        });
                    });
                });
                
                if (attendanceData.length === 0) {
                    showAlert('送信するデータがありません', 'info');
                    showSyncStatus('送信するデータがありません', 'info');
                    return;
                }
                
                // スプレッドシートに送信
                const response = await fetch(appsScriptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify({
                        action: 'writeAttendance',
                        data: attendanceData
                    })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || '不明なエラー');
                }
                
                let message = `${result.count}件の出席・評価データを送信しました`;
                if (result.skipped > 0) {
                    message += `（${result.skipped}件は既存データのためスキップ）`;
                }
                showSyncStatus(message, 'success');
                showAlert(message, 'success');
                
            } catch (error) {
                console.error('送信エラー:', error);
                const errorMsg = '送信に失敗しました: ' + error.message;
                showSyncStatus(errorMsg, 'error');
                showAlert(errorMsg, 'error');
            }
        }
        
        // 3. ステータス変更者（求人中でなくなった人）を削除
        async function removeInactiveStudents() {
            const appsScriptUrl = getAppsScriptUrl();
            
            if (!appsScriptUrl) {
                showAlert('Apps Script URLを入力してください', 'error');
                return;
            }
            
            try {
                showSyncStatus('スプレッドシートから現在の受講生データを取得中...', 'info');
                
                // スプレッドシートから「求職中」の受講生を取得
                const response = await fetch(`${appsScriptUrl}?action=getStudents`);
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || '不明なエラー');
                }
                
                const activeStudentIds = result.students.map(s => s.id);
                
                // システム内の受講生で、スプレッドシートに「求職中」として存在しない人を抽出
                const inactiveStudents = students.filter(student => !activeStudentIds.includes(student.id));
                
                if (inactiveStudents.length === 0) {
                    showSyncStatus('削除対象の受講生はいません', 'success');
                    showAlert('削除対象の受講生はいません（全員のステータスが「求職中」です）', 'info');
                    return;
                }
                
                // 削除確認ポップアップを表示
                const confirmMessage = `
以下の${inactiveStudents.length}名はスプレッドシートで「求職中」ではなくなったため、削除対象です。
削除しますか？

【削除対象者】
${inactiveStudents.map(s => `・${s.id}: ${s.name}`).join('\n')}

※ 関連する予約・評価データもすべて削除されます。
※ この操作は取り消せません。
                `.trim();
                
                if (!confirm(confirmMessage)) {
                    showSyncStatus('削除をキャンセルしました', 'info');
                    return;
                }
                
                // 削除処理
                let deletedCount = 0;
                const inactiveStudentIds = inactiveStudents.map(s => s.id);
                
                inactiveStudentIds.forEach(studentId => {
                    // 受講生を削除
                    const studentIndex = students.findIndex(s => s.id === studentId);
                    if (studentIndex !== -1) {
                        students.splice(studentIndex, 1);
                        deletedCount++;
                    }
                    
                    // 関連データを削除
                    bookings = bookings.filter(b => b.studentId !== studentId);
                    ratings = ratings.filter(r => r.studentId !== studentId);
                    instructorRatings = instructorRatings.filter(r => r.studentId !== studentId);
                    
                    // 同席依頼も削除
                    if (typeof attendanceRequests !== 'undefined') {
                        attendanceRequests = attendanceRequests.filter(r => r.studentId !== studentId);
                        localStorage.setItem('attendanceRequests', JSON.stringify(attendanceRequests));
                    }
                });
                
                // LocalStorageを更新
                saveData('students', students);
                saveData('bookings', bookings);
                saveData('ratings', ratings);
                saveData('instructorRatings', instructorRatings);
                
                const message = `${deletedCount}名の受講生と関連データを削除しました`;
                showSyncStatus(message, 'success');
                showAlert(message, 'success');
                
                // 画面を更新
                if (typeof updateAdminStudentList === 'function') {
                    updateAdminStudentList();
                }
                if (typeof updateSystemOverview === 'function') {
                    updateSystemOverview();
                }
                
            } catch (error) {
                console.error('削除エラー:', error);
                const errorMsg = '削除に失敗しました: ' + error.message;
                showSyncStatus(errorMsg, 'error');
                showAlert(errorMsg, 'error');
            }
        }
    </script>

    <!-- レッスン編集モーダル -->
    <div id="lesson-edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>レッスン編集 (Edit Lesson)</h3>
                <span class="close" onclick="closeLessonEditModal()">&times;</span>
            </div>
            <div id="lesson-edit-modal-body">
                <div class="form-group">
                    <label>レッスン内容 (Lesson Content)</label>
                    <input type="text" id="edit-lesson-content" placeholder="レッスン内容を入力">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>日付 (Date)</label>
                        <input type="date" id="edit-lesson-date">
                    </div>
                    <div class="form-group">
                        <label>時間 (Time)</label>
                        <select id="edit-lesson-time">
                            <option value="10:00">10:00</option>
                            <option value="10:30">10:30</option>
                            <option value="11:00">11:00</option>
                            <option value="11:30">11:30</option>
                            <option value="12:00">12:00</option>
                            <option value="12:30">12:30</option>
                            <option value="13:00">13:00</option>
                            <option value="13:30">13:30</option>
                            <option value="14:00">14:00</option>
                            <option value="14:30">14:30</option>
                            <option value="15:00">15:00</option>
                            <option value="15:30">15:30</option>
                            <option value="16:00">16:00</option>
                            <option value="16:30">16:30</option>
                            <option value="17:00">17:00</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>所要時間 (Duration)</label>
                        <input type="number" id="edit-lesson-duration" min="15" max="180" value="45">
                        <span>分</span>
                    </div>
                    <div class="form-group">
                        <label>定員 (Capacity)</label>
                        <input type="number" id="edit-lesson-capacity" min="1" max="999" value="999">
                        <small>999 = 制限なし</small>
                    </div>
                </div>
                <div class="form-group">
                    <label>対象レベル (Target Level)</label>
                    <select id="edit-lesson-level">
                        <option value="ALL">全レベル (All Levels)</option>
                        <option value="N1">N1</option>
                        <option value="N2">N2</option>
                        <option value="N3">N3</option>
                        <option value="N4">N4</option>
                        <option value="N5">N5</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>オンラインリンク (Online Link)</label>
                    <input type="url" id="edit-lesson-online-link" placeholder="https://example.com">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeLessonEditModal()">キャンセル</button>
                <button class="btn btn-primary" onclick="saveLessonEdit()">保存</button>
            </div>
        </div>
    </div>
</body>
</html>
