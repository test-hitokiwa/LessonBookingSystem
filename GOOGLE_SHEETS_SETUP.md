# Google Sheets連携セットアップガイド

このガイドでは、hitokiwaレッスン予約システムとGoogle Sheetsを連携させる方法を説明します。

## 📋 概要

### できること

1. **受講生データの自動取得**
   - スプレッドシート「生徒情報」シートから、T列が「求職中」の受講生のみを抽出
   - システムに自動的に登録・更新
   - **完全上書き更新**: 同じIDの受講生はスプレッドシートの情報で完全更新
   - **担当者未登録時の保護**: 担当者IDを記録し、後から担当者登録時に自動割り当て

2. **出席・評価データの自動送信**
   - レッスンの出席状況（出席/欠席）
   - 受講生からの評価（1-5星評価 + コメント）
   - 講師からの評価（態度評価 + コメント）
   - スプレッドシート「レッスン出席表」シートに書き込み
   - **既存データ保護**: 既にデータがある行は上書きせず、3行目以降の空行に書き込み

3. **ステータス変更者の削除**
   - スプレッドシートで「求職中」でなくなった受講生を検出
   - 削除対象者を確認ポップアップで表示
   - 確認後、システムから削除（関連データも一括削除）

---

## 🔧 セットアップ手順

### ステップ1: スプレッドシートの準備

#### 1-1. 「生徒情報」シートの確認

以下の列が正しく設定されているか確認してください：

| 列 | 項目 | 説明 |
|----|------|------|
| B列 | 担当者ID | 例：「クオン　CC」→ 「CC」がIDとして抽出されます |
| D列 | 受講生ID | 必須。例：STU001 |
| F列 | 名前 | 必須。例：YAMADA HANAKO |
| T列 | ステータス | 「求職中」の行のみが抽出されます |

#### 1-2. 「レッスン出席表」シートの準備

以下の列が必要です（ない場合は追加してください）：

| 列 | 項目 | 種類 | 説明 |
|----|------|------|------|
| B列 | レッスン日 | 日付 | YYYY-MM-DD形式 |
| C列 | 受講生ID | テキスト | 例：STU001 |
| D列 | 名前 | テキスト | 例：YAMADA HANAKO |
| F列 | 担当者 | テキスト | 担当者名 |
| G列 | 出席 | チェックボックス | ☑ 出席の場合にチェック |
| H列 | 欠席 | チェックボックス | ☑ 欠席の場合にチェック |
| I列 | 評価 | テキスト（複数行） | 受講生評価 + 講師評価 + コメント |

**G列・H列のチェックボックス設定方法：**
1. G列・H列を選択
2. 「挿入」→「チェックボックス」
3. 列全体に適用

---

### ステップ2: Google Apps Scriptの設定

#### 2-1. Apps Scriptエディタを開く

1. スプレッドシートを開く
2. 上部メニュー「拡張機能」→「Apps Script」をクリック

#### 2-2. コードをコピー&ペースト

1. 既存のコード（`function myFunction() {}`）を削除
2. `google-apps-script.js`ファイルの内容をすべてコピー
3. Apps Scriptエディタに貼り付け
4. 左上の「💾」アイコンまたは `Ctrl+S` で保存

#### 2-3. スプレッドシートIDの確認

スプレッドシートのURLから、IDを確認します：

```
https://docs.google.com/spreadsheets/d/1ILRD7PZru2HWN6GdCnVT9ur5VWvxteCAPcY9wJSFuKg/edit
                                      ↑ここがスプレッドシートID
```

コード内の以下の部分が正しいIDになっているか確認：

```javascript
SpreadsheetApp.openById('1ILRD7PZru2HWN6GdCnVT9ur5VWvxteCAPcY9wJSFuKg')
```

#### 2-4. テスト実行（オプション）

デプロイ前に動作確認ができます：

1. Apps Scriptエディタで「関数」ドロップダウンから `testGetStudents` を選択
2. 「▶ 実行」ボタンをクリック
3. 初回実行時は権限の承認が必要（「権限を確認」→「許可」）
4. 「実行ログ」を確認して、受講生データが取得できているか確認

---

### ステップ3: ウェブアプリとしてデプロイ

#### 3-1. デプロイの開始

1. Apps Scriptエディタの右上「デプロイ」ボタンをクリック
2. 「新しいデプロイ」を選択

#### 3-2. デプロイ設定

**種類の選択：**
- 歯車アイコン「⚙」→「ウェブアプリ」を選択

**設定項目：**
- **説明**: 任意（例：「hitokiwaシステム連携」）
- **次のユーザーとして実行**: 「自分」を選択
- **アクセスできるユーザー**: 「全員」を選択
  - ⚠️ 重要：「全員」を選択しないと、システムからアクセスできません

#### 3-3. デプロイの実行

1. 「デプロイ」ボタンをクリック
2. 初回は権限の承認が必要
   - 「アクセスを承認」をクリック
   - Googleアカウントを選択
   - 「詳細」→「〜（安全ではないページ）に移動」をクリック
   - 「許可」をクリック

#### 3-4. URLの取得

デプロイが完了すると、「ウェブアプリ」のURLが表示されます：

```
https://script.google.com/macros/s/AKfycby...（長いID）.../exec
```

このURLをコピーしてください。

---

### ステップ4: システムへの設定

#### 4-1. 管理者画面を開く

1. hitokiwaレッスン予約システムにアクセス
2. 管理者としてログイン（ID: `admin`, パスワード: `admin123`）
3. 「受講生管理」タブを開く

#### 4-2. Apps Script URLの登録

1. 「Google Sheets連携」セクションを探す
2. 「Apps Script URL」入力欄に、コピーしたURLを貼り付け
3. Enter キーを押す（自動的にLocalStorageに保存されます）

---

## 🚀 使い方

### 受講生データの同期

1. 管理者画面の「受講生管理」タブを開く
2. 「🔄 受講生を同期（ステータス: 求職中）」ボタンをクリック
3. スプレッドシートから「求職中」の受講生が自動的に取得されます
4. 同期結果が表示されます（新規追加数、更新数）

**同期のタイミング：**
- 新しい受講生が「求職中」になったとき
- 受講生情報（名前、担当者）が変更されたとき
- システムを初期化したいとき

**重複時の動作：**
- 同じIDの受講生が既に存在する場合、スプレッドシートの情報で**完全に上書き**されます
- 名前、レベル、担当者IDがすべてスプレッドシートの値に更新されます

**担当者未登録時の動作：**
- スプレッドシートから取得した担当者IDは、担当者が未登録でも受講生データに記録されます
- 同期完了時に「担当者が未登録のID」が表示されます
- 後から管理者画面の「担当者管理」タブで該当IDの担当者を登録すると、自動的に割り当てられます
- 受講生一覧では「CC (未登録)」のように表示されます

### 出席・評価データの送信

1. レッスンが終了し、講師が評価を入力
2. 管理者画面の「受講生管理」タブを開く
3. 「📤 出席・評価データを送信」ボタンをクリック
4. すべてのレッスンの出席・評価データがスプレッドシートに書き込まれます

**送信されるデータ：**
- レッスン日
- 受講生ID・名前
- 担当者名
- 出席/欠席（チェックボックス）
- 評価（受講生評価 + 講師評価 + コメント）

**重要:**
- 既にデータがある行（レッスン日 + 受講生IDが一致）は上書きされません
- 3行目以降の空行に新しいデータが書き込まれます
- 既存データが保護されるため、安心して送信できます

### ステータス変更者の削除

1. 管理者画面の「受講生管理」タブを開く
2. 「🗑️ ステータス変更者を削除」ボタンをクリック
3. スプレッドシートから現在の「求職中」受講生を取得
4. システムに登録されているが「求職中」でない受講生を検出
5. 削除対象者が確認ポップアップで表示されます
6. 「OK」をクリックすると削除実行、「キャンセル」で中止

**削除される対象：**
- スプレッドシートのT列（ステータス）が「求職中」ではない受講生
- またはスプレッドシートから削除された受講生

**削除されるデータ：**
- 受講生情報
- 予約データ
- 評価データ（受講生から講師、講師から受講生）
- 同席依頼データ

### 担当者の後から登録（自動割り当て）

スプレッドシートから受講生を同期したときに担当者IDが未登録の場合でも、後から担当者を登録できます：

1. 管理者画面の「**担当者管理**」タブを開く
2. 未登録だった担当者ID（例：「CC」）で新しい担当者を追加
3. 担当者名（例：「クオン」）とパスワードを入力して「追加」
4. **自動的に**そのIDを持つすべての受講生に割り当てられます
5. 確認メッセージで割り当てられた受講生の一覧が表示されます

**例：**
```
担当者「クオン (CC)」を追加しました

既に担当者ID「CC」を持つ受講生3名に自動的に割り当てられました：
・YAMADA HANAKO (STU001)
・CHEN WEI (STU002)
・PARK JIHOON (STU003)
```

---

## 📊 データの流れ

### スプレッドシート → システム（受講生同期）

```
生徒情報シート
↓ T列が「求職中」の行を抽出
↓ B列から担当者ID、D列から受講生ID、F列から名前を取得
↓
システムのLocalStorageに保存
↓
受講生一覧に表示
```

### システム → スプレッドシート（出席・評価送信）

```
システム内のレッスン・予約・評価データ
↓ レッスンごとに出席・評価情報を集計
↓ 担当者情報を付加
↓
レッスン出席表シートに書き込み
↓ レッスン日 + 受講生IDで既存データをチェック
↓ 既存データあり → スキップ（上書きしない）
↓ 既存データなし → 3行目以降の空行に書き込み
```

### システム内削除（ステータス変更者）

```
スプレッドシート「生徒情報」シートから「求職中」リストを取得
↓
システム内の受講生と比較
↓
「求職中」リストにない受講生を検出
↓ 削除対象者をポップアップで表示
↓ ユーザーが「OK」をクリック
↓
システムから削除（受講生 + 関連データ）
```

---

## 🔒 セキュリティとプライバシー

### データの保護

- **Apps Scriptは読み取り専用に設定可能**
  - スプレッドシートの編集権限を持つのはApps Scriptのみ
  - システムからは直接編集できない

- **アクセス制限**
  - スプレッドシートの共有設定で閲覧権限を制御
  - Apps Script URLを知っている人のみアクセス可能

### 推奨事項

1. **定期的なバックアップ**
   - スプレッドシートのコピーを作成
   - 「ファイル」→「コピーを作成」

2. **アクセスログの確認**
   - Apps Scriptの「実行数」で実行履歴を確認
   - 不審なアクセスがないかチェック

3. **URLの管理**
   - Apps Script URLは機密情報として扱う
   - 必要な人にのみ共有

---

## 🐛 トラブルシューティング

### エラー: 「Apps Script URLを入力してください」

**原因**: URLが設定されていない

**解決策**:
1. 管理者画面の「Apps Script URL」入力欄を確認
2. デプロイ時に取得したURLを入力
3. Enter キーを押して保存

---

### エラー: 「同期に失敗しました: シート「生徒情報」が見つかりません」

**原因**: スプレッドシートのシート名が異なる

**解決策**:
1. スプレッドシートのシート名を確認
2. Apps Scriptのコード内の `STUDENT_SHEET_NAME` を修正
3. 再デプロイ

---

### エラー: 「権限がありません」

**原因**: Apps Scriptの実行権限が不足

**解決策**:
1. Apps Scriptエディタで再度テスト実行
2. 「権限を確認」→「許可」をクリック
3. すべての権限を許可

---

### 受講生が同期されない

**原因1**: T列のステータスが「求職中」ではない

**解決策**: スプレッドシートのT列を確認し、「求職中」に変更

**原因2**: 受講生IDまたは名前が空欄

**解決策**: D列（受講生ID）とF列（名前）を確認し、入力

---

### 出席データが送信されない

**原因**: 「レッスン出席表」シートが存在しない、または列が異なる

**解決策**:
1. シート名を「レッスン出席表」に変更
2. 必要な列（B, C, D, F, G, H, I）を確認
3. G列・H列にチェックボックスを設定

---

## 📞 サポート

問題が解決しない場合は、以下の情報を添えてお問い合わせください：

- エラーメッセージの全文
- スプレッドシートのURL
- 実行したステップ
- スクリーンショット（可能であれば）

---

## 🔄 更新履歴

### v1.0 (2025-01-30)
- 初回リリース
- 受講生データの同期機能
- 出席・評価データの送信機能

---

**📚 関連ドキュメント:**
- [README.md](README.md) - プロジェクト概要
- [QUICKSTART.md](QUICKSTART.md) - クイックスタートガイド
- [google-apps-script.js](google-apps-script.js) - Apps Scriptのコード
